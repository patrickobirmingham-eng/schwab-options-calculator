<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Schwab Options Profit/Loss Calculator</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
:root[data-theme="dark"] {
    --bg-primary: #0f172a;
    --bg-secondary: #1e293b;
    --bg-tertiary: #334155;
    --bg-input: #0f172a;
    --border-color: #334155;
    --border-accent: #6d28d9;
    --text-primary: #f8fafc;
    --text-secondary: #94a3b8;
    --text-muted: #cbd5e1;
    --tag-bg: #475569;
    --shadow: rgba(0,0,0,0.6);
    --toggle-bg: #334155;
    --toggle-icon: '‚òÄÔ∏è';
    --toggle-label: 'Light Mode';
}

:root[data-theme="light"] {
    --bg-primary: #f8fafc;
    --bg-secondary: #ffffff;
    --bg-tertiary: #e2e8f0;
    --bg-input: #f1f5f9;
    --border-color: #cbd5e1;
    --border-accent: #7c3aed;
    --text-primary: #0f172a;
    --text-secondary: #475569;
    --text-muted: #334155;
    --tag-bg: #94a3b8;
    --shadow: rgba(0,0,0,0.15);
    --toggle-bg: #e2e8f0;
    --toggle-icon: 'üåô';
    --toggle-label: 'Dark Mode';
}

* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--bg-primary); color: var(--text-primary); padding: 20px; transition: background 0.3s ease, color 0.3s ease; }
.container { max-width: 1600px; margin: 0 auto; }
h1 { text-align: center; color: #a78bfa; margin-bottom: 10px; }
.subtitle { text-align: center; color: var(--text-secondary); margin-bottom: 25px; font-size: 0.9rem; }
.upload-box { background: rgba(109,40,217,0.08); border: 2px dashed #6d28d9; border-radius: 12px; padding: 40px; text-align: center; cursor: pointer; margin-bottom: 20px; transition: background 0.3s; }
[data-theme="light"] .upload-box { background: rgba(109,40,217,0.05); }
.filter-bar { display: flex; flex-wrap: wrap; gap: 20px; background: var(--bg-secondary); padding: 25px; border-radius: 12px; margin-bottom: 25px; border: 1px solid var(--border-accent); align-items: flex-end; transition: background 0.3s, border-color 0.3s; }
.filter-group { display: flex; flex-direction: column; gap: 8px; flex: 1; min-width: 200px; }
.filter-group label { color: var(--text-primary); font-size: 0.85rem; font-weight: 600; }
.checkbox-grid { display: grid; grid-template-columns: minmax(0, 1fr) minmax(0, 1fr); gap: 8px; background: var(--bg-input); padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); align-items: start; transition: background 0.3s; }
.checkbox-item { display: flex; align-items: center; gap: 8px; font-size: 0.75rem; color: var(--text-muted); }
.checkbox-item input[type="checkbox"] { flex-shrink: 0; width: 16px; height: 16px; accent-color: #7c3aed; }

/* Theme Toggle Button */
#themeToggle {
    position: fixed;
    top: 16px;
    right: 16px;
    z-index: 9999;
    display: flex;
    align-items: center;
    gap: 8px;
    background: var(--bg-secondary);
    color: var(--text-primary);
    border: 2px solid var(--border-accent);
    border-radius: 50px;
    padding: 8px 16px 8px 12px;
    cursor: pointer;
    font-size: 0.8rem;
    font-weight: 600;
    letter-spacing: 0.03em;
    box-shadow: 0 4px 16px var(--shadow);
    transition: all 0.25s ease;
    white-space: nowrap;
}
#themeToggle:hover {
    background: var(--border-accent);
    color: #fff;
    transform: translateY(-1px);
    box-shadow: 0 6px 20px rgba(109,40,217,0.4);
}
#themeToggle .toggle-track {
    width: 36px;
    height: 20px;
    background: var(--toggle-bg);
    border-radius: 10px;
    position: relative;
    transition: background 0.25s;
    flex-shrink: 0;
    border: 1px solid var(--border-color);
}
#themeToggle .toggle-thumb {
    position: absolute;
    top: 2px;
    left: 2px;
    width: 14px;
    height: 14px;
    background: #7c3aed;
    border-radius: 50%;
    transition: transform 0.25s ease, background 0.25s;
}
[data-theme="light"] #themeToggle .toggle-thumb {
    transform: translateX(16px);
    background: #f59e0b;
}
#themeToggle .toggle-emoji {
    font-size: 0.95rem;
    line-height: 1;
}

@media (max-width: 768px) {
    #themeToggle { padding: 8px 12px 8px 10px; font-size: 0.75rem; top: 10px; right: 10px; }
    #themeToggle .toggle-label { display: none; }
    body { padding: 10px; }
    h1 { font-size: 1.5rem; }
    .subtitle { font-size: 0.8rem; }
    .upload-box { padding: 20px; }
    .upload-box p { font-size: 1rem !important; }
    .filter-bar { flex-direction: column; padding: 15px; gap: 15px; }
    .filter-group { min-width: 100%; }
    .checkbox-grid { grid-template-columns: 1fr; }
    .stats { grid-template-columns: repeat(2, 1fr); gap: 10px; }
    .stat-card { padding: 15px; }
    .stat-label { font-size: 0.65rem; }
    .stat-value { font-size: 1.2rem; }
    .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    table { min-width: 800px; font-size: 0.8rem; }
    th, td { padding: 10px 8px; font-size: 0.75rem; }
    .tag { font-size: 0.65rem; padding: 2px 6px; }
}

@media (max-width: 480px) {
    h1 { font-size: 1.2rem; }
    .stats { grid-template-columns: 1fr; }
    table { min-width: 600px; }
}

.filter-bar input, .filter-bar select {
    background: var(--bg-input);
    border: 2px solid var(--border-color);
    color: var(--text-primary);
    padding: 12px;
    border-radius: 8px;
    outline: none;
    width: 100%;
    font-size: 1rem;
    transition: background 0.3s, border-color 0.3s, color 0.3s;
}
.filter-bar input::placeholder { color: var(--text-secondary); }
.filter-bar select option { background: var(--bg-secondary); color: var(--text-primary); }
input[type="date"]::-webkit-calendar-picker-indicator { filter: var(--calendar-filter, invert(1)); cursor: pointer; }
[data-theme="light"] input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(0); }

.stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px; }
.stat-card { background: var(--bg-secondary); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color); text-align: center; transition: background 0.3s, border-color 0.3s; }
.stat-label { font-size: 0.7rem; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 10px; }
.stat-value { font-size: 1.4rem; font-weight: bold; }

table { width: 100%; border-collapse: collapse; background: var(--bg-secondary); border-radius: 12px; table-layout: auto; transition: background 0.3s; }
thead tr { position: sticky; top: 0; z-index: 20; }
th { background: var(--bg-tertiary); color: var(--text-muted); padding: 15px; text-align: center; cursor: pointer; font-size: 0.8rem; border-bottom: 2px solid #6d28d9; box-shadow: 0 3px 6px var(--shadow); position: relative; transition: background 0.3s; }
th .resizer { position: absolute; top: 0; right: 0; width: 5px; cursor: col-resize; user-select: none; height: 100%; background: transparent; }
th .resizer:hover { background: #6d28d9; }
td { padding: 15px; border-bottom: 1px solid var(--border-color); font-size: 0.9rem; text-align: center; color: var(--text-primary); transition: border-color 0.3s, color 0.3s; }
.pos { color: #16a34a; } 
[data-theme="dark"] .pos { color: #4ade80; }
.neg { color: #dc2626; }
[data-theme="dark"] .neg { color: #f87171; }
.waiting { color: #d97706; }
[data-theme="dark"] .waiting { color: #fbbf24; }
.tag { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; background: var(--tag-bg); color: var(--text-primary); }
.tag-waiting { background: #f59e0b; color: #000; }

/* Upload box text */
.upload-box p { color: var(--text-primary); }
.upload-box p:not(:first-child) { color: var(--text-secondary); }

/* Date range text */
#dateRange { color: var(--text-secondary); }

/* Modal */
#monthlyModal > div { background: var(--bg-secondary); border: 1px solid var(--border-accent); }
</style>
</head>

<body>
<!-- Dark/Light Mode Toggle -->
<button id="themeToggle" onclick="toggleTheme()" title="Toggle Dark/Light Mode">
    <span class="toggle-emoji" id="toggleEmoji">‚òÄÔ∏è</span>
    <div class="toggle-track">
        <div class="toggle-thumb"></div>
    </div>
    <span class="toggle-label" id="toggleLabel">Light Mode</span>
</button>

<div class="container">
    <h1>Schwab Options Profit/Loss Calculator</h1>
    <p class="subtitle">FIFO Transactional Analysis & Date-Matched P/L</p>

    <div class="upload-box" id="dropZone">
        <p style="font-size: 1.2rem;">Click to Upload Schwab CSV/Excel Transactions</p>
        <p style="font-size: 0.9rem; margin-top: 15px;">Column titles are: Date | Action | Symbol | Description | Quantity | Price | Fees & Comm | Amount</p>
        <p style="font-size: 0.9rem; margin-top: 10px;">Supports .xlsx, .xls, .csv, and other spreadsheet files</p>
        <p id="uploadedFileName" style="font-size: 0.9rem; color: #a78bfa; margin-top: 10px; display:none;"></p>
        <input type="file" id="filePicker" accept=".csv,.xlsx" style="display:none">
    </div>

    <div class="filter-bar" id="filterBar" style="display:none;">
        <div class="filter-group">
            <label>1. Search Symbol</label>
            <input type="text" id="searchInput" placeholder="Search Ticker..." oninput="applyFilters()">
        </div>

        <div class="filter-group" style="min-width: 350px;">
            <label>2. Status Filter</label>
            <div class="checkbox-grid" id="statusCheckboxes">
                <label class="checkbox-item"><input type="checkbox" value="Buy to Close" checked onchange="applyFilters()"> Buy to Close</label>
                <label class="checkbox-item"><input type="checkbox" value="Assigned" onchange="applyFilters()"> Assigned</label>
                <label class="checkbox-item"><input type="checkbox" value="Sell to Close" checked onchange="applyFilters()"> Sell to Close</label>
                <label class="checkbox-item"><input type="checkbox" value="Expired" checked onchange="applyFilters()"> Expired</label>
                <label class="checkbox-item"><input type="checkbox" value="Sell to Open" checked onchange="applyFilters()"> Sell to Open</label>
                <label class="checkbox-item"><input type="checkbox" value="Buy to Open" checked onchange="applyFilters()"> Buy to Open</label>
            </div>
        </div>

        <div class="filter-group">
            <label>3. Quick Range</label>
            <select id="quickRange" onchange="setQuickRange()">
                <option value="all" selected>Show All</option>
                <option value="today">Today</option>
                <option value="7days">Last 7 Days</option>
                <option value="currentMonth">Current Month</option>
                <option value="lastMonth">Last Month</option>
                <option value="currentYear">Current Year</option>
                <option value="lastYear">Last Year</option>
                <option value="last3Months">Last 3 Months</option>
                <option value="last6Months">Last 6 Months</option>
                <option value="last12Months">Last 12 Months</option>
            </select>
        </div>

        <div class="filter-group">
            <label>4. From Date</label>
            <input type="date" id="startDate" onchange="applyFilters()">
        </div>

        <div class="filter-group">
            <label>5. To Date</label>
            <input type="date" id="endDate" onchange="applyFilters()">
        </div>

    </div>
    <div id="actionButtons" style="display:none; justify-content:center; gap:16px; margin-bottom:25px; flex-wrap:wrap;">
        <button onclick="resetFilters()" style="background:#ef4444;color:white;border:none;padding:12px 28px;border-radius:8px;cursor:pointer;font-weight:bold;">Reset All Filters</button>
        <button onclick="downloadResults()" style="background:#10b981;color:white;border:none;padding:12px 28px;border-radius:8px;cursor:pointer;font-weight:bold;">Download Results</button>
        <button onclick="showMonthlySummary()" style="background:#6d28d9;color:white;border:none;padding:12px 28px;border-radius:8px;cursor:pointer;font-weight:bold;">üìä Monthly Summary</button>
    </div>

    <!-- Monthly Summary Modal -->
    <div id="monthlyModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.75); z-index:1000; justify-content:center; align-items:center;">
        <div style="border-radius:16px; padding:30px; max-width:95vw; width:1000px; max-height:85vh; overflow-y:auto; position:relative;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="color: var(--text-primary); font-size:1.2rem;">Monthly Cash Flow & Profit Summary</h2>
                <button onclick="closeMonthlySummary()" style="background:#ef4444;color:white;border:none;padding:8px 14px;border-radius:8px;cursor:pointer;font-weight:bold;font-size:1rem;">‚úï Close</button>
            </div>
            <div id="monthlyTableContainer"></div>
        </div>
    </div>

    <div id="summary" class="stats" style="display:none;"></div>
    <div id="dateRange" style="display:none; text-align: center; font-size: 1.1rem; margin-bottom: 20px;"></div>

    <div class="table-container" id="tableContainer" style="display:none;">
        <table>
            <thead><tr id="headerRow"></tr></thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<script>
let finalTrades = [];
let openPositions = [];
let currentFilteredData = [];
let sortKey = 'closeDate';
let sortDir = -1;
let columnWidths = {};
let uploadedDateRange = { min: null, max: null };

// Theme toggle
function toggleTheme() {
    const html = document.documentElement;
    const isDark = html.getAttribute('data-theme') === 'dark';
    html.setAttribute('data-theme', isDark ? 'light' : 'dark');
    document.getElementById('toggleEmoji').textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
    document.getElementById('toggleLabel').textContent = isDark ? 'Dark Mode' : 'Light Mode';
    localStorage.setItem('theme', isDark ? 'light' : 'dark');
}

// Restore saved theme on load
(function() {
    const saved = localStorage.getItem('theme') || 'dark';
    document.documentElement.setAttribute('data-theme', saved);
    if (saved === 'light') {
        document.getElementById('toggleEmoji').textContent = 'üåô';
        document.getElementById('toggleLabel').textContent = 'Dark Mode';
    }
})();

const dropZone = document.getElementById('dropZone');
const filePicker = document.getElementById('filePicker');
dropZone.onclick = () => filePicker.click();
filePicker.onchange = (e) => handleFile(e.target.files[0]);

async function handleFile(file) {
    if (!file) return;
    const fnEl = document.getElementById('uploadedFileName');
    fnEl.textContent = 'Filename: ' + file.name;
    fnEl.style.display = 'block';

    document.getElementById('filterBar').style.display = 'flex';
    document.getElementById('actionButtons').style.display = 'flex';
    document.getElementById('summary').style.display = 'grid';
    document.getElementById('dateRange').style.display = 'block';
    document.getElementById('tableContainer').style.display = 'block';
    const data = await file.arrayBuffer();
    const workbook = XLSX.read(data, { type: 'array' });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(sheet);
    process(json);
}

function parseDateString(dStr) {
    if (!dStr) return null;
    if (!isNaN(dStr) && typeof dStr !== 'string') return new Date((dStr - 25569) * 86400 * 1000);
    const parts = String(dStr).trim().split(/\s+/);
    const actualDateStr = parts[parts.length - 1];
    const d = new Date(actualDateStr);
    return isNaN(d.getTime()) ? null : d;
}

function cleanNum(val) {
    if (val === undefined || val === null || val === "") return 0;
    let str = String(val).replace(/[$\s,]/g, '');
    if (str.startsWith('(') && str.endsWith(')')) str = '-' + str.substring(1, str.length - 1);
    return parseFloat(str) || 0;
}

function process(rows) {
    const inventory = {};
    const realized = [];
    const allTransactions = [];

    const sortedRows = rows
        .map(r => ({ ...r, parsedDate: parseDateString(r.Date) }))
        .filter(r => r.Symbol && r.parsedDate)
        .sort((a, b) => {
            const dateCompare = a.parsedDate - b.parsedDate;
            if (dateCompare !== 0) return dateCompare;
            const aIsOpen = (a.Action || "").toLowerCase().includes('to open');
            const bIsOpen = (b.Action || "").toLowerCase().includes('to open');
            if (aIsOpen && !bIsOpen) return -1;
            if (!aIsOpen && bIsOpen) return 1;
            return 0;
        });

    if (sortedRows.length > 0) {
        uploadedDateRange.min = sortedRows[0].parsedDate;
        uploadedDateRange.max = sortedRows[sortedRows.length - 1].parsedDate;
    }

    sortedRows.forEach(row => {
        const sym = row.Symbol;
        const action = (row.Action || "").toLowerCase();
        const qty = Math.abs(cleanNum(row.Quantity));
        const amt = cleanNum(row.Amount);

        if (!inventory[sym]) inventory[sym] = [];

        if (action.includes('to open')) {
            inventory[sym].push({ date: row.parsedDate, qty, premium: amt, status: action });
            allTransactions.push({ date: row.parsedDate, action, amount: amt });
        }
        else if (action.includes('to close') || action.includes('expired') || action.includes('assigned')) {
            allTransactions.push({ date: row.parsedDate, action, amount: amt });

            let remainingToClose = qty || 0;
            if (remainingToClose === 0 && inventory[sym].length > 0) {
                remainingToClose = inventory[sym].reduce((sum, item) => sum + item.qty, 0);
            }

            let openingPremiumUsed = 0;
            let firstOpenDate = row.parsedDate;

            while (remainingToClose > 0 && inventory[sym].length > 0) {
                let earliest = inventory[sym][0];
                let qtyFromThisOpening = Math.min(remainingToClose, earliest.qty);
                let sliceOpeningPremium = (earliest.premium / earliest.qty) * qtyFromThisOpening;
                openingPremiumUsed += sliceOpeningPremium;
                firstOpenDate = earliest.date;
                earliest.qty -= qtyFromThisOpening;
                remainingToClose -= qtyFromThisOpening;
                if (earliest.qty <= 0) inventory[sym].shift();
            }

            let actualClosingCost = (action.includes('expired') || action.includes('assigned')) ? 0 : amt;

            realized.push({
                symbol: sym,
                contracts: qty || (openingPremiumUsed > 0 ? "All" : 0),
                openingPremium: openingPremiumUsed,
                closingPremium: actualClosingCost,
                profit: openingPremiumUsed + actualClosingCost,
                openDate: firstOpenDate,
                closeDate: row.parsedDate,
                status: action.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' '),
                isOpen: false
            });
        }
    });

    const openPos = [];
    for (const sym in inventory) {
        inventory[sym].forEach(item => {
            if (item.status.includes('sell') && item.status.includes('open')) {
                openPos.push({
                    symbol: sym,
                    contracts: item.qty,
                    openingPremium: item.premium,
                    closingPremium: 0,
                    profit: 0,
                    openDate: item.date,
                    closeDate: item.date,
                    status: 'Sell to Open',
                    isOpen: true
                });
            }
        });
    }

    finalTrades = realized;
    openPositions = openPos;
    window.allTransactions = allTransactions;
    applyFilters();
}

function applyFilters() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const startVal = document.getElementById('startDate').value;
    const endVal = document.getElementById('endDate').value;
    const startDate = startVal ? new Date(startVal + "T00:00:00") : null;
    const endDate = endVal ? new Date(endVal + "T23:59:59") : null;
    const activeStatuses = Array.from(document.querySelectorAll('#statusCheckboxes input:checked')).map(cb => cb.value.toLowerCase());

    const allItems = [...finalTrades, ...openPositions];
    const filtered = allItems.filter(item => {
        const matchesSearch = item.symbol.toLowerCase().includes(searchTerm);
        const matchesStatus = activeStatuses.includes(item.status.toLowerCase());
        const dateToFilter = item.isOpen ? item.openDate : item.closeDate;
        let matchesDate = true;
        if (startDate && dateToFilter < startDate) matchesDate = false;
        if (endDate && dateToFilter > endDate) matchesDate = false;
        return matchesSearch && matchesStatus && matchesDate;
    });

    currentFilteredData = filtered;
    render(null, filtered);
}

function calcDTE(symbol) {
    const match = symbol.match(/(\d{1,2}\/\d{1,2}\/\d{4})/);
    if (!match) return '';
    const exp = new Date(match[1]);
    exp.setHours(0, 0, 0, 0);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const diff = Math.round((exp - today) / (1000 * 60 * 60 * 24));
    return diff > 0 ? diff : '';
}

function sortBy(key) {
    if (sortKey === key) sortDir *= -1;
    else { sortKey = key; sortDir = 1; }
    render(null, null);
}

function render(newSortKey, dataToRender) {
    const displayData = dataToRender ? [...dataToRender] : [...currentFilteredData];

    displayData.sort((a, b) => {
        let v1, v2;

        if (sortKey === 'dte') {
            const getDTE = sym => {
                const m = sym.match(/(\d{1,2}\/\d{1,2}\/\d{4})/);
                if (!m) return null;
                const diff = Math.round((new Date(m[1]) - new Date()) / (1000 * 60 * 60 * 24));
                return diff > 0 ? diff : null;
            };
            const d1 = a.isOpen ? getDTE(a.symbol) : null;
            const d2 = b.isOpen ? getDTE(b.symbol) : null;
            if (d1 === null && d2 === null) return 0;
            if (d1 === null) return 1;
            if (d2 === null) return -1;
            return (d1 - d2) * sortDir;
        }
        else if (sortKey === 'openingPremium') {
            v1 = a.status.toLowerCase().includes('buy') && a.status.toLowerCase().includes('close') ? a.closingPremium : a.openingPremium;
            v2 = b.status.toLowerCase().includes('buy') && b.status.toLowerCase().includes('close') ? b.closingPremium : b.openingPremium;
        }
        else if (sortKey === 'returnPct') {
            v1 = a.status.toLowerCase().includes('expired') ? 100
                : (a.status.toLowerCase().includes('buy') && a.status.toLowerCase().includes('close') && (a.profit + Math.abs(a.closingPremium)) !== 0)
                ? (a.profit / (a.profit + Math.abs(a.closingPremium))) * 100 : -Infinity;
            v2 = b.status.toLowerCase().includes('expired') ? 100
                : (b.status.toLowerCase().includes('buy') && b.status.toLowerCase().includes('close') && (b.profit + Math.abs(b.closingPremium)) !== 0)
                ? (b.profit / (b.profit + Math.abs(b.closingPremium))) * 100 : -Infinity;
        }
        else {
            v1 = a[sortKey];
            v2 = b[sortKey];
        }

        if (v1 instanceof Date) { v1 = v1.getTime(); v2 = v2.getTime(); }
        return v1 < v2 ? -sortDir : v1 > v2 ? sortDir : 0;
    });

    const totalPL = displayData.filter(x => !x.isOpen).reduce((s, x) => s + (x.profit || 0), 0);
    const openPremium = displayData.filter(x => x.isOpen).reduce((s, x) => s + (x.openingPremium || 0), 0);
    const closedTrades = displayData.filter(x => !x.isOpen).length;
    const openTrades = displayData.filter(x => x.isOpen).length;

    const startVal = document.getElementById('startDate').value;
    const endVal = document.getElementById('endDate').value;
    const startDate = startVal ? new Date(startVal + "T00:00:00") : null;
    const endDate = endVal ? new Date(endVal + "T23:59:59") : null;

    let sellToOpen = 0, buyToClose = 0;
    if (window.allTransactions) {
        window.allTransactions.forEach(t => {
            let matchesDate = true;
            if (startDate && t.date < startDate) matchesDate = false;
            if (endDate && t.date > endDate) matchesDate = false;
            if (matchesDate) {
                if (t.action.includes('sell') && t.action.includes('to open')) sellToOpen += t.amount;
                if (t.action.includes('buy') && t.action.includes('to close')) buyToClose += t.amount;
            }
        });
    }
    const cashFlow = sellToOpen - Math.abs(buyToClose);

    document.getElementById('summary').innerHTML = `
        <div class="stat-card"><div class="stat-label">Sell to Open</div><div class="stat-value pos">$${sellToOpen.toLocaleString(undefined,{minimumFractionDigits:2})}</div></div>
        <div class="stat-card"><div class="stat-label">Buy to Close</div><div class="stat-value neg">$${Math.abs(buyToClose).toLocaleString(undefined,{minimumFractionDigits:2})}</div></div>
        <div class="stat-card"><div class="stat-label">Cash Flow</div><div class="stat-value ${cashFlow >= 0 ? 'pos' : 'neg'}">$${cashFlow.toLocaleString(undefined,{minimumFractionDigits:2})}</div></div>
        <div class="stat-card"><div class="stat-label">Realized Profit / Loss</div><div class="stat-value ${totalPL >= 0 ? 'pos' : 'neg'}">$${totalPL.toLocaleString(undefined,{minimumFractionDigits:2})}</div></div>
        <div class="stat-card"><div class="stat-label">Open Premium</div><div class="stat-value waiting">$${openPremium.toLocaleString(undefined,{minimumFractionDigits:2})}</div></div>
        <div class="stat-card"><div class="stat-label">Closed Trades</div><div class="stat-value">${closedTrades}</div></div>
        <div class="stat-card"><div class="stat-label">Open Positions</div><div class="stat-value waiting">${openTrades}</div></div>
    `;

    if (uploadedDateRange.min && uploadedDateRange.max) {
        document.getElementById('dateRange').innerHTML = `Available dates: ${uploadedDateRange.min.toLocaleDateString()} to ${uploadedDateRange.max.toLocaleDateString()}`;
    }

    const cols = [
        {lab:'Date',key:'closeDate'},
        {lab:'Symbol',key:'symbol'},
        {lab:'Quantity',key:'contracts'},
        {lab:'DTE',key:'dte'},
        {lab:'Action',key:'status'},
        {lab:'Premium Received / Paid',key:'openingPremium'},
        {lab:'Profit / Loss',key:'profit'},
        {lab:'% Return',key:'returnPct'}
    ];

    document.getElementById('headerRow').innerHTML = cols.map((c, i) =>
        `<th data-col-index="${i}" onclick="sortBy('${c.key}')" style="${columnWidths[i] ? 'width:' + columnWidths[i] + 'px; min-width:' + columnWidths[i] + 'px;' : ''}">${c.lab} ‚Üï<div class="resizer"></div></th>`
    ).join('');

    document.querySelectorAll('.resizer').forEach((resizer) => {
        let startX, startWidth;
        resizer.addEventListener('mousedown', (e) => {
            e.stopPropagation();
            startX = e.pageX;
            const th = resizer.parentElement;
            startWidth = th.offsetWidth;
            const onMouseMove = (e) => { th.style.width = (startWidth + e.pageX - startX) + 'px'; th.style.minWidth = th.style.width; };
            const onMouseUp = () => {
                columnWidths[th.getAttribute('data-col-index')] = th.offsetWidth;
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            };
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        });
    });

    document.getElementById('tableBody').innerHTML = displayData.map(p => {
        let returnPct = '', returnClass = '';
        if (p.status.toLowerCase().includes('buy') && p.status.toLowerCase().includes('close')) {
            const denom = p.profit + Math.abs(p.closingPremium);
            if (denom !== 0 && isFinite(denom)) {
                const pct = (p.profit / denom) * 100;
                returnPct = pct.toFixed(2) + '%';
                returnClass = pct >= 0 ? 'pos' : 'neg';
            } else { returnPct = 'N/A'; }
        } else if (p.status.toLowerCase().includes('expired')) {
            returnPct = '100.00%'; returnClass = 'pos';
        }

        const premVal = p.status.toLowerCase().includes('buy') && p.status.toLowerCase().includes('close') ? p.closingPremium : p.openingPremium;
        const premClass = premVal >= 0 ? 'pos' : 'neg';

        return `
        <tr>
            <td>${p.isOpen ? p.openDate.toLocaleDateString() : p.closeDate.toLocaleDateString()}</td>
            <td>${p.symbol}</td>
            <td>${p.contracts}</td>
            <td>${p.isOpen ? calcDTE(p.symbol) : ''}</td>
            <td><span class="tag ${p.isOpen ? 'tag-waiting' : ''}">${p.status}</span></td>
            <td class="${premClass}">$${premVal.toLocaleString(undefined,{minimumFractionDigits:2})}</td>
            <td class="${p.isOpen ? 'waiting' : (p.profit >= 0 ? 'pos' : 'neg')}">${p.isOpen ? 'Waiting to close' : '$' + p.profit.toLocaleString(undefined,{minimumFractionDigits:2})}</td>
            <td class="${returnClass}">${returnPct}</td>
        </tr>`;
    }).join('');
}

function toISODate(d) { return d.toISOString().split('T')[0]; }

function setQuickRange() {
    const range = document.getElementById('quickRange').value;
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    let start = new Date(today), end = new Date();
    end.setHours(23, 59, 59, 999);

    switch(range) {
        case 'today': break;
        case '7days': start.setDate(today.getDate() - 6); break;
        case 'lastMonth': start = new Date(today.getFullYear(), today.getMonth() - 1, 1); end = new Date(today.getFullYear(), today.getMonth(), 0); break;
        case 'last3Months': start = new Date(today.getFullYear(), today.getMonth() - 3, 1); end = new Date(today.getFullYear(), today.getMonth(), 0); break;
        case 'last6Months': start = new Date(today.getFullYear(), today.getMonth() - 6, 1); end = new Date(today.getFullYear(), today.getMonth(), 0); break;
        case 'last12Months': start = new Date(today.getFullYear(), today.getMonth() - 12, 1); end = new Date(today.getFullYear(), today.getMonth(), 0); break;
        case 'lastYear': start = new Date(today.getFullYear() - 1, 0, 1); end = new Date(today.getFullYear() - 1, 11, 31); break;
        case 'currentMonth': start = new Date(today.getFullYear(), today.getMonth(), 1); end = new Date(); end.setHours(23,59,59,999); break;
        case 'currentYear': start = new Date(today.getFullYear(), 0, 1); end = new Date(); end.setHours(23,59,59,999); break;
        case 'all': default: start = null; end = null; break;
    }

    document.getElementById('startDate').value = start ? toISODate(start) : '';
    document.getElementById('endDate').value = end ? toISODate(end) : '';
    applyFilters();
}

function resetFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('quickRange').value = 'all';
    document.getElementById('startDate').value = '';
    document.getElementById('endDate').value = '';
    document.querySelectorAll('#statusCheckboxes input').forEach(cb => { cb.checked = (cb.value !== 'Assigned'); });
    applyFilters();
}

function downloadResults() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const startVal = document.getElementById('startDate').value;
    const endVal = document.getElementById('endDate').value;
    const startDate = startVal ? new Date(startVal + "T00:00:00") : null;
    const endDate = endVal ? new Date(endVal + "T23:59:59") : null;
    const activeStatuses = Array.from(document.querySelectorAll('#statusCheckboxes input:checked')).map(cb => cb.value.toLowerCase());

    const filtered = [...finalTrades, ...openPositions].filter(item => {
        const matchesSearch = item.symbol.toLowerCase().includes(searchTerm);
        const matchesStatus = activeStatuses.includes(item.status.toLowerCase());
        const dateToFilter = item.isOpen ? item.openDate : item.closeDate;
        let matchesDate = true;
        if (startDate && dateToFilter < startDate) matchesDate = false;
        if (endDate && dateToFilter > endDate) matchesDate = false;
        return matchesSearch && matchesStatus && matchesDate;
    });

    let csv = 'Date,Symbol,Quantity,DTE,Action,Premium Received / Paid,Profit / Loss,% Return\n';
    filtered.forEach(p => {
        const date = p.isOpen ? p.openDate.toLocaleDateString() : p.closeDate.toLocaleDateString();
        const premium = p.status.toLowerCase().includes('buy') && p.status.toLowerCase().includes('close') ? p.closingPremium : p.openingPremium;
        const pl = p.isOpen ? 'Waiting to close' : p.profit.toFixed(2);
        const dte = p.isOpen ? calcDTE(p.symbol) : '';
        let returnPct = '';
        if (p.status.toLowerCase().includes('buy') && p.status.toLowerCase().includes('close')) {
            const denom = p.profit + Math.abs(p.closingPremium);
            if (denom !== 0) returnPct = ((p.profit / denom) * 100).toFixed(2) + '%';
        } else if (p.status.toLowerCase().includes('expired')) { returnPct = '100.00%'; }
        csv += `${date},${p.symbol},${p.contracts},${dte},${p.status},${premium.toFixed(2)},${pl},${returnPct}\n`;
    });

    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `options-results-${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

function closeMonthlySummary() {
    document.getElementById('monthlyModal').style.display = 'none';
}

function showMonthlySummary() {
    if (!window.allTransactions || window.allTransactions.length === 0) {
        alert('Please upload a file first.');
        return;
    }

    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    const modalBg = isDark ? '#1e293b' : '#ffffff';
    const modalBorder = '#6d28d9';
    const textColor = isDark ? '#f8fafc' : '#0f172a';
    const thBg = isDark ? '#0f172a' : '#f1f5f9';
    const rowBg = isDark ? '#1e293b' : '#ffffff';
    const totalRowBg = isDark ? '#334155' : '#e2e8f0';
    const borderColor = isDark ? '#334155' : '#cbd5e1';

    // Update modal div style dynamically
    const modalInner = document.querySelector('#monthlyModal > div');
    modalInner.style.background = modalBg;
    modalInner.style.border = `1px solid ${modalBorder}`;

    const startYear = 2025;
    const now = new Date();
    const months = [];
    for (let y = startYear; y <= now.getFullYear(); y++) {
        const mEnd = (y === now.getFullYear()) ? now.getMonth() : 11;
        for (let m = 0; m <= mEnd; m++) {
            months.push({ year: y, month: m });
        }
    }

    const fmt = (n) => (n >= 0 ? '$' : '-$') + Math.abs(n).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
    const fmtNeg = (n) => n === 0 ? '$0.00' : (n > 0 ? '$' : '-$') + Math.abs(n).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});

    let totSellOpen = 0, totBuyClose = 0, totProfit = 0, totAssigned = 0;

    const rows = months.map(({year, month}) => {
        const mStart = new Date(year, month, 1);
        const mEnd = new Date(year, month + 1, 0, 23, 59, 59);
        const monthLabel = mStart.toLocaleDateString('en-US', {month:'short', year:'numeric'});

        let sellOpen = 0, buyClose = 0;
        window.allTransactions.forEach(t => {
            if (t.date >= mStart && t.date <= mEnd) {
                if (t.action.includes('sell') && t.action.includes('to open')) sellOpen += t.amount;
                if (t.action.includes('buy') && t.action.includes('to close')) buyClose += t.amount;
            }
        });

        let profit = 0, assignedPaid = 0;
        finalTrades.forEach(t => {
            if (t.closeDate >= mStart && t.closeDate <= mEnd) {
                const st = t.status.toLowerCase();
                if (st.includes('buy') && st.includes('close')) profit += t.profit;
                if (st.includes('expired')) profit += t.profit;
                if (st.includes('assigned')) assignedPaid += Math.abs(t.openingPremium);
            }
        });

        const cashFlow = sellOpen + buyClose;
        totSellOpen += sellOpen;
        totBuyClose += buyClose;
        totProfit += profit;
        totAssigned += assignedPaid;

        const borderStyle = month === 11 ? `3px solid #6d28d9` : `1px solid ${borderColor}`;
        return `<tr style="background:${rowBg};">
            <td style="color:${textColor};text-align:center;padding:10px 14px;border-bottom:${borderStyle};font-weight:500;">${monthLabel}</td>
            <td style="padding:10px 14px;border-bottom:${borderStyle};color:#16a34a;">${fmt(sellOpen)}</td>
            <td style="padding:10px 14px;border-bottom:${borderStyle};color:${buyClose < 0 ? '#dc2626' : textColor};">${fmtNeg(buyClose)}</td>
            <td style="padding:10px 14px;border-bottom:${borderStyle};color:${cashFlow >= 0 ? '#16a34a' : '#dc2626'};">${fmt(cashFlow)}</td>
            <td style="padding:10px 14px;border-bottom:${borderStyle};color:${profit >= 0 ? '#16a34a' : '#dc2626'};">${fmt(profit)}</td>
            <td style="padding:10px 14px;border-bottom:${borderStyle};color:#d97706;">${assignedPaid > 0 ? fmt(assignedPaid) : '$0.00'}</td>
        </tr>`;
    });

    const totCashFlow = totSellOpen + totBuyClose;
    const totalRow = `<tr style="background:${totalRowBg};font-weight:bold;">
        <td style="text-align:center;padding:12px 14px;color:#a78bfa;">Total</td>
        <td style="padding:12px 14px;color:#16a34a;">${fmt(totSellOpen)}</td>
        <td style="padding:12px 14px;color:${totBuyClose < 0 ? '#dc2626' : textColor};">${fmtNeg(totBuyClose)}</td>
        <td style="padding:12px 14px;color:${totCashFlow >= 0 ? '#16a34a' : '#dc2626'};">${fmt(totCashFlow)}</td>
        <td style="padding:12px 14px;color:${totProfit >= 0 ? '#16a34a' : '#dc2626'};">${fmt(totProfit)}</td>
        <td style="padding:12px 14px;color:#d97706;">${totAssigned > 0 ? fmt(totAssigned) : '$0.00'}</td>
    </tr>`;

    const years = [...new Set(months.map(m => m.year))];
    let grandSellOpen = 0, grandBuyClose = 0, grandProfit = 0, grandAssigned = 0;

    const yearRows = years.map(year => {
        const yStart = new Date(year, 0, 1);
        const yEnd = new Date(year, 11, 31, 23, 59, 59);

        let ySellOpen = 0, yBuyClose = 0, yProfit = 0, yAssigned = 0;
        window.allTransactions.forEach(t => {
            if (t.date >= yStart && t.date <= yEnd) {
                if (t.action.includes('sell') && t.action.includes('to open')) ySellOpen += t.amount;
                if (t.action.includes('buy') && t.action.includes('to close')) yBuyClose += t.amount;
            }
        });
        finalTrades.forEach(t => {
            if (t.closeDate >= yStart && t.closeDate <= yEnd) {
                const st = t.status.toLowerCase();
                if (st.includes('buy') && st.includes('close')) yProfit += t.profit;
                if (st.includes('expired')) yProfit += t.profit;
                if (st.includes('assigned')) yAssigned += Math.abs(t.openingPremium);
            }
        });
        const yCashFlow = ySellOpen + yBuyClose;
        grandSellOpen += ySellOpen;
        grandBuyClose += yBuyClose;
        grandProfit += yProfit;
        grandAssigned += yAssigned;
        return `<tr style="background:${rowBg};">
            <td style="color:${textColor};text-align:center;padding:10px 14px;border-bottom:1px solid ${borderColor};font-weight:600;">${year}</td>
            <td style="padding:10px 14px;border-bottom:1px solid ${borderColor};color:#16a34a;">${fmt(ySellOpen)}</td>
            <td style="padding:10px 14px;border-bottom:1px solid ${borderColor};color:${yBuyClose < 0 ? '#dc2626' : textColor};">${fmtNeg(yBuyClose)}</td>
            <td style="padding:10px 14px;border-bottom:1px solid ${borderColor};color:${yCashFlow >= 0 ? '#16a34a' : '#dc2626'};">${fmt(yCashFlow)}</td>
            <td style="padding:10px 14px;border-bottom:1px solid ${borderColor};color:${yProfit >= 0 ? '#16a34a' : '#dc2626'};">${fmt(yProfit)}</td>
            <td style="padding:10px 14px;border-bottom:1px solid ${borderColor};color:#d97706;">${yAssigned > 0 ? fmt(yAssigned) : '$0.00'}</td>
        </tr>`;
    });

    const grandCashFlow = grandSellOpen + grandBuyClose;
    const yearTotalRow = `<tr style="background:${totalRowBg};font-weight:bold;">
        <td style="text-align:center;padding:12px 14px;color:#a78bfa;">Total</td>
        <td style="padding:12px 14px;color:#16a34a;">${fmt(grandSellOpen)}</td>
        <td style="padding:12px 14px;color:${grandBuyClose < 0 ? '#dc2626' : textColor};">${fmtNeg(grandBuyClose)}</td>
        <td style="padding:12px 14px;color:${grandCashFlow >= 0 ? '#16a34a' : '#dc2626'};">${fmt(grandCashFlow)}</td>
        <td style="padding:12px 14px;color:${grandProfit >= 0 ? '#16a34a' : '#dc2626'};">${fmt(grandProfit)}</td>
        <td style="padding:12px 14px;color:#d97706;">${grandAssigned > 0 ? fmt(grandAssigned) : '$0.00'}</td>
    </tr>`;

    const thStyle = `padding:10px 8px;background:${thBg};color:#a78bfa;font-size:0.75rem;text-transform:uppercase;letter-spacing:0.04em;border-bottom:2px solid #6d28d9;white-space:normal;word-break:break-word;text-align:center;vertical-align:middle;`;
    const tblStyle = `width:100%;border-collapse:collapse;background:${rowBg};font-size:0.9rem;table-layout:fixed;`;

    document.getElementById('monthlyTableContainer').innerHTML = `
        <h3 style="color:#a78bfa;margin:0 0 14px;font-size:1rem;">Summary by Year</h3>
        <div style="overflow-x:auto;">
        <table style="${tblStyle}">
            <colgroup><col style="width:14%"><col style="width:17.2%"><col style="width:17.2%"><col style="width:17.2%"><col style="width:17.2%"><col style="width:17.2%"></colgroup>
            <thead><tr>
                <th style="${thStyle}">Year</th>
                <th style="${thStyle}">Sell to Open</th>
                <th style="${thStyle}">Buy to Close</th>
                <th style="${thStyle}">Cash Flow</th>
                <th style="${thStyle}">Profit from Closed Options</th>
                <th style="${thStyle}">Paid Premium Assigned</th>
            </tr></thead>
            <tbody>${yearRows.join('')}${yearTotalRow}</tbody>
        </table>
        </div>

        <h3 style="color:#a78bfa;margin:28px 0 14px;font-size:1rem;">Monthly Breakdown</h3>
        <div style="overflow-x:auto;">
        <table style="${tblStyle}">
            <colgroup><col style="width:14%"><col style="width:17.2%"><col style="width:17.2%"><col style="width:17.2%"><col style="width:17.2%"><col style="width:17.2%"></colgroup>
            <thead><tr>
                <th style="${thStyle}">Month</th>
                <th style="${thStyle}">Sell to Open</th>
                <th style="${thStyle}">Buy to Close</th>
                <th style="${thStyle}">Cash Flow</th>
                <th style="${thStyle}">Profit from Closed Options</th>
                <th style="${thStyle}">Paid Premium Assigned</th>
            </tr></thead>
            <tbody>${rows.join('')}${totalRow}</tbody>
        </table>
        </div>`;

    const modal = document.getElementById('monthlyModal');
    modal.style.display = 'flex';
    modal.onclick = (e) => { if (e.target === modal) closeMonthlySummary(); };
}
</script>
</body>
</html>
