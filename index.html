<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Options Profit/Loss Calculator</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: #0f172a;
    color: #f8fafc;
    padding: 20px;
}

.container { max-width: 1600px; margin: 0 auto; }
h1 { text-align: center; color: #a78bfa; margin-bottom: 10px; }
.subtitle { text-align: center; color: #94a3b8; margin-bottom: 25px; font-size: 0.9rem; }

.upload-box {
    background: rgba(255,255,255,0.05);
    border: 2px dashed #6d28d9;
    border-radius: 12px;
    padding: 40px;
    text-align: center;
    cursor: pointer;
    margin-bottom: 20px;
    transition: 0.3s;
}
.upload-box:hover { background: rgba(255,255,255,0.1); border-color: #a78bfa; }

.filter-bar {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    background: #1e293b;
    padding: 25px;
    border-radius: 12px;
    margin-bottom: 25px;
    border: 1px solid #6d28d9;
    box-shadow: 0 4px 20px rgba(109, 40, 217, 0.2);
    align-items: flex-end;
}

.filter-group { display: flex; flex-direction: column; gap: 8px; flex: 1; min-width: 200px; }
.filter-group label {
    font-size: 0.75rem;
    color: #a78bfa;
    text-transform: uppercase;
    font-weight: bold;
    letter-spacing: 0.05em;
}

.filter-bar input, .filter-bar select {
    background: #0f172a;
    border: 2px solid #334155;
    color: #f8fafc;
    padding: 12px;
    border-radius: 8px;
    outline: none;
    width: 100%;
    font-size: 1rem;
    cursor: pointer;
}

.filter-bar input:focus, .filter-bar select:focus {
    border-color: #a78bfa;
    background: #1e293b;
}

/* White calendar icon */
input[type="date"]::-webkit-calendar-picker-indicator {
    filter: invert(1);
    cursor: pointer;
}

.stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 30px;
}

.stat-card {
    background: #1e293b;
    padding: 20px;
    border-radius: 12px;
    border: 1px solid #334155;
    text-align: center;
}

.stat-label {
    font-size: 0.7rem;
    color: #94a3b8;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.stat-value {
    font-size: 1.4rem;
    font-weight: bold;
    margin-top: 8px;
}

table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    background: #1e293b;
    border-radius: 12px;
}

th {
    background: #334155;
    color: #cbd5e1;
    padding: 15px;
    text-align: left;
    cursor: pointer;
    font-size: 0.8rem;
    text-transform: uppercase;
    border-bottom: 2px solid #475569;
    position: sticky;
    top: 0;
    z-index: 10;
}

td {
    padding: 15px;
    border-bottom: 1px solid #334155;
    font-size: 0.9rem;
}

.pos { color: #4ade80; font-weight: 600; }
.neg { color: #f87171; font-weight: 600; }
.tag { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; background: #475569; margin-right: 6px; }

</style>
</head>

<body>
<div class="container">
<h1>Options Profit/Loss Calculator</h1>
<p class="subtitle">Aggregated Analysis & Realized Profit/Loss</p>

<div class="upload-box" id="dropZone">
<p style="font-size: 1.2rem;">Click to Upload Schwab CSV/Excel Transactions Here</p>
<input type="file" id="filePicker" accept=".csv,.xlsx" style="display:none">
</div>

<div class="filter-bar">
<div class="filter-group">
<label>1. Search Symbol</label>
<input type="text" id="searchInput" placeholder="Search Ticker..." oninput="applyFilters()">
</div>

<div class="filter-group">
<label>2. Quick Range (Dropdown)</label>
<select id="quickRange" onchange="setQuickRange()">
<option value="all">--- Select Range ---</option>
<option value="today">Today</option>
<option value="7days">Last 7 Days</option>
<option value="currentMonth">Current Month</option>
<option value="prevMonth">Previous Month</option>
<option value="last6Months">Last 6 Months</option>
<option value="currentYear">Current Year</option>
<option value="prevYear">Previous Year</option>
<option value="all">Show All</option>
</select>
</div>

<div class="filter-group">
<label>3. From Date</label>
<input type="date" id="startDate" onchange="applyFilters()">
</div>

<div class="filter-group">
<label>4. To Date</label>
<input type="date" id="endDate" onchange="applyFilters()">
</div>

<button onclick="resetFilters()" style="background:#ef4444;color:white;border:none;padding:12px 20px;border-radius:8px;cursor:pointer;font-weight:bold;">Reset</button>
</div>

<div id="summary" class="stats"></div>

<table>
<thead>
<tr id="headerRow"></tr>
</thead>
<tbody id="tableBody"></tbody>
</table>
</div>

<script>
let rawProcessedData = [];
let sortKey = 'transactionDate';
let sortDir = -1;

const dropZone = document.getElementById('dropZone');
const filePicker = document.getElementById('filePicker');

dropZone.onclick = () => filePicker.click();
filePicker.onchange = (e) => handleFile(e.target.files[0]);

async function handleFile(file) {
    if (!file) return;
    const data = await file.arrayBuffer();
    const workbook = XLSX.read(data, { type: 'array' });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(sheet);
    process(json);
}

function parseDateString(dStr) {
    if (!dStr) return null;
    if (!isNaN(dStr) && typeof dStr !== 'string') {
        return new Date((dStr - 25569) * 86400 * 1000);
    }
    const parts = String(dStr).trim().split(/\s+/);
    const actualDateStr = parts[parts.length - 1];
    const d = new Date(actualDateStr);
    if (isNaN(d.getTime()) && !isNaN(actualDateStr)) {
        return new Date((parseFloat(actualDateStr) - 25569) * 86400 * 1000);
    }
    return isNaN(d.getTime()) ? null : d;
}

function cleanNum(val) {
    if (val === undefined || val === null || val === "") return 0;
    let str = String(val).replace(/[$\s,]/g, '');
    if (str.startsWith('(') && str.endsWith(')')) {
        str = '-' + str.substring(1, str.length - 1);
    }
    return parseFloat(str) || 0;
}

function formatDate(dObj) {
    if (!dObj || isNaN(dObj.getTime())) return "N/A";
    const mm = (dObj.getMonth() + 1).toString().padStart(2, '0');
    const dd = dObj.getDate().toString().padStart(2, '0');
    return `${mm}/${dd}/${dObj.getFullYear()}`;
}

function toISODate(d) {
    return d.toISOString().split('T')[0];
}

function setQuickRange() {
    const range = document.getElementById('quickRange').value;
    const startInput = document.getElementById('startDate');
    const endInput = document.getElementById('endDate');
    const today = new Date();
    let start = null;
    let end = today;

    switch(range) {
        case 'today': start = today; break;
        case '7days': start = new Date(); start.setDate(today.getDate() - 6); break;
        case 'currentMonth': start = new Date(today.getFullYear(), today.getMonth(), 1); break;
        case 'prevMonth': start = new Date(today.getFullYear(), today.getMonth() - 1, 1); end = new Date(today.getFullYear(), today.getMonth(), 0); break;
        case 'last6Months': start = new Date(); start.setMonth(today.getMonth() - 6); break;
        case 'currentYear': start = new Date(today.getFullYear(), 0, 1); break;
        case 'prevYear': start = new Date(today.getFullYear() - 1, 0, 1); end = new Date(today.getFullYear() - 1, 11, 31); break;
        case 'all': start = null; end = null; break;
    }

    startInput.value = start ? toISODate(start) : '';
    endInput.value = end ? toISODate(end) : '';
    applyFilters();
}

function resetFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('quickRange').value = 'all';
    document.getElementById('startDate').value = '';
    document.getElementById('endDate').value = '';
    applyFilters();
}

function applyFilters() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const startVal = document.getElementById('startDate').value;
    const endVal = document.getElementById('endDate').value;
    const startDate = startVal ? new Date(startVal + "T00:00:00") : null;
    const endDate = endVal ? new Date(endVal + "T23:59:59") : null;

    const filtered = rawProcessedData.filter(item => {
        const matchesSearch = item.symbol.toLowerCase().includes(searchTerm);
        const itemDate = item.transactionDate;
        let matchesDate = true;
        if (startDate && (!itemDate || itemDate < startDate)) matchesDate = false;
        if (endDate && (!itemDate || itemDate > endDate)) matchesDate = false;
        return matchesSearch && matchesDate;
    });

    render(null, filtered);
}

function process(rows) {
    const groups = {};

    rows.forEach(row => {
        const sym = row.Symbol;
        const action = (row.Action || "").toLowerCase();
        if (!sym || !sym.includes(' ')) return;

        const rowDate = parseDateString(row.Date);

        if (!groups[sym]) {
            groups[sym] = {
                symbol: sym,
                contracts: 0,
                openingPremium: 0,
                closingPremium: 0,
                openDate: rowDate,
                closeDate: null,
                status: 'Sell to Open',
                type: sym.endsWith('P') ? 'Put' : 'Call'
            };
        }

        const amt = cleanNum(row.Amount);
        const qty = Math.abs(cleanNum(row.Quantity));

        if (action.includes('to open')) {
            groups[sym].contracts += qty;
            groups[sym].openingPremium += amt;
            if (rowDate && (!groups[sym].openDate || rowDate < groups[sym].openDate)) {
                groups[sym].openDate = rowDate;
            }
        } else if (action.includes('to close') || action === 'expired' || action === 'assigned') {
            groups[sym].closingPremium += amt;
            groups[sym].status = action.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
            if (rowDate && (!groups[sym].closeDate || rowDate > groups[sym].closeDate)) {
                groups[sym].closeDate = rowDate;
            }
        }
    });

    rawProcessedData = Object.values(groups).map(g => {
        const isClosed = g.status !== 'Sell to Open';
        const transactionDate = isClosed && g.closeDate ? g.closeDate : g.openDate;
        const profit = isClosed ? (g.openingPremium + g.closingPremium) : null;
        const profitPct = (isClosed && g.openingPremium !== 0)
            ? (profit / Math.abs(g.openingPremium)) * 100
            : null;

        return { ...g, transactionDate, profit, profitPct };
    });

    applyFilters();
}

function render(newSortKey, dataToRender = null) {
    const displayData = dataToRender || rawProcessedData;

    if (newSortKey) {
        if (sortKey === newSortKey) sortDir *= -1;
        else { sortKey = newSortKey; sortDir = 1; }
    }

    displayData.sort((a, b) => {
        let v1 = a[sortKey], v2 = b[sortKey];
        if (v1 === null) v1 = -Infinity;
        if (v2 === null) v2 = -Infinity;
        if (v1 instanceof Date) { v1 = v1.getTime(); v2 = v2.getTime(); }
        return v1 < v2 ? -sortDir : v1 > v2 ? sortDir : 0;
    });

    const totalPL = displayData.reduce((s, x) => s + (x.profit || 0), 0);
    const openPositions = displayData.filter(x => x.status === 'Sell to Open');
    const openCount = openPositions.length;
    const totalOpenPremium = openPositions.reduce((s, x) => s + x.openingPremium, 0);
    const netCombined = totalPL + totalOpenPremium;

    document.getElementById('summary').innerHTML = `
        <div class="stat-card"><div class="stat-label">Total Realized P/L</div><div class="stat-value ${totalPL >= 0 ? 'pos' : 'neg'}">$${totalPL.toLocaleString(undefined, {minimumFractionDigits: 2})}</div></div>
        <div class="stat-card"><div class="stat-label">Closed Positions</div><div class="stat-value">${displayData.length - openCount}</div></div>
        <div class="stat-card"><div class="stat-label">Open Positions</div><div class="stat-value" style="color: #a78bfa">${openCount}</div></div>
        <div class="stat-card"><div class="stat-label">Total Open Premium</div><div class="stat-value" style="color: #60a5fa">$${Math.abs(totalOpenPremium).toLocaleString(undefined, {minimumFractionDigits: 2})}</div></div>
        <div class="stat-card"><div class="stat-label">Net Combined (P/L + Open)</div><div class="stat-value" style="color: #f59e0b">$${netCombined.toLocaleString(undefined, {minimumFractionDigits: 2})}</div></div>
    `;

    const cols = [
        { lab: 'Option Symbol', key: 'symbol' },
        { lab: 'Status', key: 'status' },
        { lab: 'Qty', key: 'contracts' },
        { lab: 'Date', key: 'transactionDate' },
        { lab: 'Premium', key: 'openingPremium' },
        { lab: 'Realized P/L', key: 'profit' },
        { lab: '%', key: 'profitPct' }
    ];

    document.getElementById('headerRow').innerHTML =
        cols.map(c => `<th onclick="render('${c.key}', null)">${c.lab} â†•</th>`).join('');

    document.getElementById('tableBody').innerHTML =
        displayData.map(p => `
        <tr>
            <td>${p.symbol}</td>
            <td><span class="tag">${p.status}</span></td>
            <td>${p.contracts}</td>
            <td>${formatDate(p.transactionDate)}</td>
            <td>$${Math.abs(p.openingPremium).toLocaleString(undefined, {minimumFractionDigits: 2})}</td>
            <td class="${p.profit !== null ? (p.profit >= 0 ? 'pos' : 'neg') : ''}">
                ${p.profit !== null ? '$' + p.profit.toLocaleString(undefined, {minimumFractionDigits: 2}) : '--'}
            </td>
            <td class="${p.profitPct !== null ? (p.profitPct >= 0 ? 'pos' : 'neg') : ''}">
                ${p.profitPct !== null ? p.profitPct.toFixed(2) + '%' : '--'}
            </td>
        </tr>
    `).join('');
}
</script>
</body>
</html>
