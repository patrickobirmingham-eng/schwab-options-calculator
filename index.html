<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Schwab Options Calculator & Data Sorter</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
:root[data-theme="dark"] {
    --bg-primary: #0f172a;
    --bg-secondary: #1e293b;
    --bg-tertiary: #334155;
    --bg-input: #0f172a;
    --border-color: #334155;
    --border-accent: #6d28d9;
    --text-primary: #f8fafc;
    --text-secondary: #94a3b8;
    --text-muted: #cbd5e1;
    --tag-bg: #475569;
    --shadow: rgba(0,0,0,0.6);
    --toggle-bg: #334155;
    --toggle-icon: '‚òÄÔ∏è';
    --toggle-label: 'Light Mode';
}

:root[data-theme="light"] {
    --bg-primary: #f8fafc;
    --bg-secondary: #ffffff;
    --bg-tertiary: #e2e8f0;
    --bg-input: #f1f5f9;
    --border-color: #cbd5e1;
    --border-accent: #7c3aed;
    --text-primary: #0f172a;
    --text-secondary: #475569;
    --text-muted: #334155;
    --tag-bg: #94a3b8;
    --shadow: rgba(0,0,0,0.15);
    --toggle-bg: #e2e8f0;
    --toggle-icon: 'üåô';
    --toggle-label: 'Dark Mode';
}

* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--bg-primary); color: var(--text-primary); padding: 20px; transition: background 0.3s ease, color 0.3s ease; position: relative; }
.container { max-width: 1600px; margin: 0 auto; }
h1 { text-align: center; color: #a78bfa; margin-bottom: 10px; }
.subtitle { text-align: center; color: var(--text-secondary); margin-bottom: 25px; font-size: 0.9rem; }
.upload-box { background: rgba(109,40,217,0.08); border: 2px dashed #6d28d9; border-radius: 12px; padding: 40px; text-align: center; cursor: pointer; margin-bottom: 20px; transition: background 0.3s; }
[data-theme="light"] .upload-box { background: rgba(109,40,217,0.05); }
.filter-bar { display: flex; flex-wrap: wrap; gap: 20px; background: var(--bg-secondary); padding: 25px; border-radius: 12px; margin-bottom: 25px; border: 1px solid var(--border-accent); align-items: flex-end; transition: background 0.3s, border-color 0.3s; }
.filter-group { display: flex; flex-direction: column; gap: 8px; flex: 1; min-width: 200px; }
.filter-group label { color: var(--text-primary); font-size: 0.85rem; font-weight: 600; }
.checkbox-grid { display: grid; grid-template-columns: minmax(0, 1fr) minmax(0, 1fr); gap: 8px; background: var(--bg-input); padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); align-items: start; transition: background 0.3s; }
.checkbox-item { display: flex; align-items: center; gap: 8px; font-size: 0.75rem; color: var(--text-muted); }
.checkbox-item input[type="checkbox"] { flex-shrink: 0; width: 16px; height: 16px; accent-color: #7c3aed; }

/* Theme Toggle Button */
#themeToggle {
    position: absolute;
    top: 16px;
    right: 16px;
    z-index: 9999;
    display: flex;
    align-items: center;
    gap: 8px;
    background: var(--bg-secondary);
    color: var(--text-primary);
    border: 2px solid var(--border-accent);
    border-radius: 50px;
    padding: 8px 14px 8px 10px;
    cursor: pointer;
    font-size: 0.8rem;
    font-weight: 600;
    letter-spacing: 0.03em;
    box-shadow: 0 4px 16px var(--shadow);
    transition: all 0.25s ease;
    white-space: nowrap;
}
#themeToggle:hover {
    background: var(--border-accent);
    color: #fff;
    transform: translateY(-1px);
    box-shadow: 0 6px 20px rgba(109,40,217,0.4);
}
#themeToggle .toggle-track {
    width: 36px;
    height: 20px;
    background: var(--toggle-bg);
    border-radius: 10px;
    position: relative;
    transition: background 0.25s;
    flex-shrink: 0;
    border: 1px solid var(--border-color);
}
#themeToggle .toggle-thumb {
    position: absolute;
    top: 2px;
    left: 2px;
    width: 14px;
    height: 14px;
    background: #7c3aed;
    border-radius: 50%;
    transition: transform 0.25s ease, background 0.25s;
}
[data-theme="light"] #themeToggle .toggle-thumb {
    transform: translateX(16px);
    background: #f59e0b;
}
#themeToggle .toggle-emoji {
    font-size: 0.95rem;
    line-height: 1;
}

@media (max-width: 768px) {
    #themeToggle { padding: 8px 12px 8px 10px; font-size: 0.75rem; top: 10px; right: 10px; }
    #themeToggle .toggle-label { display: none; }
    #uploadBtn { top: 10px; left: 10px; font-size: 0.75rem; padding: 8px 10px; }
    #uploadBtn .upload-btn-text { display: none; }
    body { padding: 10px; }
    h1 { font-size: 1.5rem; margin-top: 55px; }
    .subtitle { font-size: 0.8rem; }
    .upload-box { padding: 20px; }
    .upload-box p { font-size: 1rem !important; }
    .filter-bar { flex-direction: column; padding: 15px; gap: 15px; }
    .filter-group { min-width: 100%; }
    .checkbox-grid { grid-template-columns: 1fr; }
    .stats { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; }
    .stat-card { padding: 15px; }
    .stat-label { font-size: 0.65rem; }
    .stat-value { font-size: 1.2rem; }
    .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    table { min-width: 800px; font-size: 0.8rem; }
    th, td { padding: 10px 8px; font-size: 0.75rem; }
    .tag { font-size: 0.65rem; padding: 2px 6px; }
}

@media (max-width: 480px) {
    h1 { font-size: 1.2rem; }
    .stats { grid-template-columns: repeat(2, 1fr); }
    table { min-width: 600px; }
}

@media (max-width: 360px) {
    .stats { grid-template-columns: 1fr; }
}

.filter-bar input, .filter-bar select {
    background: var(--bg-input);
    border: 2px solid var(--border-color);
    color: var(--text-primary);
    padding: 12px;
    border-radius: 8px;
    outline: none;
    width: 100%;
    font-size: 1rem;
    transition: background 0.3s, border-color 0.3s, color 0.3s;
}
.filter-bar input::placeholder { color: var(--text-secondary); }
.filter-bar select option { background: var(--bg-secondary); color: var(--text-primary); }
input[type="date"]::-webkit-calendar-picker-indicator { filter: var(--calendar-filter, invert(1)); cursor: pointer; }
[data-theme="light"] input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(0); }

.stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; margin-bottom: 30px; }
.stat-card { background: var(--bg-secondary); padding: 10px 6px; border-radius: 12px; border: 1px solid var(--border-color); text-align: center; transition: background 0.3s, border-color 0.3s; }
.stat-label { font-size: 0.62rem; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 6px; }
.stat-value { font-size: 1.05rem; font-weight: bold; }

table { width: 100%; border-collapse: collapse; background: var(--bg-secondary); border-radius: 12px; table-layout: auto; transition: background 0.3s; }
thead tr { position: sticky; top: 0; z-index: 20; }
th { background: var(--bg-tertiary); color: var(--text-muted); padding: 15px; text-align: center; cursor: pointer; font-size: 0.8rem; border-bottom: 2px solid #6d28d9; box-shadow: 0 3px 6px var(--shadow); position: relative; transition: background 0.3s; }
th .resizer { position: absolute; top: 0; right: 0; width: 5px; cursor: col-resize; user-select: none; height: 100%; background: transparent; }
th .resizer:hover { background: #6d28d9; }
td { padding: 15px; border-bottom: 1px solid var(--border-color); font-size: 0.9rem; text-align: center; color: var(--text-primary); transition: border-color 0.3s, color 0.3s; }
.pos { color: #16a34a; } 
[data-theme="dark"] .pos { color: #4ade80; }
.neg { color: #dc2626; }
[data-theme="dark"] .neg { color: #f87171; }
.waiting { color: #d97706; }
[data-theme="dark"] .waiting { color: #fbbf24; }
.tag { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; background: var(--tag-bg); color: var(--text-primary); }
.tag-waiting { background: #f59e0b; color: #000; }
@keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.4; } }

#uploadBtn:hover {
    background: #6d28d9;
    color: #fff;
    transform: translateY(-1px);
    box-shadow: 0 6px 20px rgba(109,40,217,0.4);
}
#uploadBtn:hover svg path { stroke: #fff; }

/* Upload box text */
.upload-box p { color: var(--text-primary); }
.upload-box p:not(:first-child) { color: var(--text-secondary); }

/* Date range text */
#dateRange { color: var(--text-secondary); }

/* Modal */
#monthlyModal > div { background: var(--bg-secondary); border: 1px solid var(--border-accent); }
</style>
</head>

<body>
<!-- Dark/Light Mode Toggle -->
<button id="themeToggle" onclick="toggleTheme()" title="Toggle Dark/Light Mode">
    <span class="toggle-emoji" id="toggleEmoji">‚òÄÔ∏è</span>
    <div class="toggle-track">
        <div class="toggle-thumb"></div>
    </div>
</button>

<!-- Upload Transactions compact button (shown after file is loaded) -->
<button id="uploadBtn" onclick="document.getElementById('filePicker').click()" title="Upload transactions file" style="display:none; position:absolute; top:16px; left:16px; z-index:9999; align-items:center; gap:8px; background:var(--bg-secondary); color:var(--text-primary); border:2px solid #6d28d9; border-radius:50px; padding:8px 14px 8px 14px; cursor:pointer; font-size:0.8rem; font-weight:600; letter-spacing:0.03em; box-shadow:0 4px 16px var(--shadow); transition:all 0.25s ease; white-space:nowrap;">
    <span class="upload-btn-text">Upload</span>
    <svg xmlns="http://www.w3.org/2000/svg" width="1.1em" height="1.1em" viewBox="0 0 24 24" style="vertical-align:middle; flex-shrink:0;"><path d="M12 16V4m0 0L8 8m4-4 4 4" stroke="#a78bfa" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" fill="none"/><path d="M4 20h16" stroke="#a78bfa" stroke-width="2.2" stroke-linecap="round"/></svg>
</button>

<div class="container">
    <h1>Schwab Options Calculator & Data Sorter</h1>
    <p class="subtitle">FIFO Transactional Analysis & Date-Matched P/L</p>
    <p id="mainFilename" style="text-align:center; font-size:0.85rem; margin-top:-14px; margin-bottom:20px; display:none;"></p>

    <div class="upload-box" id="dropZone">
        <p style="font-size: 1.2rem;">Click to Upload Schwab CSV/Excel Transactions</p>
        <p style="font-size: 0.9rem; margin-top: 15px;">Column titles are: Date | Action | Symbol | Description | Quantity | Price | Fees & Comm | Amount</p>
        <p style="font-size: 0.9rem; margin-top: 10px;">Supports .xlsx, .xls, .csv, and other spreadsheet files</p>
        <p id="uploadedFileName" style="font-size: 0.9rem; color: #a78bfa; margin-top: 10px; display:none;"></p>
        <input type="file" id="filePicker" accept=".csv,.xlsx" style="display:none">
    </div>

    <div class="filter-bar" id="filterBar" style="display:none; flex-direction:column; gap:16px;">

        <!-- All 4 filters + Reset button in one horizontal centered row -->
        <div style="display:flex; flex-wrap:wrap; gap:20px; align-items:center; justify-content:center; width:100%;">

            <div style="display:flex; flex-direction:column; align-items:center; gap:6px;">
                <label style="font-weight:600; font-size:0.85rem; color:var(--text-primary);">1. Status Filter</label>
                <div id="statusCheckboxes" style="display:inline-flex; flex-wrap:wrap; justify-content:center; gap:6px 16px; background:var(--bg-input); padding:8px 14px; border-radius:8px; border:1px solid var(--border-color);">
                    <label class="checkbox-item"><input type="checkbox" value="Buy to Close" checked onchange="applyFilters()"> Buy to Close</label>
                    <label class="checkbox-item"><input type="checkbox" value="Assigned" onchange="applyFilters()"> Assigned</label>
                    <label class="checkbox-item"><input type="checkbox" value="Called Away" checked onchange="applyFilters()"> Called Away</label>
                    <label class="checkbox-item"><input type="checkbox" value="Sell to Close" checked onchange="applyFilters()"> Sell to Close</label>
                    <label class="checkbox-item"><input type="checkbox" value="Expired" checked onchange="applyFilters()"> Expired</label>
                    <label class="checkbox-item"><input type="checkbox" value="Sell to Open" checked onchange="applyFilters()"> Sell to Open</label>
                    <label class="checkbox-item"><input type="checkbox" value="Buy to Open" checked onchange="applyFilters()"> Buy to Open</label>
                </div>
            </div>

            <div style="display:flex; flex-direction:column; align-items:center; gap:6px;">
                <label style="font-weight:600; font-size:0.85rem; color:var(--text-primary);">2. Quick Range</label>
                <select id="quickRange" onchange="setQuickRange()" style="background:var(--bg-input);border:2px solid var(--border-color);color:var(--text-primary);padding:12px;border-radius:8px;outline:none;font-size:1rem;">
                    <option value="all" selected>Show All</option>
                    <option value="today">Today</option>
                    <option value="7days">Last 7 Days</option>
                    <option value="currentMonth">Current Month</option>
                    <option value="lastMonth">Last Month</option>
                    <option value="currentYear">Current Year</option>
                    <option value="lastYear">Last Year</option>
                    <option value="last3Months">Last 3 Months</option>
                    <option value="last6Months">Last 6 Months</option>
                    <option value="last12Months">Last 12 Months</option>
                </select>
            </div>

            <div style="display:flex; flex-direction:column; align-items:center; gap:6px;">
                <label style="font-weight:600; font-size:0.85rem; color:var(--text-primary);">3. From Date</label>
                <input type="date" id="startDate" onchange="applyFilters()" style="background:var(--bg-input);border:2px solid var(--border-color);color:var(--text-primary);padding:12px;border-radius:8px;outline:none;font-size:1rem;">
            </div>

            <div style="display:flex; flex-direction:column; align-items:center; gap:6px;">
                <label style="font-weight:600; font-size:0.85rem; color:var(--text-primary);">4. To Date</label>
                <input type="date" id="endDate" onchange="applyFilters()" style="background:var(--bg-input);border:2px solid var(--border-color);color:var(--text-primary);padding:12px;border-radius:8px;outline:none;font-size:1rem;">
            </div>

            <div style="display:flex; flex-direction:column; align-items:center; justify-content:flex-end; gap:6px;">
                <label style="font-weight:600; font-size:0.85rem; color:transparent; user-select:none;">.</label>
                <button onclick="resetFilters()" style="background:#ef4444;color:white;border:none;padding:12px 18px;border-radius:8px;cursor:pointer;font-weight:bold;font-size:0.8rem;display:inline-flex;align-items:center;gap:6px;"><svg xmlns="http://www.w3.org/2000/svg" width="1.1em" height="1.1em" viewBox="0 0 24 24" style="vertical-align:middle;"><path d="M3 12a9 9 0 0 1 15-6.7M21 12a9 9 0 0 1-15 6.7M21 3v5h-5M3 21v-5h5" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg> Reset Filters</button>
            </div>

        </div>

    </div>
    <div id="actionButtons" style="display:none; justify-content:center; gap:16px; margin-bottom:25px; flex-wrap:wrap;">
        <button onclick="showMonthlySummary()" style="background:#6d28d9;color:white;border:none;padding:7px 18px;border-radius:8px;cursor:pointer;font-weight:bold;display:inline-flex;align-items:center;gap:8px;"><svg xmlns="http://www.w3.org/2000/svg" width="2.0em" height="2.0em" viewBox="0 0 24 24" style="vertical-align:middle;display:inline-block;"><circle cx="12" cy="12" r="12" fill="#6d28d9"/><rect x="6" y="13" width="3" height="5" rx="0.5" fill="white"/><rect x="10.5" y="9" width="3" height="9" rx="0.5" fill="white"/><rect x="15" y="11" width="3" height="7" rx="0.5" fill="white"/></svg> Monthly / Annual Summary</button>
        <button onclick="showOpenCommitments()" style="background:#0ea5e9;color:white;border:none;padding:7px 18px;border-radius:8px;cursor:pointer;font-weight:bold;display:inline-flex;align-items:center;gap:8px;"><svg xmlns="http://www.w3.org/2000/svg" width="1.7em" height="1.7em" viewBox="0 0 24 24" style="vertical-align:middle;display:inline-block;"><rect x="7" y="7" width="10" height="13" rx="1.5" stroke="white" stroke-width="2" fill="white" fill-opacity="0.15"/><path d="M10 7V6a2 2 0 0 1 4 0v1" stroke="white" stroke-width="2" stroke-linecap="round" fill="none"/><rect x="9.5" y="10" width="5" height="1.5" rx="0.75" fill="white"/><rect x="9.5" y="13" width="5" height="1.5" rx="0.75" fill="white"/><rect x="9.5" y="16" width="3" height="1.5" rx="0.75" fill="white"/></svg> Open Commitments</button>
        <button onclick="showAssignments()" style="background:#f59e0b;color:white;border:none;padding:7px 18px;border-radius:8px;cursor:pointer;font-weight:bold;display:inline-flex;align-items:center;gap:8px;"><svg xmlns="http://www.w3.org/2000/svg" width="1.7em" height="1.7em" viewBox="0 0 24 24" style="vertical-align:middle;display:inline-block;"><circle cx="12" cy="12" r="12" fill="#f59e0b"/><path d="M8 7h8M8 11h8M8 15h5" stroke="white" stroke-width="2" stroke-linecap="round"/><circle cx="17" cy="16" r="3.5" fill="#f59e0b" stroke="white" stroke-width="1.5"/><path d="M16 16l.8.8 1.7-1.6" stroke="white" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg> Assignments</button>
        <button onclick="showTransactionSorter()" style="background:#10b981;color:white;border:none;padding:7px 18px;border-radius:8px;cursor:pointer;font-weight:bold;display:inline-flex;align-items:center;gap:8px;"><svg xmlns="http://www.w3.org/2000/svg" width="1.7em" height="1.7em" viewBox="0 0 24 24" style="vertical-align:middle;display:inline-block;"><circle cx="12" cy="12" r="12" fill="#10b981"/><path d="M7 8h10M7 12h7M7 16h4" stroke="white" stroke-width="2" stroke-linecap="round"/><path d="M17 14l2 2 2-2M19 16v-4" stroke="white" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg> Transaction Data Sorter</button>
    </div>

    <!-- Transaction Data Sorter Modal -->
    <div id="txSorterModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.75); z-index:1000; justify-content:center; align-items:flex-start; overflow-y:auto;">
        <div id="txSorterInner" style="width:95vw; max-width:1600px; margin:20px auto; border-radius:16px; padding:24px; position:relative; box-sizing:border-box;">
            <!-- Header -->
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; flex-wrap:wrap; gap:10px;">
                <h2 style="color:#10b981; font-size:1.2rem; margin:0; display:inline-flex; align-items:center; gap:10px;"><svg xmlns="http://www.w3.org/2000/svg" width="1.4em" height="1.4em" viewBox="0 0 24 24" style="vertical-align:middle;flex-shrink:0;"><circle cx="12" cy="12" r="12" fill="#10b981"/><path d="M7 8h10M7 12h7M7 16h4" stroke="white" stroke-width="2" stroke-linecap="round"/><path d="M17 14l2 2 2-2M19 16v-4" stroke="white" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>Transaction Data Sorter</h2>
                <button onclick="closeTxSorter()" style="background:#ef4444;color:white;border:none;padding:8px 14px;border-radius:8px;cursor:pointer;font-weight:bold;font-size:1rem;">‚úï Close</button>
            </div>

            <!-- Filters -->
            <div id="tsSummarySection" style="margin-bottom:16px;">
                <div id="tsSummaryGrid" style="display:flex; flex-wrap:wrap; gap:12px; align-items:stretch; justify-content:center;"></div>
            </div>

            <div style="background:var(--bg-secondary); border:1px solid var(--border-color); border-radius:12px; padding:16px; margin-bottom:16px;">
                <!-- Action checkboxes -->
                <div style="margin-bottom:14px;">
                    <div style="font-size:0.75rem; font-weight:600; color:var(--text-secondary); text-transform:uppercase; letter-spacing:0.05em; margin-bottom:8px; text-align:center;">Action Filters</div>
                    <div id="tsActionCheckboxes" style="display:flex; flex-wrap:wrap; gap:6px 16px; justify-content:center;"></div>
                </div>
                <!-- Date + secondary filters row -->
                <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; justify-content:center;">
                    <div style="display:contents;">
                        <div>
                            <div style="font-size:0.75rem; font-weight:600; color:var(--text-secondary); margin-bottom:4px;">Quick Range</div>
                            <select id="tsDatePreset" onchange="tsApplyDatePreset()" style="padding:7px 10px; border-radius:8px; border:2px solid var(--border-color); background:var(--bg-input); color:var(--text-primary); font-size:0.85rem;">
                                <option value="all">All</option>
                                <option value="today">Today</option>
                                <option value="last7">Last 7 Days</option>
                                <option value="currentMonth">Current Month</option>
                                <option value="lastMonth">Last Month</option>
                                <option value="currentYear">Current Year</option>
                                <option value="lastYear">Last Year</option>
                                <option value="last3Months">Last 3 Months</option>
                                <option value="last6Months">Last 6 Months</option>
                                <option value="last12Months">Last 12 Months</option>
                            </select>
                        </div>
                        <div>
                            <div style="font-size:0.75rem; font-weight:600; color:var(--text-secondary); margin-bottom:4px;">From Date</div>
                            <input type="date" id="tsDateFrom" onchange="tsApplyFilters()" style="padding:7px 10px; border-radius:8px; border:2px solid var(--border-color); background:var(--bg-input); color:var(--text-primary); font-size:0.85rem;">
                        </div>
                        <div>
                            <div style="font-size:0.75rem; font-weight:600; color:var(--text-secondary); margin-bottom:4px;">To Date</div>
                            <input type="date" id="tsDateTo" onchange="tsApplyFilters()" style="padding:7px 10px; border-radius:8px; border:2px solid var(--border-color); background:var(--bg-input); color:var(--text-primary); font-size:0.85rem;">
                        </div>
                        <div>
                            <div style="font-size:0.75rem; font-weight:600; color:var(--text-secondary); margin-bottom:4px;">Search Table</div>
                            <input type="text" id="tsSymbolSearch" placeholder="Search all columns..." oninput="tsApplyFilters()" style="padding:7px 10px; border-radius:8px; border:2px solid var(--border-color); background:var(--bg-input); color:var(--text-primary); font-size:0.85rem; width:140px;">
                        </div>
                    </div>
                    <div style="display:flex; gap:8px; align-items:flex-end;">
                        <button onclick="tsReset()" style="background:#6d28d9;color:white;border:none;padding:7px 16px;border-radius:8px;cursor:pointer;font-weight:bold;font-size:0.85rem;">Reset Filters</button>
                        <button onclick="tsDownload()" style="background:#10b981;color:white;border:none;padding:7px 16px;border-radius:8px;cursor:pointer;font-weight:bold;font-size:0.85rem;">‚¨á Download</button>
                    </div>
                </div>
            </div>

            <!-- Table -->
            <div style="display:flex; align-items:center; justify-content:center; gap:20px; margin-bottom:8px; flex-wrap:wrap;">
                <div id="tsDateRangeBar" style="font-size:0.82rem; color:var(--text-secondary); font-weight:500; letter-spacing:0.03em;"></div>

            </div>
            <div style="overflow-x:auto; overflow-y:auto; max-height:55vh; border-radius:8px;">
                <table id="tsSorterTable" style="width:100%; border-collapse:collapse; font-size:0.83rem; table-layout:auto;">
                    <thead style="position:sticky; top:0; z-index:10;"><tr id="tsSorterHead"></tr></thead>
                    <tbody id="tsSorterBody"></tbody>
                </table>
            </div>
        </div>
    </div>
    <div id="openCommitmentsModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.75); z-index:1000; justify-content:center; align-items:center;">
        <div id="ocInner" style="border-radius:16px; padding:30px; max-width:1600px; width:95vw; max-height:90vh; overflow-y:auto; position:relative;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; flex-wrap:wrap; gap:10px;">
                <h2 style="color: var(--text-primary); font-size:1.2rem; display:inline-flex; align-items:center; gap:10px;"><svg xmlns="http://www.w3.org/2000/svg" width="1.4em" height="1.4em" viewBox="0 0 24 24" style="vertical-align:middle;flex-shrink:0;"><rect x="7" y="7" width="10" height="13" rx="1.5" stroke="#0ea5e9" stroke-width="2" fill="#0ea5e9" fill-opacity="0.15"/><path d="M10 7V6a2 2 0 0 1 4 0v1" stroke="#0ea5e9" stroke-width="2" stroke-linecap="round" fill="none"/><rect x="9.5" y="10" width="5" height="1.5" rx="0.75" fill="#0ea5e9"/><rect x="9.5" y="13" width="5" height="1.5" rx="0.75" fill="#0ea5e9"/><rect x="9.5" y="16" width="3" height="1.5" rx="0.75" fill="#0ea5e9"/></svg>Open Commitments</h2>
                <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
                    <button id="refreshPricesBtn" onclick="refreshStockPrices()" style="background:#0ea5e9;color:white;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:bold;font-size:0.85rem;">üîÑ Refresh Prices</button>
                    <button onclick="closeOpenCommitments()" style="background:#ef4444;color:white;border:none;padding:8px 14px;border-radius:8px;cursor:pointer;font-weight:bold;font-size:1rem;">‚úï Close</button>
                </div>
            </div>
            <!-- Finnhub API key setup bar -->
            <div id="apiKeyBar" style="background:rgba(16,185,129,0.08);border:1px solid #10b981;border-radius:8px;padding:10px 14px;margin-bottom:12px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
                <span style="font-size:0.8rem;color:var(--text-secondary);flex-shrink:0;">üîë Finnhub API Key:</span>
                <input id="finnhubKeyInput" type="text" value="d6bjguhr01qp4lhvmct0d6bjguhr01qp4lhvmctg" readonly
                    style="flex:1;min-width:220px;background:var(--bg-input);border:1px solid #10b981;color:var(--text-secondary);padding:6px 10px;border-radius:6px;font-size:0.8rem;outline:none;cursor:default;">
                <button onclick="saveFinnhubKey()" style="background:#0ea5e9;color:white;border:none;padding:6px 14px;border-radius:6px;cursor:pointer;font-size:0.8rem;font-weight:bold;white-space:nowrap;">Save Key</button>
                <button onclick="testFinnhubKey()" style="background:#7c3aed;color:white;border:none;padding:6px 14px;border-radius:6px;cursor:pointer;font-size:0.8rem;font-weight:bold;white-space:nowrap;">üß™ Test Key</button>
                <a href="https://finnhub.io/register" target="_blank" style="font-size:0.75rem;color:#0ea5e9;white-space:nowrap;">Get free key ‚Üó</a>
            </div>
            <div id="priceTimestamp" style="font-size:0.75rem;color:var(--text-secondary);margin-bottom:8px;text-align:right;"></div>
            <div id="openCommitmentsContainer"></div>
        </div>
    </div>

    <!-- Monthly Summary Modal -->
    <div id="monthlyModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.75); z-index:1000; justify-content:center; align-items:center;">
        <div id="monthlyInner" style="border-radius:16px; padding:30px; max-width:1600px; width:95vw; max-height:98vh; overflow-y:auto; position:relative;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="color: var(--text-primary); font-size:1.2rem; display:inline-flex; align-items:center; gap:10px;"><svg xmlns="http://www.w3.org/2000/svg" width="1.4em" height="1.4em" viewBox="0 0 24 24" style="vertical-align:middle;flex-shrink:0;"><circle cx="12" cy="12" r="12" fill="#6d28d9"/><rect x="6" y="13" width="3" height="5" rx="0.5" fill="white"/><rect x="10.5" y="9" width="3" height="9" rx="0.5" fill="white"/><rect x="15" y="11" width="3" height="7" rx="0.5" fill="white"/></svg><span style="color:#a78bfa;">[-]</span> Monthly <span style="color:#a78bfa;">/</span> <span style="color:#a78bfa;">[+]</span> Annual Cash Flow &amp; Profit Summary</h2>
                <button onclick="closeMonthlySummary()" style="background:#ef4444;color:white;border:none;padding:8px 14px;border-radius:8px;cursor:pointer;font-weight:bold;font-size:1rem;">‚úï Close</button>
            </div>
            <div id="monthlyTableContainer"></div>
        </div>
    </div>

    <!-- Assignments Modal -->
    <div id="assignmentsModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.75); z-index:1000; justify-content:center; align-items:center;">
        <div id="assignmentsInner" style="border-radius:16px; padding:20px; max-width:1600px; width:95vw; max-height:90vh; overflow-y:auto; position:relative; box-sizing:border-box;">
            <!-- Title + action buttons row -->
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; flex-wrap:wrap; gap:10px;">
                <h2 style="color: var(--text-primary); font-size:1.2rem; display:inline-flex; align-items:center; gap:10px;"><svg xmlns="http://www.w3.org/2000/svg" width="1.4em" height="1.4em" viewBox="0 0 24 24" style="vertical-align:middle;flex-shrink:0;"><circle cx="12" cy="12" r="12" fill="#f59e0b"/><path d="M8 7h8M8 11h8M8 15h5" stroke="white" stroke-width="2" stroke-linecap="round"/><circle cx="17" cy="16" r="3.5" fill="#f59e0b" stroke="white" stroke-width="1.5"/><path d="M16 16l.8.8 1.7-1.6" stroke="white" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg>Assignments</h2>
                <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
                    <button id="refreshAssignmentPricesBtn" onclick="refreshAssignmentPrices()" style="background:#f59e0b;color:white;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:bold;font-size:0.85rem;">üîÑ Refresh Prices</button>
                    <button onclick="closeAssignments()" style="background:#ef4444;color:white;border:none;padding:8px 14px;border-radius:8px;cursor:pointer;font-weight:bold;font-size:1rem;">‚úï Close</button>
                </div>
            </div>
            <!-- Summary boxes centered above filters -->
            <div id="assignSummaryBoxes" style="display:flex; justify-content:center; margin-bottom:10px;">
                <div style="padding:12px 20px; background:var(--bg-secondary); border-radius:10px; border:1px solid var(--border-color);">
                    <div id="assignSummaryInner" style="display:flex; flex-wrap:wrap; gap:8px; justify-content:center;">
                        <div style="font-size:0.75rem; color:var(--text-secondary); text-align:center;">‚Äî</div>
                    </div>
                </div>
            </div>

            <!-- Filters row -->
            <div style="display:flex; flex-wrap:wrap; gap:12px; align-items:flex-end; justify-content:center; margin-bottom:12px; padding:12px 16px; background:var(--bg-secondary); border-radius:10px; border:1px solid var(--border-color);">
                    <div>
                        <div style="font-size:0.75rem; font-weight:600; color:var(--text-secondary); margin-bottom:4px;">Quick Range</div>
                        <select id="assignDatePreset" onchange="setAssignmentQuickRange()" style="padding:7px 10px; border-radius:8px; border:2px solid var(--border-color); background:var(--bg-input); color:var(--text-primary); font-size:0.85rem; outline:none;">
                            <option value="all" selected>All</option>
                            <option value="today">Today</option>
                            <option value="7days">Last 7 Days</option>
                            <option value="currentMonth">Current Month</option>
                            <option value="lastMonth">Last Month</option>
                            <option value="currentYear">Current Year</option>
                            <option value="lastYear">Last Year</option>
                            <option value="last3Months">Last 3 Months</option>
                            <option value="last6Months">Last 6 Months</option>
                            <option value="last12Months">Last 12 Months</option>
                        </select>
                    </div>
                    <div>
                        <div style="font-size:0.75rem; font-weight:600; color:var(--text-secondary); margin-bottom:4px;">From Date</div>
                        <input type="date" id="assignDateFrom" onchange="renderAssignmentsTable()" style="padding:7px 10px; border-radius:8px; border:2px solid var(--border-color); background:var(--bg-input); color:var(--text-primary); font-size:0.85rem; outline:none;">
                    </div>
                    <div>
                        <div style="font-size:0.75rem; font-weight:600; color:var(--text-secondary); margin-bottom:4px;">To Date</div>
                        <input type="date" id="assignDateTo" onchange="renderAssignmentsTable()" style="padding:7px 10px; border-radius:8px; border:2px solid var(--border-color); background:var(--bg-input); color:var(--text-primary); font-size:0.85rem; outline:none;">
                    </div>
                    <div>
                        <div style="font-size:0.75rem; font-weight:600; color:var(--text-secondary); margin-bottom:4px;">Search Table</div>
                        <input id="assignmentSearch" type="text" placeholder="Search all columns..." oninput="renderAssignmentsTable()"
                            style="background:var(--bg-input);border:2px solid #f59e0b;color:var(--text-primary);padding:7px 12px;border-radius:8px;outline:none;font-size:0.85rem;width:150px;">
                    </div>
                    <div style="display:flex; flex-direction:column; gap:6px; align-items:flex-start;">
                        <div style="font-size:0.75rem; font-weight:600; color:transparent;">.</div>
                        <div style="display:flex; gap:8px; align-items:center;">
                            <label style="display:flex; align-items:center; gap:7px; cursor:pointer; font-size:0.85rem; font-weight:600; color:var(--text-primary); white-space:nowrap; padding:7px 10px; background:var(--bg-input); border:2px solid var(--border-color); border-radius:8px;">
                                <input type="checkbox" id="assignNotSoldFilter" onchange="renderAssignmentsTable()" style="width:15px;height:15px;cursor:pointer;accent-color:#f59e0b;">
                                Unsold
                            </label>
                            <label style="display:flex; align-items:center; gap:7px; cursor:pointer; font-size:0.85rem; font-weight:600; color:var(--text-primary); white-space:nowrap; padding:7px 10px; background:var(--bg-input); border:2px solid var(--border-color); border-radius:8px;">
                                <input type="checkbox" id="assignSoldFilter" onchange="renderAssignmentsTable()" style="width:15px;height:15px;cursor:pointer;accent-color:#4ade80;">
                                Sold
                            </label>
                        </div>
                    </div>
                    <div>
                        <div style="font-size:0.75rem; font-weight:600; color:transparent; margin-bottom:4px;">.</div>
                        <button onclick="resetAssignmentFilters()" style="background:#6d28d9;color:white;border:none;padding:7px 14px;border-radius:8px;cursor:pointer;font-weight:bold;font-size:0.85rem;">Reset Filters</button>
                    </div>
            </div>
            <div id="assignmentPriceTimestamp" style="font-size:0.75rem;color:var(--text-secondary);margin-bottom:16px;text-align:right;"></div>
            <div id="assignmentsContainer"></div>
        </div>
    </div>

    <div id="summary" class="stats" style="display:none;"></div>
    <div id="tableTopBar" style="display:none; justify-content:space-between; align-items:center; margin-bottom:8px; flex-wrap:wrap; gap:8px;">
        <input type="text" id="searchInput" placeholder="Search table..." oninput="applyFilters()"
            style="width:220px; padding:7px 12px; border-radius:8px; border:2px solid var(--border-color); background:var(--bg-input); color:var(--text-primary); font-size:0.9rem; outline:none;">
        <div style="display:flex; align-items:center; gap:16px;">
            <div id="dateRange" style="font-size:1rem; color:var(--text-secondary); font-weight:500;"></div>
            <label style="display:flex; align-items:center; gap:6px; cursor:pointer; font-size:1rem; color:var(--text-secondary); user-select:none; font-weight:500;">
                <input type="checkbox" id="showEntireTable" onchange="applyFilters()" style="width:15px;height:15px;cursor:pointer;accent-color:#10b981;">
                Show Entire Table
            </label>

        </div>
        <button onclick="downloadResults()" style="background:#10b981;color:white;border:none;padding:7px 16px;border-radius:8px;cursor:pointer;font-weight:bold;font-size:0.85rem;display:inline-flex;align-items:center;gap:6px;"><svg xmlns="http://www.w3.org/2000/svg" width="1.1em" height="1.1em" viewBox="0 0 24 24" style="vertical-align:middle;"><circle cx="12" cy="12" r="12" fill="#10b981"/><path d="M12 7v7m0 0l-3-3m3 3l3-3M8 17h8" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg> Download Results</button>
    </div>

    <div class="table-container" id="tableContainer" style="display:none;">
        <table>
            <thead><tr id="headerRow"></tr></thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<script>
let finalTrades = [];
let openPositions = [];
let currentFilteredData = [];
let sortKey = 'dte';
let sortDir = 1;
let columnWidths = {};
let uploadedDateRange = { min: null, max: null };

// Theme toggle
function toggleTheme() {
    const html = document.documentElement;
    const isDark = html.getAttribute('data-theme') === 'dark';
    html.setAttribute('data-theme', isDark ? 'light' : 'dark');
    document.getElementById('toggleEmoji').textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
    localStorage.setItem('theme', isDark ? 'light' : 'dark');
}

// Restore saved theme on load
(function() {
    const saved = localStorage.getItem('theme') || 'dark';
    document.documentElement.setAttribute('data-theme', saved);
    if (saved === 'light') {
        document.getElementById('toggleEmoji').textContent = 'üåô';
    }
})();

const dropZone = document.getElementById('dropZone');
const filePicker = document.getElementById('filePicker');
dropZone.onclick = () => filePicker.click();
filePicker.onchange = (e) => handleFile(e.target.files[0]);

async function handleFile(file) {
    if (!file) return;
    const fnEl = document.getElementById('uploadedFileName');
    fnEl.textContent = 'Filename: ' + file.name;
    fnEl.style.display = 'block';
    const mainFn = document.getElementById('mainFilename');
    mainFn.innerHTML = '<span style="color:var(--text-secondary);">Filename: </span><span style="color:#a78bfa;">' + file.name + '</span>';
    mainFn.style.display = 'block';

    document.getElementById('filterBar').style.display = 'flex';
    document.getElementById('actionButtons').style.display = 'flex';
    document.getElementById('summary').style.display = 'grid';
    document.getElementById('tableContainer').style.display = 'block';
    document.getElementById('tableTopBar').style.display = 'flex';
    // Hide upload box, show compact upload button
    document.getElementById('dropZone').style.display = 'none';
    document.getElementById('uploadBtn').style.display = 'inline-flex';
    const data = await file.arrayBuffer();
    sortKey = 'dte';
    sortDir = 1;
    ocSortKey = 'dte';
    ocSortDir = 1;
    const workbook = XLSX.read(data, { type: 'array' });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(sheet);
    process(json);
}

function parseDateString(dStr) {
    if (!dStr) return null;
    if (!isNaN(dStr) && typeof dStr !== 'string') {
        // Excel serial: days since 1900-01-01, convert to local midnight
        const serial = Number(dStr);
        const utcMs = (serial - 25569) * 86400 * 1000;
        const utcDate = new Date(utcMs);
        // Reconstruct as local midnight to avoid timezone shift
        return new Date(utcDate.getUTCFullYear(), utcDate.getUTCMonth(), utcDate.getUTCDate());
    }
    const parts = String(dStr).trim().split(/\s+/);
    const actualDateStr = parts[parts.length - 1];
    const match = actualDateStr.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/) ||
                  actualDateStr.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
    if (match) {
        let y, m, d;
        if (actualDateStr.includes('-')) {
            [, y, m, d] = match;
        } else {
            [, m, d, y] = match;
        }
        return new Date(parseInt(y), parseInt(m) - 1, parseInt(d));
    }
    const d = new Date(actualDateStr);
    return isNaN(d.getTime()) ? null : d;
}

// US market holidays (YYYY-MM-DD). Extend this list as needed.
const US_MARKET_HOLIDAYS = new Set([
    // 2024
    '2024-01-01','2024-01-15','2024-02-19','2024-03-29','2024-05-27',
    '2024-06-19','2024-07-04','2024-09-02','2024-11-28','2024-12-25',
    // 2025
    '2025-01-01','2025-01-09','2025-01-20','2025-02-17','2025-04-18',
    '2025-05-26','2025-06-19','2025-07-04','2025-09-01','2025-11-27',
    '2025-12-25',
    // 2026
    '2026-01-01','2026-01-19','2026-02-16','2026-04-03','2026-05-25',
    '2026-06-19','2026-07-03','2026-09-07','2026-11-26','2026-12-25',
]);

function isMarketHoliday(date) {
    const yyyy = date.getFullYear();
    const mm = String(date.getMonth() + 1).padStart(2, '0');
    const dd = String(date.getDate()).padStart(2, '0');
    return US_MARKET_HOLIDAYS.has(`${yyyy}-${mm}-${dd}`);
}

function nextSettlementDate(date) {
    const d = new Date(date);
    d.setDate(d.getDate() + 1);
    while (d.getDay() === 0 || d.getDay() === 6 || isMarketHoliday(d)) {
        d.setDate(d.getDate() + 1);
    }
    return d;
}

function cleanNum(val) {
    if (val === undefined || val === null || val === "") return 0;
    let str = String(val).replace(/[$\s,]/g, '');
    if (str.startsWith('(') && str.endsWith(')')) str = '-' + str.substring(1, str.length - 1);
    return parseFloat(str) || 0;
}

function fmtDateMMDDYYYY(d) {
    if (!d) return '';
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    const y = d.getFullYear();
    return `${m}/${day}/${y}`;
}

function process(rows) {
    const inventory = {};
    const realized = [];
    const allTransactions = [];

    // Store ALL rows (with parsed dates) before any Symbol/date filtering
    window.allRawRows = rows.map(r => {
        const raw = parseDateString(r.Date);
        const parsedDate = raw || null;
        const rawDateFormatted = fmtDateMMDDYYYY(raw);
        return { ...r, parsedDate, transactionDate: raw, rawDateFormatted };
    });

    const sortedRows = rows
        .map(r => {
            const raw = parseDateString(r.Date);
            const parsedDate = raw || null;
            const rawDateFormatted = fmtDateMMDDYYYY(raw);
            return { ...r, parsedDate, transactionDate: raw, rawDateFormatted };
        })
        .filter(r => (r.Symbol || '').trim() && r.parsedDate)
        .sort((a, b) => {
            const dateCompare = a.parsedDate - b.parsedDate;
            if (dateCompare !== 0) return dateCompare;
            const aIsOpen = (a.Action || "").toLowerCase().includes('to open');
            const bIsOpen = (b.Action || "").toLowerCase().includes('to open');
            if (aIsOpen && !bIsOpen) return -1;
            if (!aIsOpen && bIsOpen) return 1;
            return 0;
        });

    const allDatedRows = window.allRawRows.filter(r => r.parsedDate);
    if (allDatedRows.length > 0) {
        const times = allDatedRows.map(r => r.parsedDate.getTime());
        uploadedDateRange.min = new Date(Math.min(...times));
        uploadedDateRange.max = new Date(Math.max(...times));
    } else if (sortedRows.length > 0) {
        uploadedDateRange.min = sortedRows[0].parsedDate;
        uploadedDateRange.max = sortedRows[sortedRows.length - 1].parsedDate;
    }

    sortedRows.forEach(row => {
        const sym = (row.Symbol || '').trim();
        const action = (row.Action || "").toLowerCase();
        const qty = Math.abs(cleanNum(row.Quantity));
        const amt = cleanNum(row.Amount);

        if (!inventory[sym]) inventory[sym] = [];

        if (action.includes('to open')) {
            inventory[sym].push({ date: row.parsedDate, transactionDate: row.transactionDate, rawDateFormatted: row.rawDateFormatted || '', qty, premium: amt, status: action });
            allTransactions.push({ date: row.parsedDate, action, amount: amt });
        }
        else if (action.includes('to close') || action.includes('expired') || action.includes('assigned')) {
            allTransactions.push({ date: row.parsedDate, action, amount: amt });

            let remainingToClose = qty || 0;
            if (remainingToClose === 0 && inventory[sym].length > 0) {
                remainingToClose = inventory[sym].reduce((sum, item) => sum + item.qty, 0);
            }

            let openingPremiumUsed = 0;
            let firstOpenDate = row.parsedDate;
            let firstOpenRawDate = row.rawDateFormatted || '';
            let firstOpenTransactionDate = row.transactionDate;

            while (remainingToClose > 0 && inventory[sym].length > 0) {
                let earliest = inventory[sym][0];
                let qtyFromThisOpening = Math.min(remainingToClose, earliest.qty);
                let sliceOpeningPremium = (earliest.premium / earliest.qty) * qtyFromThisOpening;
                openingPremiumUsed += sliceOpeningPremium;
                firstOpenDate = earliest.date;
                firstOpenRawDate = earliest.rawDateFormatted || '';
                firstOpenTransactionDate = earliest.transactionDate;
                earliest.premium -= sliceOpeningPremium;
                earliest.qty -= qtyFromThisOpening;
                remainingToClose -= qtyFromThisOpening;
                if (earliest.qty <= 0) inventory[sym].shift();
            }

            let actualClosingCost = (action.includes('expired') || action.includes('assigned')) ? 0 : amt;

            const symPutMatch = sym.match(/[\d.]+\s+P\s*$/);
            const symCallMatch = sym.match(/[\d.]+\s+C\s*$/);
            const putOrCall = symPutMatch ? 'Put' : symCallMatch ? 'Call' : '‚Äî';

            // For calls that are "assigned" (shares called away), use "Called Away" to distinguish from put assignments
            let rawStatus = action.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
            if (action.includes('assigned') && symCallMatch) rawStatus = 'Called Away';

            realized.push({
                symbol: sym,
                putOrCall,
                contracts: qty || (openingPremiumUsed > 0 ? "All" : 0),
                openingPremium: openingPremiumUsed,
                closingPremium: actualClosingCost,
                profit: openingPremiumUsed + actualClosingCost,
                openDate: firstOpenDate,
                closeDate: row.parsedDate,
                transactionDate: row.transactionDate,
                rawDate: row.rawDateFormatted || '',
                status: rawStatus,
                isOpen: false
            });
        }
    });

    const openPos = [];
    for (const sym in inventory) {
        inventory[sym].forEach(item => {
            if (item.status.includes('sell') && item.status.includes('open')) {
                const opPutMatch = sym.match(/[\d.]+\s+P\s*$/);
                const opCallMatch = sym.match(/[\d.]+\s+C\s*$/);
                openPos.push({
                    symbol: sym,
                    putOrCall: opPutMatch ? 'Put' : opCallMatch ? 'Call' : '‚Äî',
                    contracts: item.qty,
                    openingPremium: item.premium,
                    closingPremium: 0,
                    profit: 0,
                    openDate: item.date,
                    closeDate: item.date,
                    transactionDate: item.transactionDate,
                    rawDate: item.rawDateFormatted || '',
                    status: 'Sell to Open',
                    isOpen: true
                });
            }
        });
    }

    finalTrades = realized;
    openPositions = openPos;
    window.allTransactions = allTransactions;
    window.rawRows = sortedRows;
    setQuickRange();
}

function applyFilters() {
    const showAll = document.getElementById('showEntireTable')?.checked;
    if (showAll) {
        renderRawTable();
        return;
    }

    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const startVal = document.getElementById('startDate').value;
    const endVal = document.getElementById('endDate').value;
    const startDate = startVal ? new Date(startVal + "T00:00:00") : null;
    const endDate = endVal ? new Date(endVal + "T23:59:59") : null;
    const activeStatuses = Array.from(document.querySelectorAll('#statusCheckboxes input:checked')).map(cb => cb.value.toLowerCase());

    const allItems = [...finalTrades, ...openPositions];
    const filtered = allItems.filter(item => {
        if (searchTerm) {
            const dateStr = (item.isOpen ? item.openDate : item.closeDate) ? fmtDateMMDDYYYY(item.isOpen ? item.openDate : item.closeDate) : '';
            const matchesSearch =
                item.symbol.toLowerCase().includes(searchTerm) ||
                item.status.toLowerCase().includes(searchTerm) ||
                (item.putOrCall || '').toLowerCase().includes(searchTerm) ||
                String(item.contracts).includes(searchTerm) ||
                dateStr.includes(searchTerm) ||
                String(item.openingPremium?.toFixed(2) || '').includes(searchTerm) ||
                String(item.profit?.toFixed(2) || '').includes(searchTerm);
            if (!matchesSearch) return false;
        }
        const matchesStatus = activeStatuses.includes(item.status.toLowerCase());
        const dateToFilter = item.transactionDate || (item.isOpen ? item.openDate : item.closeDate);
        let matchesDate = true;
        if (startDate && dateToFilter < startDate) matchesDate = false;
        if (endDate && dateToFilter > endDate) matchesDate = false;
        return matchesStatus && matchesDate;
    });

    currentFilteredData = filtered;
    render(null, filtered);
}

let rawSortKey = 'date';
let rawSortDir = -1;

function sortRawTable(key) {
    if (rawSortKey === key) rawSortDir *= -1;
    else { rawSortKey = key; rawSortDir = 1; }
    renderRawTable();
}

function renderRawTable() {
    if (!window.allRawRows) return;
    const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
    let rows = window.allRawRows.filter(r => {
        if (!searchTerm) return true;
        const sym = (r.Symbol || '').toLowerCase();
        const action = (r.Action || '').toLowerCase();
        const desc = (r.Description || '').toLowerCase();
        return sym.includes(searchTerm) || action.includes(searchTerm) || desc.includes(searchTerm);
    });

    // Sort
    rows = [...rows].sort((a, b) => {
        let v1, v2;
        switch (rawSortKey) {
            case 'date':     v1 = a.parsedDate ? a.parsedDate.getTime() : 0; v2 = b.parsedDate ? b.parsedDate.getTime() : 0; break;
            case 'symbol':   v1 = (a.Symbol || '').toLowerCase(); v2 = (b.Symbol || '').toLowerCase(); break;
            case 'action':   v1 = (a.Action || '').toLowerCase(); v2 = (b.Action || '').toLowerCase(); break;
            case 'amount':   v1 = cleanNum(a.Amount); v2 = cleanNum(b.Amount); break;
            case 'quantity': v1 = parseFloat(a.Quantity) || 0; v2 = parseFloat(b.Quantity) || 0; break;
            case 'price':    v1 = parseFloat(a.Price) || 0; v2 = parseFloat(b.Price) || 0; break;
            case 'desc':     v1 = (a.Description || '').toLowerCase(); v2 = (b.Description || '').toLowerCase(); break;
            default: v1 = 0; v2 = 0;
        }
        if (v1 < v2) return -rawSortDir;
        if (v1 > v2) return rawSortDir;
        return 0;
    });

    const arrow = (key) => rawSortKey === key ? (rawSortDir === 1 ? ' ‚ñ≤' : ' ‚ñº') : ' ‚Üï';
    const rawDateColLabel = 'Date';

    // Reuse existing table with remapped columns
    const cols = [
        { lab: rawDateColLabel, key: 'date' },
        { lab: 'Action',           key: 'action' },
        { lab: 'Symbol',           key: 'symbol' },
        { lab: 'Description',      key: 'desc' },
        { lab: 'Quantity',         key: 'quantity' },
        { lab: 'Price',            key: 'price' },
        { lab: 'Amount',           key: 'amount' },
        { lab: '',                 key: '' },
        { lab: '',                 key: '' },
    ];

    document.getElementById('headerRow').innerHTML = cols.map((c, i) =>
        `<th data-col-index="${i}" ${c.key ? `onclick="sortRawTable('${c.key}')"` : ''} style="${columnWidths[i] ? 'width:' + columnWidths[i] + 'px; min-width:' + columnWidths[i] + 'px;' : ''}cursor:${c.key ? 'pointer' : 'default'};">${c.lab}${c.key ? arrow(c.key) : ''}<div class="resizer"></div></th>`
    ).join('');

    document.querySelectorAll('.resizer').forEach((resizer) => {
        let startX, startWidth;
        resizer.addEventListener('mousedown', (e) => {
            e.stopPropagation();
            startX = e.pageX;
            const th = resizer.parentElement;
            startWidth = th.offsetWidth;
            const onMouseMove = (e) => { th.style.width = (startWidth + e.pageX - startX) + 'px'; th.style.minWidth = th.style.width; };
            const onMouseUp = () => {
                columnWidths[th.getAttribute('data-col-index')] = th.offsetWidth;
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            };
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        });
    });

    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    const amtPosColor = isDark ? '#4ade80' : '#16a34a';
    const amtNegColor = isDark ? '#f87171' : '#dc2626';

    document.getElementById('tableBody').innerHTML = rows.map(r => {
        const amt = cleanNum(r.Amount);
        const amtColor = amt >= 0 ? amtPosColor : amtNegColor;
        const amtDisplay = r.Amount ? (amt >= 0 ? '$' : '-$') + Math.abs(amt).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2}) : '';
        const priceDisplay = r.Price ? '$' + parseFloat(r.Price).toFixed(2) : '';
        return `<tr>
            <td>${r.parsedDate ? fmtDateMMDDYYYY(r.parsedDate) : (r.rawDateFormatted || '')}</td>
            <td><span class="tag">${r.Action || ''}</span></td>
            <td>${r.Symbol || ''}</td>
            <td>${r.Description || ''}</td>
            <td>${r.Quantity || ''}</td>
            <td>${priceDisplay}</td>
            <td class="${amt >= 0 ? 'pos' : 'neg'}">${amtDisplay}</td>
            <td></td>
            <td></td>
        </tr>`;
    }).join('');
}

function calcDTE(symbol) {
    const match = symbol.match(/(\d{1,2}\/\d{1,2}\/\d{4})/);
    if (!match) return '';
    const exp = new Date(match[1]);
    exp.setHours(0, 0, 0, 0);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const diff = Math.round((exp - today) / (1000 * 60 * 60 * 24));
    return diff > 0 ? diff : '';
}

function sortBy(key) {
    if (sortKey === key) sortDir *= -1;
    else { sortKey = key; sortDir = 1; }
    render(null, null);
}

function render(newSortKey, dataToRender) {
    const displayData = dataToRender ? [...dataToRender] : [...currentFilteredData];

    displayData.sort((a, b) => {
        let v1, v2;

        if (sortKey === 'dte') {
            const getDTE = sym => {
                const m = sym.match(/(\d{1,2}\/\d{1,2}\/\d{4})/);
                if (!m) return null;
                const diff = Math.round((new Date(m[1]) - new Date()) / (1000 * 60 * 60 * 24));
                return diff > 0 ? diff : null;
            };
            const d1 = a.isOpen ? getDTE(a.symbol) : null;
            const d2 = b.isOpen ? getDTE(b.symbol) : null;
            if (d1 === null && d2 === null) return 0;
            if (d1 === null) return 1;
            if (d2 === null) return -1;
            return (d1 - d2) * sortDir;
        }
        else if (sortKey === 'openingPremium') {
            v1 = a.status.toLowerCase().includes('buy') && a.status.toLowerCase().includes('close') ? a.closingPremium : a.openingPremium;
            v2 = b.status.toLowerCase().includes('buy') && b.status.toLowerCase().includes('close') ? b.closingPremium : b.openingPremium;
        }
        else if (sortKey === 'returnPct') {
            v1 = a.status.toLowerCase().includes('expired') ? 100
                : (a.status.toLowerCase().includes('buy') && a.status.toLowerCase().includes('close') && (a.profit + Math.abs(a.closingPremium)) !== 0)
                ? (a.profit / (a.profit + Math.abs(a.closingPremium))) * 100 : -Infinity;
            v2 = b.status.toLowerCase().includes('expired') ? 100
                : (b.status.toLowerCase().includes('buy') && b.status.toLowerCase().includes('close') && (b.profit + Math.abs(b.closingPremium)) !== 0)
                ? (b.profit / (b.profit + Math.abs(b.closingPremium))) * 100 : -Infinity;
        }
        else {
            v1 = a[sortKey];
            v2 = b[sortKey];
        }

        if (v1 instanceof Date) { v1 = v1.getTime(); v2 = v2.getTime(); }
        return v1 < v2 ? -sortDir : v1 > v2 ? sortDir : 0;
    });

    const closedTrades = displayData.filter(x => !x.isOpen).length;
    const openTrades = displayData.filter(x => x.isOpen).length;

    const startVal = document.getElementById('startDate').value;
    const endVal = document.getElementById('endDate').value;
    const startDate = startVal ? new Date(startVal + "T00:00:00") : null;
    const endDate = endVal ? new Date(endVal + "T23:59:59") : null;
    const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();

    // Cash Flow: STO received and BTC paid within date range (by transaction date)
    let sellToOpen = 0, buyToClose = 0;
    if (window.rawRows) {
        window.rawRows.forEach(r => {
            const sym = (r.Symbol || '').toLowerCase();
            if (searchTerm && !sym.includes(searchTerm)) return;
            const action = (r.Action || '').toLowerCase();
            const d = r.parsedDate;
            if (!d) return;
            if (startDate && d < startDate) return;
            if (endDate && d > endDate) return;
            const amt = cleanNum(r.Amount);
            if (action.includes('sell') && action.includes('to open')) sellToOpen += amt;
            if (action.includes('buy') && action.includes('to close')) buyToClose += amt;
        });
    }
    const cashFlow = sellToOpen - Math.abs(buyToClose);

    // Realized P/L: profit on closed non-assigned trades, by close date, respecting status filters
    const activeStatuses = Array.from(document.querySelectorAll('#statusCheckboxes input:checked')).map(cb => cb.value.toLowerCase());
    let reconPL = 0;
    finalTrades.forEach(x => {
        const sym = x.symbol.toLowerCase();
        if (searchTerm && !sym.includes(searchTerm)) return;
        const st = x.status.toLowerCase();
        if (st.includes('assigned')) return;
        if (!activeStatuses.includes(st)) return;
        const d = x.closeDate;
        if (startDate && d < startDate) return;
        if (endDate && d > endDate) return;
        reconPL += x.profit || 0;
    });

    // Assigned Premium: opening premiums on assigned puts, by assignment (close) date
    let reconAssigned = 0;
    finalTrades.forEach(x => {
        const sym = x.symbol.toLowerCase();
        if (searchTerm && !sym.includes(searchTerm)) return;
        if (!x.status.toLowerCase().includes('assigned')) return;
        const d = x.closeDate;
        if (startDate && d < startDate) return;
        if (endDate && d > endDate) return;
        reconAssigned += Math.abs(x.openingPremium || 0);
    });

    // Open Premium: premiums on currently open positions (always unfiltered by date ‚Äî these are live)
    let reconOpen = 0;
    openPositions.forEach(x => {
        const sym = x.symbol.toLowerCase();
        if (searchTerm && !sym.includes(searchTerm)) return;
        reconOpen += x.openingPremium || 0;
    });

    const assignedPremium = reconAssigned;

    document.getElementById('summary').innerHTML = `
        <div class="stat-card"><div class="stat-label">Sell to Open</div><div class="stat-value pos">$${sellToOpen.toLocaleString(undefined,{minimumFractionDigits:2})}</div></div>
        <div class="stat-card"><div class="stat-label">Buy to Close</div><div class="stat-value neg">$${Math.abs(buyToClose).toLocaleString(undefined,{minimumFractionDigits:2})}</div></div>
        <div class="stat-card"><div class="stat-label">Cash Flow</div><div class="stat-value ${cashFlow >= 0 ? 'pos' : 'neg'}">$${cashFlow.toLocaleString(undefined,{minimumFractionDigits:2})}</div></div>
        <div class="stat-card"><div class="stat-label">Realized Profit / Loss</div><div class="stat-value ${reconPL >= 0 ? 'pos' : 'neg'}">$${reconPL.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}</div></div>
        <div class="stat-card"><div class="stat-label">Open Premium</div><div class="stat-value waiting">$${reconOpen.toLocaleString(undefined,{minimumFractionDigits:2})}</div></div>
        <div class="stat-card"><div class="stat-label">Assigned Premium</div><div class="stat-value" style="color:#f59e0b;">$${reconAssigned.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}</div></div>
        <div class="stat-card"><div class="stat-label">Closed Trades</div><div class="stat-value">${closedTrades}</div></div>
        <div class="stat-card"><div class="stat-label">Open Positions</div><div class="stat-value waiting">${openTrades}</div></div>
    `;

    if (uploadedDateRange.min && uploadedDateRange.max) {
        document.getElementById('dateRange').innerHTML = `<span style="display:inline-flex;align-items:center;gap:6px;">Available Date Range: <span style="font-weight:600;">${fmtDateMMDDYYYY(uploadedDateRange.min)}</span><span style="font-size:2em;line-height:1;position:relative;top:-0.05em;">‚Üí</span><span style="font-weight:600;">${fmtDateMMDDYYYY(uploadedDateRange.max)}</span></span>`;
    }

    const dateColLabel = 'Date';

    const cols = [
        {lab: dateColLabel, key:'closeDate'},
        {lab:'Symbol',key:'symbol'},
        {lab:'Put Or Call',key:'putOrCall'},
        {lab:'# Of Contracts',key:'contracts'},
        {lab:'Days Till Expiration',key:'dte'},
        {lab:'Action',key:'status'},
        {lab:'Premium Received / Paid',key:'openingPremium'},
        {lab:'Profit / Loss',key:'profit'},
        {lab:'% Return',key:'returnPct'}
    ];

    document.getElementById('headerRow').innerHTML = cols.map((c, i) =>
        `<th data-col-index="${i}" onclick="sortBy('${c.key}')" style="${columnWidths[i] ? 'width:' + columnWidths[i] + 'px; min-width:' + columnWidths[i] + 'px;' : ''}">${c.lab} ‚Üï<div class="resizer"></div></th>`
    ).join('');

    document.querySelectorAll('.resizer').forEach((resizer) => {
        let startX, startWidth;
        resizer.addEventListener('mousedown', (e) => {
            e.stopPropagation();
            startX = e.pageX;
            const th = resizer.parentElement;
            startWidth = th.offsetWidth;
            const onMouseMove = (e) => { th.style.width = (startWidth + e.pageX - startX) + 'px'; th.style.minWidth = th.style.width; };
            const onMouseUp = () => {
                columnWidths[th.getAttribute('data-col-index')] = th.offsetWidth;
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            };
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        });
    });

    document.getElementById('tableBody').innerHTML = displayData.map(p => {
        let returnPct = '', returnClass = '';
        if (p.status.toLowerCase().includes('buy') && p.status.toLowerCase().includes('close')) {
            const denom = p.profit + Math.abs(p.closingPremium);
            if (denom !== 0 && isFinite(denom)) {
                const pct = (p.profit / denom) * 100;
                returnPct = pct.toFixed(2) + '%';
                returnClass = pct >= 0 ? 'pos' : 'neg';
            } else { returnPct = 'N/A'; }
        } else if (p.status.toLowerCase().includes('expired')) {
            returnPct = '100.00%'; returnClass = 'pos';
        }

        const premVal = p.status.toLowerCase().includes('buy') && p.status.toLowerCase().includes('close') ? p.closingPremium : p.openingPremium;
        const premClass = premVal >= 0 ? 'pos' : 'neg';

        return `
        <tr>
            <td>${fmtDateMMDDYYYY(p.isOpen ? p.openDate : p.closeDate)}</td>
            <td>${p.symbol}</td>
            <td style="color:${p.putOrCall === 'Put' ? '#f87171' : p.putOrCall === 'Call' ? '#4ade80' : 'inherit'};font-weight:600;">${p.putOrCall}</td>
            <td>${p.contracts}</td>
            <td>${p.isOpen ? calcDTE(p.symbol) : ''}</td>
            <td><span class="tag ${p.isOpen ? 'tag-waiting' : ''}">${p.status}</span></td>
            <td class="${premClass}">$${premVal.toLocaleString(undefined,{minimumFractionDigits:2})}</td>
            <td class="${p.isOpen ? 'waiting' : (p.profit >= 0 ? 'pos' : 'neg')}">${p.isOpen ? 'Waiting to close' : '$' + p.profit.toLocaleString(undefined,{minimumFractionDigits:2})}</td>
            <td class="${returnClass}">${returnPct}</td>
        </tr>`;
    }).join('');
}

function toISODate(d) { return d.toISOString().split('T')[0]; }

function setQuickRange() {
    const range = document.getElementById('quickRange').value;
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    let start = new Date(today), end = new Date();
    end.setHours(23, 59, 59, 999);

    switch(range) {
        case 'today': break;
        case '7days': start.setDate(today.getDate() - 6); break;
        case 'lastMonth': start = new Date(today.getFullYear(), today.getMonth() - 1, 1); end = new Date(today.getFullYear(), today.getMonth(), 0); break;
        case 'last3Months': start = new Date(today.getFullYear(), today.getMonth() - 3, 1); end = new Date(today.getFullYear(), today.getMonth(), 0); break;
        case 'last6Months': start = new Date(today.getFullYear(), today.getMonth() - 6, 1); end = new Date(today.getFullYear(), today.getMonth(), 0); break;
        case 'last12Months': start = new Date(today.getFullYear(), today.getMonth() - 12, 1); end = new Date(today.getFullYear(), today.getMonth(), 0); break;
        case 'lastYear': start = new Date(today.getFullYear() - 1, 0, 1); end = new Date(today.getFullYear() - 1, 11, 31); break;
        case 'currentMonth': start = new Date(today.getFullYear(), today.getMonth(), 1); end = new Date(); end.setHours(23,59,59,999); break;
        case 'currentYear': start = new Date(today.getFullYear(), 0, 1); end = new Date(); end.setHours(23,59,59,999); break;
        case 'all': default: start = null; end = null; break;
    }

    document.getElementById('startDate').value = start ? toISODate(start) : '';
    document.getElementById('endDate').value = end ? toISODate(end) : '';
    applyFilters();
}

function resetFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('quickRange').value = 'all';
    document.getElementById('startDate').value = '';
    document.getElementById('endDate').value = '';
    document.querySelectorAll('#statusCheckboxes input').forEach(cb => { cb.checked = (cb.value !== 'Assigned'); });
    applyFilters();
}

function downloadResults() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const startVal = document.getElementById('startDate').value;
    const endVal = document.getElementById('endDate').value;
    const startDate = startVal ? new Date(startVal + "T00:00:00") : null;
    const endDate = endVal ? new Date(endVal + "T23:59:59") : null;
    const activeStatuses = Array.from(document.querySelectorAll('#statusCheckboxes input:checked')).map(cb => cb.value.toLowerCase());

    const filtered = [...finalTrades, ...openPositions].filter(item => {
        const matchesSearch = item.symbol.toLowerCase().includes(searchTerm);
        const matchesStatus = activeStatuses.includes(item.status.toLowerCase());
        const dateToFilter = item.transactionDate || (item.isOpen ? item.openDate : item.closeDate);
        let matchesDate = true;
        if (startDate && dateToFilter < startDate) matchesDate = false;
        if (endDate && dateToFilter > endDate) matchesDate = false;
        return matchesSearch && matchesStatus && matchesDate;
    });

    let csv = 'Date,Symbol,Put or Call,Quantity,Days Till Expiration,Action,Premium Received / Paid,Profit / Loss,% Return\n';
    filtered.forEach(p => {
        const date = p.isOpen ? fmtDateMMDDYYYY(p.openDate) : fmtDateMMDDYYYY(p.closeDate);
        const premium = p.status.toLowerCase().includes('buy') && p.status.toLowerCase().includes('close') ? p.closingPremium : p.openingPremium;
        const pl = p.isOpen ? 'Waiting to close' : p.profit.toFixed(2);
        const dte = p.isOpen ? calcDTE(p.symbol) : '';
        let returnPct = '';
        if (p.status.toLowerCase().includes('buy') && p.status.toLowerCase().includes('close')) {
            const denom = p.profit + Math.abs(p.closingPremium);
            if (denom !== 0) returnPct = ((p.profit / denom) * 100).toFixed(2) + '%';
        } else if (p.status.toLowerCase().includes('expired')) { returnPct = '100.00%'; }
        csv += `${date},${p.symbol},${p.putOrCall},${p.contracts},${dte},${p.status},${premium.toFixed(2)},${pl},${returnPct}\n`;
    });

    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `options-results-${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

function toggleMonthlyYear(year) {
    const monthRows = document.querySelectorAll(`.mb-year-${year}`);
    const collapsedRow = document.querySelector(`.mb-year-collapsed-${year}`);
    if (!monthRows.length || !collapsedRow) return;
    const isExpanded = monthRows[0].style.display !== 'none';
    monthRows.forEach(r => r.style.display = isExpanded ? 'none' : 'table-row');
    collapsedRow.style.display = isExpanded ? 'table-row' : 'none';
    // Update button icons (there are two buttons with same id - query by class parent)
    document.querySelectorAll(`#mbtn-${year}`).forEach(btn => {
        btn.textContent = isExpanded ? '‚ûï' : '‚ûñ';
        btn.title = isExpanded ? `Expand ${year}` : `Collapse ${year}`;
    });
}

function closeMonthlySummary() {
    const _di = document.getElementById('monthlyInner'); if (_di) _di._dragInit = false;
    document.getElementById('monthlyModal').style.display = 'none';
}

function closeOpenCommitments() {
    const _di = document.getElementById('ocInner'); if (_di) _di._dragInit = false;
    document.getElementById('openCommitmentsModal').style.display = 'none';
    const modalInner = document.querySelector('#openCommitmentsModal > div');
    if (modalInner && modalInner._ocScrollHandler) {
        modalInner.removeEventListener('scroll', modalInner._ocScrollHandler);
        delete modalInner._ocScrollHandler;
    }
}

// Finnhub API key (embedded)
const FINNHUB_API_KEY = "d6bjguhr01qp4lhvmct0d6bjguhr01qp4lhvmctg";

// State for Open Commitments sort
let ocSortKey = 'dte';
let ocSortDir = 1;
let ocSearchValue = '';
let ocParsedRows = [];
let ocStockPrices = {};   // { TICKER: { price, change, changePct, loading, error } }
let ocPriceFetchTime = null;

// Extract root ticker from Schwab option symbol e.g. "AAPL 01/17/2025 185.00 P" -> "AAPL"
function extractTicker(symbol) {
    return symbol.trim().split(/\s+/)[0].toUpperCase();
}

function saveFinnhubKey() {
    const key = document.getElementById('finnhubKeyInput').value.trim();
    if (!key) { alert('Please enter a Finnhub API key.'); return; }
    // key embedded in code
    const bar = document.getElementById('apiKeyBar');
    if (bar) {
        bar.style.borderColor = '#10b981';
        bar.style.background = 'rgba(16,185,129,0.1)';
    }
    const ts = document.getElementById('priceTimestamp');
    if (ts) ts.textContent = '‚úÖ Key saved! Click Refresh Prices to load quotes.';
}

function loadSavedFinnhubKey() {
    const saved = FINNHUB_API_KEY;
    const input = document.getElementById('finnhubKeyInput');
    if (saved && input) {
        input.value = saved;
        const bar = document.getElementById('apiKeyBar');
        if (bar) { bar.style.borderColor = '#10b981'; bar.style.background = 'rgba(16,185,129,0.1)'; }
    }
}

async function testFinnhubKey() {
    const input = document.getElementById('finnhubKeyInput');
    const key = (input?.value || '').trim();
    const ts = document.getElementById('priceTimestamp');
    if (!key) { if (ts) ts.textContent = '‚ö†Ô∏è Enter a key first.'; return; }
    if (ts) ts.textContent = 'üß™ Testing key with AAPL‚Ä¶';
    try {
        const url = `https://finnhub.io/api/v1/quote?symbol=AAPL&token=${encodeURIComponent(key)}`;
        const res = await fetch(url);
        const text = await res.text();
        let parsed;
        try { parsed = JSON.parse(text); } catch(e) { parsed = null; }
        if (!res.ok) {
            if (ts) ts.innerHTML = `<span style="color:#f87171;">‚ùå HTTP ${res.status} ‚Äî Raw response: <code>${text.substring(0,200)}</code></span>`;
            return;
        }
        if (!parsed) {
            if (ts) ts.innerHTML = `<span style="color:#f87171;">‚ùå Could not parse JSON. Raw: <code>${text.substring(0,200)}</code></span>`;
            return;
        }
        if (parsed.error) {
            if (ts) ts.innerHTML = `<span style="color:#f87171;">‚ùå Finnhub error: "${parsed.error}"</span>`;
            return;
        }
        if (!parsed.c || parsed.c === 0) {
            if (ts) ts.innerHTML = `<span style="color:#fbbf24;">‚ö†Ô∏è Key accepted but no price data. Raw: <code>${JSON.stringify(parsed)}</code></span>`;
            return;
        }
        // Key works!
        // key embedded in code
        const bar = document.getElementById('apiKeyBar');
        if (bar) { bar.style.borderColor = '#10b981'; bar.style.background = 'rgba(16,185,129,0.1)'; }
        if (ts) ts.innerHTML = `<span style="color:#4ade80;">‚úÖ Key works! AAPL = $${parsed.c.toFixed(2)} (change: ${parsed.d >= 0 ? '+' : ''}${parsed.d?.toFixed(2)}, ${parsed.dp?.toFixed(2)}%). Key saved ‚Äî click Refresh Prices.</span>`;
    } catch(e) {
        if (ts) ts.innerHTML = `<span style="color:#f87171;">‚ùå Network error: ${e.message}. Are you opening this file from your local disk (file://)? Try hosting it locally with a simple server.</span>`;
    }
}

async function fetchSinglePrice(ticker) {
    const key = FINNHUB_API_KEY;
    if (!key) throw new Error('No API key saved');

    const url = `https://finnhub.io/api/v1/quote?symbol=${ticker}&token=${encodeURIComponent(key)}`;
    const res = await fetch(url);
    if (!res.ok) {
        const txt = await res.text().catch(() => '');
        throw new Error(`HTTP ${res.status}: ${txt.substring(0, 80)}`);
    }
    const json = await res.json();
    if (json.error) throw new Error(`Finnhub: ${json.error}`);
    if (!json.c || json.c === 0) throw new Error(`No price data (response: ${JSON.stringify(json).substring(0,80)})`);
    const price = json.c;
    const change = json.d ?? (price - (json.pc || price));
    const changePct = json.dp ?? (json.pc ? (change / json.pc) * 100 : 0);
    return { price, change, changePct };
}

async function refreshStockPrices() {
    if (!ocParsedRows.length) return;

    const key = FINNHUB_API_KEY;
    if (!key) {
        const ts = document.getElementById('priceTimestamp');
        if (ts) ts.textContent = '‚ö†Ô∏è Please enter and save your Finnhub API key above first.';
        document.getElementById('finnhubKeyInput')?.focus();
        return;
    }

    const tickers = [...new Set(ocParsedRows.map(r => extractTicker(r.symbol)))];

    // Mark all as loading
    tickers.forEach(t => { ocStockPrices[t] = { loading: true }; });
    renderOpenCommitmentsTable();

    const ts = document.getElementById('priceTimestamp');
    if (ts) ts.textContent = `Fetching prices for: ${tickers.join(', ')}‚Ä¶`;

    // Fetch sequentially to respect Finnhub free-tier rate limit (60 req/min)
    for (const ticker of tickers) {
        try {
            const data = await fetchSinglePrice(ticker);
            ocStockPrices[ticker] = { ...data, loading: false, error: false };
        } catch(e) {
            ocStockPrices[ticker] = { loading: false, error: true, errMsg: e.message };
        }
        renderOpenCommitmentsTable();
        if (tickers.length > 1) await new Promise(r => setTimeout(r, 150)); // small delay between calls
    }

    ocPriceFetchTime = new Date();
    renderOpenCommitmentsTable();
}

function showOpenCommitments() {
    if (!openPositions || openPositions.length === 0) {
        alert('No open positions found. Please upload a file first.');
        return;
    }

    // Parse each open position once
    ocParsedRows = openPositions.map(p => {
        const sym = p.symbol.trim();
        const putMatch = sym.match(/([\d.]+)\s+P\s*$/);
        const callMatch = sym.match(/([\d.]+)\s+C\s*$/);
        const isPut = !!putMatch;
        const isCall = !!callMatch;
        const strike = isPut ? parseFloat(putMatch[1]) : isCall ? parseFloat(callMatch[1]) : null;
        const contracts = parseFloat(p.contracts) || 0;
        const commitment = strike !== null ? strike * contracts * 100 : 0;
        const putCommitment = isPut ? commitment : 0;
        const callCommitment = isCall ? commitment : 0;
        const type = isPut ? 'Put' : isCall ? 'Call' : '‚Äî';
        const strikeDisplay = strike !== null ? '$' + strike.toFixed(2) : '‚Äî';
        const dateObj = p.openDate || null;
        const date = dateObj ? fmtDateMMDDYYYY(dateObj) : '‚Äî';
        const dte = calcDTE(p.symbol);
        const premiumReceived = Math.abs(p.openingPremium || 0);
        return { dateObj, date, symbol: p.symbol, strike, strikeDisplay, type, contracts, putCommitment, callCommitment, dte, premiumReceived };
    });

    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    const modalInner = document.querySelector('#openCommitmentsModal > div');
    modalInner.style.background = isDark ? '#1e293b' : '#ffffff';
    modalInner.style.border = '1px solid #0ea5e9';

    renderOpenCommitmentsTable();

    // Restore persisted search value now that the input exists in the DOM
    const searchEl = document.getElementById('commitmentSearch');
    if (searchEl) searchEl.value = ocSearchValue;

    const modal = document.getElementById('openCommitmentsModal');
    modal.style.display = 'flex';
    modal.onclick = (e) => { if (e.target === modal) closeOpenCommitments(); };
    initDraggableModal('ocInner', '#0ea5e9', 1400);
    setTimeout(loadSavedFinnhubKey, 50); // restore saved key into input
}

function sortOpenCommitments(key) {
    if (ocSortKey === key) ocSortDir *= -1;
    else { ocSortKey = key; ocSortDir = 1; }
    renderOpenCommitmentsTable();
}

function renderOpenCommitmentsTable() {
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    const textColor = isDark ? '#f8fafc' : '#0f172a';
    const thBg = isDark ? '#0f172a' : '#f1f5f9';
    const rowBg = isDark ? '#1e293b' : '#ffffff';
    const rowAltBg = isDark ? '#162032' : '#f8fafc';
    const totalRowBg = isDark ? '#334155' : '#e2e8f0';
    const borderColor = isDark ? '#334155' : '#cbd5e1';
    const posColor = isDark ? '#4ade80' : '#16a34a';
    const negColor = isDark ? '#f87171' : '#dc2626';
    const warnColor = isDark ? '#fbbf24' : '#d97706';

    const fmt = (n) => n === 0 ? '' : ('$' + n.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2}));
    const fmtPrice = (n) => '$' + n.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});

    // Helper: render price cell content
    const priceCell = (ticker) => {
        const p = ocStockPrices[ticker];
        if (!p) return '<span style="color:#64748b;font-size:0.75rem;">‚Äî</span>';
        if (p.loading) return '<span style="color:#64748b;font-size:0.75rem;animation:pulse 1s infinite;">Loading‚Ä¶</span>';
        if (p.error) return `<span style="color:#f87171;font-size:0.75rem;" title="${p.errMsg||'fetch failed'}">Error ‚ö†</span>`;
        const chgColor = p.change >= 0 ? posColor : negColor;
        const sign = p.change >= 0 ? '+' : '';
        return `<span style="font-weight:700;font-size:0.9rem;">${fmtPrice(p.price)}</span><br><span style="font-size:0.7rem;color:${chgColor};">${sign}${p.change.toFixed(2)} (${sign}${p.changePct.toFixed(2)}%)</span>`;
    };

    // Sort
    const sorted = [...ocParsedRows].sort((a, b) => {
        let v1, v2;
        if (ocSortKey === 'date') { v1 = a.dateObj ? a.dateObj.getTime() : 0; v2 = b.dateObj ? b.dateObj.getTime() : 0; }
        else if (ocSortKey === 'symbol') { v1 = a.symbol.toLowerCase(); v2 = b.symbol.toLowerCase(); }
        else if (ocSortKey === 'dte') { v1 = a.dte !== '' ? parseInt(a.dte) : 9999; v2 = b.dte !== '' ? parseInt(b.dte) : 9999; }
        else if (ocSortKey === 'strike') { v1 = a.strike || 0; v2 = b.strike || 0; }
        else if (ocSortKey === 'type') { v1 = a.type; v2 = b.type; }
        else if (ocSortKey === 'contracts') { v1 = a.contracts; v2 = b.contracts; }
        else if (ocSortKey === 'premium') { v1 = a.premiumReceived; v2 = b.premiumReceived; }
        else if (ocSortKey === 'puts') { v1 = a.putCommitment; v2 = b.putCommitment; }
        else if (ocSortKey === 'calls') { v1 = a.callCommitment; v2 = b.callCommitment; }
        else if (ocSortKey === 'price') {
            const pa = ocStockPrices[extractTicker(a.symbol)];
            const pb = ocStockPrices[extractTicker(b.symbol)];
            v1 = pa && pa.price ? pa.price : 0; v2 = pb && pb.price ? pb.price : 0;
        }
        else if (ocSortKey === 'assignPrice') {
            v1 = a.type === 'Put' && a.contracts > 0 ? (a.putCommitment - a.premiumReceived) / (a.contracts * 100) : 0;
            v2 = b.type === 'Put' && b.contracts > 0 ? (b.putCommitment - b.premiumReceived) / (b.contracts * 100) : 0;
        }
        else if (ocSortKey === 'pctFromStrike') {
            const getPct = (r) => { const p = ocStockPrices[extractTicker(r.symbol)]; if (!p || p.loading || p.error || !p.price) return -Infinity; if (r.type === 'Put') { const ap = r.contracts > 0 ? (r.putCommitment - r.premiumReceived) / (r.contracts * 100) : null; return ap !== null ? (1 - ap / p.price) * 100 : -Infinity; } if (r.type === 'Call') return r.strike ? (r.strike / p.price - 1) * 100 : -Infinity; return -Infinity; };
            v1 = getPct(a); v2 = getPct(b);
        }
        else if (ocSortKey === 'otmitm') {
            const getOtm = (r) => { const p = ocStockPrices[extractTicker(r.symbol)]; if (!p || p.loading || p.error || !p.price) return -1; if (r.type === 'Put') return p.price > r.strike ? 1 : 0; if (r.type === 'Call') return p.price < r.strike ? 1 : 0; return -1; };
            v1 = getOtm(a); v2 = getOtm(b);
        }
        if (v1 < v2) return -ocSortDir;
        if (v1 > v2) return ocSortDir;
        return 0;
    });

    const search = ocSearchValue.toLowerCase().trim();
    const filtered = search ? sorted.filter(r => {
        const ticker = extractTicker(r.symbol);
        const pd = ocStockPrices[ticker];
        const assignPrice = r.type === 'Put' && r.contracts > 0
            ? ((r.putCommitment - r.premiumReceived) / (r.contracts * 100)).toFixed(2)
            : '';
        const currentPrice = pd && !pd.loading && !pd.error ? pd.price.toFixed(2) : '';
        const otmItm = pd && !pd.loading && !pd.error
            ? (r.type === 'Put' ? (pd.price > r.strike ? 'otm' : 'itm') : r.type === 'Call' ? (pd.price < r.strike ? 'otm' : 'itm') : '')
            : '';
        const vals = [
            r.date,
            r.symbol,
            ticker,
            r.dte !== '' ? String(r.dte) : '',
            r.strikeDisplay,
            r.strike ? r.strike.toFixed(2) : '',
            r.type,
            String(r.contracts),
            r.premiumReceived > 0 ? r.premiumReceived.toFixed(2) : '',
            r.putCommitment > 0 ? r.putCommitment.toFixed(2) : '',
            r.callCommitment > 0 ? r.callCommitment.toFixed(2) : '',
            assignPrice,
            currentPrice,
            otmItm,
        ];
        return vals.some(v => v.toLowerCase().includes(search));
    }) : sorted;

    const totalPuts = filtered.reduce((s, r) => s + r.putCommitment, 0);
    const totalCalls = filtered.reduce((s, r) => s + r.callCommitment, 0);

    // 9 columns now (added Current Price)
    const colW = 'width:8.33%;';
    const thBase = `background:${thBg};color:#0ea5e9;font-size:0.75rem;letter-spacing:0.04em;border-bottom:2px solid #0ea5e9;text-align:center;vertical-align:middle;padding:10px 6px;cursor:pointer;word-break:break-word;white-space:normal;user-select:none;position:relative;z-index:2;`;
    const arrow = (key) => ocSortKey === key ? (ocSortDir === 1 ? ' ‚ñ≤' : ' ‚ñº') : ' ‚Üï';
    const tdBase = `padding:10px 8px;border-bottom:1px solid ${borderColor};text-align:center;`;

    const rowsHtml = filtered.map((r, i) => {
        const ticker = extractTicker(r.symbol);
        const pd = ocStockPrices[ticker];
        // Highlight row if put is at-risk (stock price at or below strike)
        const isAtRisk = r.type === 'Put' && pd && !pd.loading && !pd.error && pd.price <= r.strike;
        const bg = isAtRisk ? (isDark ? 'rgba(248,113,113,0.12)' : 'rgba(220,38,38,0.07)') : (i % 2 === 0 ? rowBg : rowAltBg);
        return `<tr style="background:${bg};">
            <td style="${tdBase}color:${textColor};">${r.date}</td>
            <td style="${tdBase}color:${textColor};font-size:0.8rem;">${r.symbol}</td>
            <td style="${tdBase}color:${warnColor};">${r.dte !== '' ? r.dte : '‚Äî'}</td>
            <td style="${tdBase}color:#a78bfa;font-weight:600;">${r.strikeDisplay}</td>
            <td style="${tdBase}line-height:1.5;">${priceCell(ticker)}</td>
            <td style="${tdBase}color:#e879f9;font-weight:600;">${r.type === 'Put' && r.contracts > 0 ? '$' + ((r.putCommitment - r.premiumReceived) / (r.contracts * 100)).toFixed(2) : '‚Äî'}</td>
            <td style="${tdBase}font-weight:700;">${(() => { const p = ocStockPrices[extractTicker(r.symbol)]; if (!p || p.loading || p.error || !p.price) return '<span style="color:#64748b;">‚Äî</span>'; let pct = null; if (r.type === 'Put') { const ap = r.contracts > 0 ? (r.putCommitment - r.premiumReceived) / (r.contracts * 100) : null; if (ap !== null) pct = (1 - ap / p.price) * 100; } else if (r.type === 'Call') { if (r.strike) pct = (r.strike / p.price - 1) * 100; } if (pct === null) return '<span style="color:#64748b;">‚Äî</span>'; const color = pct >= 0 ? posColor : negColor; return '<span style="color:' + color + ';font-weight:700;">' + (pct >= 0 ? '+' : '') + pct.toFixed(1) + '%</span>'; })()}</td>
            <td style="${tdBase}font-weight:700;">${(() => { const p = ocStockPrices[extractTicker(r.symbol)]; if (!p || p.loading || p.error || !p.price) return '<span style="color:#64748b;">‚Äî</span>'; if (r.type === 'Put') { const otm = p.price > r.strike; return otm ? '<span style="color:' + posColor + '">OTM</span>' : '<span style="color:' + negColor + '">ITM</span>'; } if (r.type === 'Call') { const otm = p.price < r.strike; return otm ? '<span style="color:' + posColor + '">OTM</span>' : '<span style="color:' + negColor + '">ITM</span>'; } return '<span style="color:#64748b;">‚Äî</span>'; })()}</td>
            <td style="${tdBase}color:${r.type === 'Put' ? negColor : r.type === 'Call' ? posColor : textColor};font-weight:600;">${r.type}</td>
            <td style="${tdBase}color:${textColor};">${r.contracts}</td>
            <td style="${tdBase}color:#10b981;font-weight:600;">${r.premiumReceived > 0 ? '$' + r.premiumReceived.toLocaleString(undefined,{minimumFractionDigits:2}) : '‚Äî'}</td>
            <td style="${tdBase}color:${negColor};font-weight:500;">${fmt(r.putCommitment)}</td>
            <td style="${tdBase}color:${posColor};font-weight:500;">${fmt(r.callCommitment)}</td>
        </tr>`;
    }).join('');

    const totalPremium = filtered.reduce((s, r) => s + r.premiumReceived, 0);

    const totalRow = `<tr style="background:${totalRowBg};font-weight:bold;">
        <td colspan="10" style="padding:12px 8px;text-align:right;color:#a78bfa;border-top:2px solid #0ea5e9;">Totals</td>
        <td style="padding:12px 8px;text-align:center;color:#10b981;border-top:2px solid #0ea5e9;">${totalPremium > 0 ? '$' + totalPremium.toLocaleString(undefined,{minimumFractionDigits:2}) : '‚Äî'}</td>
        <td style="padding:12px 8px;text-align:center;color:${negColor};border-top:2px solid #0ea5e9;">${totalPuts > 0 ? '$' + totalPuts.toLocaleString(undefined,{minimumFractionDigits:2}) : '‚Äî'}</td>
        <td style="padding:12px 8px;text-align:center;color:${posColor};border-top:2px solid #0ea5e9;">${totalCalls > 0 ? '$' + totalCalls.toLocaleString(undefined,{minimumFractionDigits:2}) : '‚Äî'}</td>
    </tr>`;

    // --- Summary table grouped by expiration date, now with avg price per ticker ---
    const expGroups = {};
    ocParsedRows.forEach(r => {
        const sym = r.symbol.trim();
        const expMatch = sym.match(/(\d{1,2}\/\d{1,2}\/\d{4})/);
        const expDate = expMatch ? expMatch[1] : '‚Äî';
        const ticker = extractTicker(r.symbol);
        if (!expGroups[expDate]) expGroups[expDate] = { expDate, dte: r.dte, totalPuts: 0, totalCalls: 0, totalPremium: 0, tickers: new Set() };
        expGroups[expDate].totalPuts += r.putCommitment;
        expGroups[expDate].totalCalls += r.callCommitment;
        expGroups[expDate].totalPremium += r.premiumReceived;
        expGroups[expDate].tickers.add(ticker);
    });

    const groupRows = Object.values(expGroups).sort((a, b) => {
        const da = a.dte !== '' ? parseInt(a.dte) : 9999;
        const db = b.dte !== '' ? parseInt(b.dte) : 9999;
        return da - db;
    });

    const grandPuts = groupRows.reduce((s, g) => s + g.totalPuts, 0);
    const grandCalls = groupRows.reduce((s, g) => s + g.totalCalls, 0);
    const grandPremium = groupRows.reduce((s, g) => s + g.totalPremium, 0);

    const sumThStyle = `background:${thBg};color:#0ea5e9;font-size:0.75rem;letter-spacing:0.04em;border-bottom:2px solid #0ea5e9;text-align:center;vertical-align:middle;padding:10px 8px;word-break:break-word;white-space:normal;`;
    const sumTdStyle = `padding:10px 8px;border-bottom:1px solid ${borderColor};text-align:center;`;

    const summaryRowsHtml = groupRows.map((g, i) => {
        // Show prices for all tickers in this expiry group
        const tickerPrices = [...g.tickers].map(t => {
            const pd = ocStockPrices[t];
            if (!pd) return `<span style="color:#64748b;font-size:0.75rem;">${t}: ‚Äî</span>`;
            if (pd.loading) return `<span style="font-size:0.75rem;color:#64748b;">${t}: Loading‚Ä¶</span>`;
            if (pd.error) return `<span style="font-size:0.75rem;color:${negColor};">${t}: Error</span>`;
            const chgColor = pd.change >= 0 ? posColor : negColor;
            const sign = pd.change >= 0 ? '+' : '';
            return `<span style="font-size:0.8rem;"><b>${t}</b> ${fmtPrice(pd.price)} <span style="color:${chgColor};">${sign}${pd.changePct.toFixed(2)}%</span></span>`;
        }).join('<br>');

        return `<tr style="background:${i % 2 === 0 ? rowBg : rowAltBg};">
            <td style="${sumTdStyle}color:${textColor};">${g.expDate}</td>
            <td style="${sumTdStyle}color:${warnColor};font-weight:600;">${g.dte !== '' ? g.dte : '‚Äî'}</td>
            <td style="${sumTdStyle}color:#10b981;font-weight:600;">${g.totalPremium > 0 ? '$' + g.totalPremium.toLocaleString(undefined,{minimumFractionDigits:2}) : '‚Äî'}</td>
            <td style="${sumTdStyle}color:${negColor};font-weight:500;">${g.totalPuts > 0 ? '$' + g.totalPuts.toLocaleString(undefined,{minimumFractionDigits:2}) : '‚Äî'}</td>
            <td style="${sumTdStyle}color:${posColor};font-weight:500;">${g.totalCalls > 0 ? '$' + g.totalCalls.toLocaleString(undefined,{minimumFractionDigits:2}) : '‚Äî'}</td>
        </tr>`;
    }).join('');

    const summaryTotalRow = `<tr style="background:${totalRowBg};font-weight:bold;">
        <td colspan="2" style="${sumTdStyle}text-align:right;color:#a78bfa;border-top:2px solid #0ea5e9;">Totals</td>
        <td style="${sumTdStyle}color:#10b981;border-top:2px solid #0ea5e9;">${grandPremium > 0 ? '$' + grandPremium.toLocaleString(undefined,{minimumFractionDigits:2}) : '‚Äî'}</td>
        <td style="${sumTdStyle}color:${negColor};border-top:2px solid #0ea5e9;">${grandPuts > 0 ? '$' + grandPuts.toLocaleString(undefined,{minimumFractionDigits:2}) : '‚Äî'}</td>
        <td style="${sumTdStyle}color:${posColor};border-top:2px solid #0ea5e9;">${grandCalls > 0 ? '$' + grandCalls.toLocaleString(undefined,{minimumFractionDigits:2}) : '‚Äî'}</td>
    </tr>`;

    // Update timestamp
    const tsEl = document.getElementById('priceTimestamp');
    if (tsEl) {
        if (ocPriceFetchTime) {
            tsEl.textContent = 'Prices last updated: ' + ocPriceFetchTime.toLocaleTimeString();
        } else {
            tsEl.textContent = 'Click "Refresh Prices" to load real-time stock prices via Yahoo Finance.';
        }
    }

    const isFirstRender = !document.getElementById('ocPositionsTable');

    if (isFirstRender) {
        document.getElementById('openCommitmentsContainer').innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center;margin:0 0 12px;">
                <h3 style="color:#0ea5e9;margin:0;font-size:0.95rem;text-transform:uppercase;letter-spacing:0.05em;">All Open Positions</h3>
                <input id="commitmentSearch" type="text" placeholder="Search table..." oninput="ocSearchValue=this.value; renderOpenCommitmentsTable()"
                    style="background:var(--bg-input);border:2px solid #0ea5e9;color:var(--text-primary);padding:6px 12px;border-radius:8px;outline:none;font-size:0.85rem;width:160px;">
            </div>
            <div style="overflow-x:auto;border:1px solid #0ea5e9;border-radius:8px;">
            <table id="ocPositionsTable" style="width:100%;border-collapse:collapse;background:${rowBg};font-size:0.88rem;table-layout:fixed;">
                <colgroup>
                    <col style="${colW}"><col style="${colW}"><col style="${colW}"><col style="${colW}"><col style="${colW}"><col style="${colW}">
                    <col style="${colW}"><col style="${colW}"><col style="${colW}"><col style="${colW}"><col style="${colW}"><col style="${colW}"><col style="${colW}">
                </colgroup>
                <thead id="ocDetailThead" style="position:sticky;top:0;z-index:2;"><tr>
                    <th style="${thBase}" onclick="sortOpenCommitments('date')">Transaction Date${arrow('date')}</th>
                    <th style="${thBase}" onclick="sortOpenCommitments('symbol')">Symbol${arrow('symbol')}</th>
                    <th style="${thBase}" onclick="sortOpenCommitments('dte')">Days Till Expiration${arrow('dte')}</th>
                    <th style="${thBase}" onclick="sortOpenCommitments('strike')">Strike Price${arrow('strike')}</th>
                    <th style="${thBase}" onclick="sortOpenCommitments('price')">Current Price${arrow('price')}</th>
                    <th style="${thBase}" onclick="sortOpenCommitments('assignPrice')">Assignment Price${arrow('assignPrice')}</th>
                    <th style="${thBase}" onclick="sortOpenCommitments('pctFromStrike')">% From Strike Price${arrow('pctFromStrike')}</th>
                    <th style="${thBase}" onclick="sortOpenCommitments('otmitm')">OTM / ITM${arrow('otmitm')}</th>
                    <th style="${thBase}" onclick="sortOpenCommitments('type')">Put or Call${arrow('type')}</th>
                    <th style="${thBase}" onclick="sortOpenCommitments('contracts')"># of Contracts${arrow('contracts')}</th>
                    <th style="${thBase}" onclick="sortOpenCommitments('premium')">Premium${arrow('premium')}</th>
                    <th style="${thBase}" onclick="sortOpenCommitments('puts')">Commitments (Puts)${arrow('puts')}</th>
                    <th style="${thBase}" onclick="sortOpenCommitments('calls')">Commitments (Calls)${arrow('calls')}</th>
                </tr></thead>
                <tbody id="ocPositionsBody"></tbody>
            </table>
            </div>
            <h3 style="color:#0ea5e9;margin:28px 0 12px;font-size:0.95rem;text-transform:uppercase;letter-spacing:0.05em;">Summary by Expiration</h3>
            <div style="overflow-x:auto;margin-bottom:28px;">
            <table style="width:100%;border-collapse:collapse;background:${rowBg};font-size:0.88rem;table-layout:fixed;">
                <colgroup><col style="width:20%"><col style="width:20%"><col style="width:20%"><col style="width:20%"><col style="width:20%"></colgroup>
                <thead><tr>
                    <th style="${sumThStyle}">Strike Date</th>
                    <th style="${sumThStyle}">Days Till Expiration</th>
                    <th style="${sumThStyle}">Premium</th>
                    <th style="${sumThStyle}">Total Commitments (Puts)</th>
                    <th style="${sumThStyle}">Total Commitments (Calls)</th>
                </tr></thead>
                <tbody>${summaryRowsHtml}${summaryTotalRow}</tbody>
            </table>
            </div>`;
    } else {
        // Just update the thead arrows (sort indicators) without destroying the input
        document.getElementById('ocDetailThead').querySelector('tr').innerHTML = `
            <th style="${thBase}" onclick="sortOpenCommitments('date')">Transaction Date${arrow('date')}</th>
            <th style="${thBase}" onclick="sortOpenCommitments('symbol')">Symbol${arrow('symbol')}</th>
            <th style="${thBase}" onclick="sortOpenCommitments('dte')">Days Till Expiration${arrow('dte')}</th>
            <th style="${thBase}" onclick="sortOpenCommitments('strike')">Strike Price${arrow('strike')}</th>
            <th style="${thBase}" onclick="sortOpenCommitments('price')">Current Price${arrow('price')}</th>
            <th style="${thBase}" onclick="sortOpenCommitments('assignPrice')">Assignment Price${arrow('assignPrice')}</th>
            <th style="${thBase}" onclick="sortOpenCommitments('pctFromStrike')">% From Strike Price${arrow('pctFromStrike')}</th>
            <th style="${thBase}" onclick="sortOpenCommitments('otmitm')">OTM / ITM${arrow('otmitm')}</th>
            <th style="${thBase}" onclick="sortOpenCommitments('type')">Put or Call${arrow('type')}</th>
            <th style="${thBase}" onclick="sortOpenCommitments('contracts')"># of Contracts${arrow('contracts')}</th>
            <th style="${thBase}" onclick="sortOpenCommitments('premium')">Premium${arrow('premium')}</th>
            <th style="${thBase}" onclick="sortOpenCommitments('puts')">Commitments (Puts)${arrow('puts')}</th>
            <th style="${thBase}" onclick="sortOpenCommitments('calls')">Commitments (Calls)${arrow('calls')}</th>`;
    }

    document.getElementById('ocPositionsBody').innerHTML = rowsHtml + totalRow;

    // Set up scroll-based thead pin after DOM updates
    setTimeout(() => {
        const modalInner = document.querySelector('#openCommitmentsModal > div');
        if (!modalInner) return;

        // Remove any previous listener
        if (modalInner._ocScrollHandler) {
            modalInner.removeEventListener('scroll', modalInner._ocScrollHandler);
        }

        modalInner._ocScrollHandler = function() {
            const thead = document.getElementById('ocDetailThead');
            if (!thead) return;
            const theadRect = thead.parentElement.getBoundingClientRect(); // table
            const modalRect = modalInner.getBoundingClientRect();
            // How far has the table top scrolled above the modal top?
            const scrolledPast = modalRect.top - theadRect.top;
            if (scrolledPast > 0) {
                thead.style.transform = `translateY(${scrolledPast}px)`;
                thead.style.boxShadow = '0 4px 8px rgba(0,0,0,0.4)';
            } else {
                thead.style.transform = '';
                thead.style.boxShadow = '';
            }
        };

        modalInner.addEventListener('scroll', modalInner._ocScrollHandler);
    }, 50);
}

// ============================================================
// ASSIGNMENTS
// ============================================================
let assignmentStockPrices = {};
let assignmentPriceFetchTime = null;
let assignSortKey = 'date';
let assignSortDir = 1;

function closeAssignments() {
    const _di = document.getElementById('assignmentsInner'); if (_di) _di._dragInit = false;
    document.getElementById('assignmentsModal').style.display = 'none';
}

function setAssignmentQuickRange() {
    const range = document.getElementById('assignDatePreset').value;
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    let start = new Date(today), end = new Date();
    end.setHours(23, 59, 59, 999);

    switch(range) {
        case 'today': break;
        case '7days': start.setDate(today.getDate() - 6); break;
        case 'lastMonth': start = new Date(today.getFullYear(), today.getMonth() - 1, 1); end = new Date(today.getFullYear(), today.getMonth(), 0); break;
        case 'last3Months': start = new Date(today.getFullYear(), today.getMonth() - 3, 1); end = new Date(today.getFullYear(), today.getMonth(), 0); break;
        case 'last6Months': start = new Date(today.getFullYear(), today.getMonth() - 6, 1); end = new Date(today.getFullYear(), today.getMonth(), 0); break;
        case 'last12Months': start = new Date(today.getFullYear(), today.getMonth() - 12, 1); end = new Date(today.getFullYear(), today.getMonth(), 0); break;
        case 'lastYear': start = new Date(today.getFullYear() - 1, 0, 1); end = new Date(today.getFullYear() - 1, 11, 31); break;
        case 'currentMonth': start = new Date(today.getFullYear(), today.getMonth(), 1); end = new Date(); end.setHours(23,59,59,999); break;
        case 'currentYear': start = new Date(today.getFullYear(), 0, 1); end = new Date(); end.setHours(23,59,59,999); break;
        case 'all': default: start = null; end = null; break;
    }

    document.getElementById('assignDateFrom').value = start ? toISODate(start) : '';
    document.getElementById('assignDateTo').value = end ? toISODate(end) : '';
    renderAssignmentsTable();
}

function resetAssignmentFilters() {
    document.getElementById('assignDatePreset').value = 'all';
    document.getElementById('assignDateFrom').value = '';
    document.getElementById('assignDateTo').value = '';
    document.getElementById('assignmentSearch').value = '';
    document.getElementById('assignNotSoldFilter').checked = false;
    document.getElementById('assignSoldFilter').checked = false;
    renderAssignmentsTable();
}

function getAssignedTrades() {
    return finalTrades.filter(t => {
        if (!t.status.toLowerCase().includes('assigned')) return false;
        const isPut = /[\d.]+\s+P\s*$/.test(t.symbol);
        if (!isPut) return false;
        return true;
    });
}

// Find if the assigned stock ticker was later sold (sell to close stock)
// We look in allTransactions for a "Sell" of the base ticker (not an option)
function findStockSalePrice(ticker, assignDate) {
    if (!window.allTransactions) return null;
    // Stock sales in Schwab appear as action containing "sell" but NOT "to open" or "to close" option actions
    // and the symbol would just be the ticker. We also check finalTrades for sell-to-close on stock.
    // Look for transactions with symbol === ticker and action = "sell"
    // Since allTransactions doesn't store symbol separately, scan the raw data.
    // Instead, check window.rawRows if available.
    if (window.rawRows) {
        const tickerUpper = ticker.toUpperCase();
        const sales = window.rawRows.filter(r => {
            const sym = (r.Symbol || '').trim().toUpperCase();
            const action = (r.Action || '').toLowerCase();
            const d = parseDateString(r.Date);
            return sym === tickerUpper && action.includes('sell') && d && d >= assignDate;
        });
        if (sales.length > 0) {
            // Return price of earliest sale after assignment
            sales.sort((a, b) => parseDateString(a.Date) - parseDateString(b.Date));
            const price = cleanNum(sales[0].Price);
            return price > 0 ? price : null;
        }
    }
    return null;
}

// Sum calls sold against shares (closed + active) for a given ticker after an assignment date
function getCallsSoldAgainstShares(ticker, assignDate) {
    // Look in finalTrades for calls sold on this ticker after assignDate
    let total = 0;
    finalTrades.forEach(t => {
        const tTicker = extractTicker(t.symbol);
        if (tTicker !== ticker) return;
        const st = t.status.toLowerCase();
        const isCall = t.symbol.match(/[\d.]+\s+C\s*$/);
        if (!isCall) return;
        const tradeDate = t.openDate || t.closeDate;
        if (tradeDate && tradeDate >= assignDate) {
            // opening premium (sell to open a call)
            if (st.includes('buy') && st.includes('close')) {
                // closed call: profit = openingPremium + closingPremium (closingPremium is negative)
                total += t.openingPremium; // just credit received when opened
            } else if (st.includes('expired') || st.includes('sell') && st.includes('close')) {
                total += t.openingPremium;
            } else {
                total += t.openingPremium;
            }
        }
    });
    // Also check openPositions for open calls on this ticker
    openPositions.forEach(p => {
        const pTicker = extractTicker(p.symbol);
        if (pTicker !== ticker) return;
        const isCall = p.symbol.match(/[\d.]+\s+C\s*$/);
        if (!isCall) return;
        if (p.openDate && p.openDate >= assignDate) {
            total += p.openingPremium;
        }
    });
    return total;
}

async function refreshAssignmentPrices() {
    const assigned = getAssignedTrades();
    if (!assigned.length) return;
    const tickers = [...new Set(assigned.map(t => extractTicker(t.symbol)))];
    tickers.forEach(t => { assignmentStockPrices[t] = { loading: true }; });
    renderAssignmentsTable();

    const tsEl = document.getElementById('assignmentPriceTimestamp');
    if (tsEl) tsEl.textContent = `Fetching prices for: ${tickers.join(', ')}‚Ä¶`;

    for (const ticker of tickers) {
        try {
            const data = await fetchSinglePrice(ticker);
            assignmentStockPrices[ticker] = { ...data, loading: false, error: false };
        } catch(e) {
            assignmentStockPrices[ticker] = { loading: false, error: true, errMsg: e.message };
        }
        renderAssignmentsTable();
        if (tickers.length > 1) await new Promise(r => setTimeout(r, 150));
    }
    assignmentPriceFetchTime = new Date();
    renderAssignmentsTable();
}

function sortAssignments(key) {
    if (assignSortKey === key) assignSortDir *= -1;
    else { assignSortKey = key; assignSortDir = 1; }
    renderAssignmentsTable();
}

function renderAssignmentsTable() {
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    const textColor = isDark ? '#f8fafc' : '#0f172a';
    const thBg = isDark ? '#0f172a' : '#f1f5f9';
    const rowBg = isDark ? '#1e293b' : '#ffffff';
    const rowAltBg = isDark ? '#162032' : '#f8fafc';
    const totalRowBg = isDark ? '#334155' : '#e2e8f0';
    const borderColor = isDark ? '#334155' : '#cbd5e1';
    const posColor = isDark ? '#4ade80' : '#16a34a';
    const negColor = isDark ? '#f87171' : '#dc2626';
    const warnColor = isDark ? '#fbbf24' : '#d97706';

    const fmtD = (n) => (n >= 0 ? '$' : '-$') + Math.abs(n).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
    const fmtU = (n) => '$' + n.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});

    const assigned = getAssignedTrades();

    const tsEl = document.getElementById('assignmentPriceTimestamp');
    if (tsEl) {
        if (assignmentPriceFetchTime) tsEl.textContent = 'Prices last updated: ' + assignmentPriceFetchTime.toLocaleTimeString();
        else tsEl.textContent = 'Click "Refresh Prices" to load real-time stock prices via Finnhub.';
    }

    if (!assigned.length) {
        document.getElementById('assignmentsContainer').innerHTML = '<p style="color:var(--text-secondary);text-align:center;padding:40px;">No assigned options found in the uploaded data.</p>';
        return;
    }
    const enriched = assigned.map(t => {
        const ticker = extractTicker(t.symbol);
        const putMatch = t.symbol.match(/([\d.]+)\s+P\s*$/);
        const callMatch = t.symbol.match(/([\d.]+)\s+C\s*$/);
        const strike = putMatch ? parseFloat(putMatch[1]) : callMatch ? parseFloat(callMatch[1]) : 0;
        const isCall = !!callMatch;
        const contracts = parseFloat(t.contracts) || 0;
        const sharesAssigned = contracts * 100;
        const premiumPaid = Math.abs(t.openingPremium);
        const purchasePrice = sharesAssigned > 0
            ? isCall
                ? ((sharesAssigned * strike) + premiumPaid) / sharesAssigned
                : ((sharesAssigned * strike) - premiumPaid) / sharesAssigned
            : 0;
        const assignDate = t.closeDate || t.openDate;
        const soldPrice = findStockSalePrice(ticker, assignDate);
        const pd = assignmentStockPrices[ticker];
        const currentPriceVal = (pd && !pd.loading && !pd.error) ? pd.price : null;
        const costBasis = purchasePrice * sharesAssigned;
        const priceForMV = soldPrice !== null ? soldPrice : currentPriceVal;
        const marketValue = priceForMV !== null ? priceForMV * sharesAssigned : null;
        const callsSold = getCallsSoldAgainstShares(ticker, assignDate);
        const pl = marketValue !== null ? (marketValue - costBasis) : null;
        return { t, ticker, strike, isCall, contracts, sharesAssigned, premiumPaid, purchasePrice,
                 assignDate, soldPrice, pd, currentPriceVal, costBasis, marketValue, callsSold, pl };
    });

    // Full-table search filter (runs after enrichment so all computed columns are searchable)
    const search = (document.getElementById('assignmentSearch')?.value || '').toLowerCase().trim();

    // Date range filter
    const fromVal = document.getElementById('assignDateFrom')?.value;
    const toVal = document.getElementById('assignDateTo')?.value;
    const fromDate = fromVal ? new Date(fromVal + 'T00:00:00') : null;
    const toDate = toVal ? new Date(toVal + 'T23:59:59') : null;

    // Unsold / Sold checkbox filters
    const notSoldOnly = document.getElementById('assignNotSoldFilter')?.checked || false;
    const soldOnly = document.getElementById('assignSoldFilter')?.checked || false;

    const filteredEnriched = enriched.filter(row => {
        const { t, ticker, strike, contracts, sharesAssigned, premiumPaid, purchasePrice,
                assignDate, soldPrice, currentPriceVal, costBasis, marketValue, callsSold, pl } = row;

        // Unsold filter
        if (notSoldOnly && soldPrice !== null) return false;
        // Sold filter
        if (soldOnly && soldPrice === null) return false;

        // Date filter
        if (assignDate) {
            if (fromDate && assignDate < fromDate) return false;
            if (toDate && assignDate > toDate) return false;
        }

        // Search filter
        if (search) {
            const dateStr = assignDate ? fmtDateMMDDYYYY(assignDate) : '';
            const vals = [
                dateStr,
                t.symbol,
                ticker,
                strike > 0 ? strike.toFixed(2) : '',
                String(contracts),
                String(sharesAssigned),
                premiumPaid.toFixed(2),
                purchasePrice > 0 ? purchasePrice.toFixed(2) : '',
                soldPrice !== null ? soldPrice.toFixed(2) : 'unsold',
                currentPriceVal !== null ? currentPriceVal.toFixed(2) : '',
                costBasis.toFixed(2),
                marketValue !== null ? marketValue.toFixed(2) : '',
                callsSold !== 0 ? callsSold.toFixed(2) : '',
                pl !== null ? pl.toFixed(2) : '',
            ];
            if (!vals.some(v => v.toLowerCase().includes(search))) return false;
        }

        return true;
    });

    if (!filteredEnriched.length) {
        document.getElementById('assignmentsContainer').innerHTML = `<p style="color:var(--text-secondary);text-align:center;padding:40px;">No results match your search for "<strong>${search}</strong>".</p>`;
        return;
    }

    // Sort
    const arrow = (key) => assignSortKey === key ? (assignSortDir === 1 ? ' ‚ñ≤' : ' ‚ñº') : ' ‚Üï';

    filteredEnriched.sort((a, b) => {
        let v1, v2;
        switch(assignSortKey) {
            case 'date':       v1 = a.assignDate ? a.assignDate.getTime() : 0; v2 = b.assignDate ? b.assignDate.getTime() : 0; break;
            case 'symbol':     v1 = a.t.symbol.toLowerCase(); v2 = b.t.symbol.toLowerCase(); break;
            case 'strike':     v1 = a.strike; v2 = b.strike; break;
            case 'contracts':  v1 = a.contracts; v2 = b.contracts; break;
            case 'shares':     v1 = a.sharesAssigned; v2 = b.sharesAssigned; break;
            case 'premium':    v1 = a.premiumPaid; v2 = b.premiumPaid; break;
            case 'purchase':   v1 = a.purchasePrice; v2 = b.purchasePrice; break;
            case 'sold':       v1 = a.soldPrice !== null ? a.soldPrice : -Infinity; v2 = b.soldPrice !== null ? b.soldPrice : -Infinity; break;
            case 'current':    v1 = a.currentPriceVal !== null ? a.currentPriceVal : -Infinity; v2 = b.currentPriceVal !== null ? b.currentPriceVal : -Infinity; break;
            case 'costbasis':  v1 = a.costBasis; v2 = b.costBasis; break;
            case 'mktvalue':   v1 = a.marketValue !== null ? a.marketValue : -Infinity; v2 = b.marketValue !== null ? b.marketValue : -Infinity; break;
            case 'calls':      v1 = a.callsSold; v2 = b.callsSold; break;
            case 'pl':         v1 = a.pl !== null ? a.pl : -Infinity; v2 = b.pl !== null ? b.pl : -Infinity; break;
            default:           v1 = 0; v2 = 0;
        }
        if (v1 < v2) return -assignSortDir;
        if (v1 > v2) return assignSortDir;
        return 0;
    });

    const thStyle = `background:${thBg};color:#f59e0b;font-size:0.7rem;letter-spacing:0.02em;border-bottom:2px solid #f59e0b;text-align:center;vertical-align:middle;padding:8px 5px;word-break:break-word;white-space:normal;cursor:pointer;user-select:none;min-width:70px;position:relative;`;
    const tdBase = `padding:8px 6px;border-bottom:1px solid ${borderColor};text-align:center;font-size:0.8rem;white-space:nowrap;`;

    const cols = [
        { label: 'Transaction Date', key: 'date' },
        { label: 'Symbol',           key: 'symbol' },
        { label: 'Strike Price',     key: 'strike' },
        { label: '# of Contracts',  key: 'contracts' },
        { label: '# of Shares Assigned', key: 'shares' },
        { label: 'Premium Paid',    key: 'premium' },
        { label: 'Purchase Price',  key: 'purchase' },
        { label: 'Sold Price',      key: 'sold' },
        { label: 'Current Stock Price', key: 'current' },
        { label: 'Cost Basis',      key: 'costbasis' },
        { label: 'Market Value',    key: 'mktvalue' },
        { label: 'Profit / Loss',   key: 'pl' },
    ];

    let totCostBasis = 0, totMarketValue = 0, totCallsSold = 0, totPL = 0, totPremium = 0;
    let hasMarketValue = false;

    const rowsHtml = filteredEnriched.map(({ t, ticker, strike, contracts, sharesAssigned, premiumPaid,
                                     purchasePrice, assignDate, soldPrice, pd, currentPriceVal,
                                     costBasis, marketValue, callsSold, pl }, i) => {

        const soldPriceDisplay = soldPrice !== null ? fmtU(soldPrice) : 'Unsold';

        let currentPriceDisplay = '<span style="color:#64748b;font-size:0.75rem;">‚Äî</span>';
        if (pd) {
            if (pd.loading) currentPriceDisplay = '<span style="color:#64748b;font-size:0.75rem;animation:pulse 1s infinite;">Loading‚Ä¶</span>';
            else if (pd.error) currentPriceDisplay = `<span style="color:${negColor};font-size:0.75rem;" title="${pd.errMsg||''}">Error ‚ö†</span>`;
            else {
                const chgColor = pd.change >= 0 ? posColor : negColor;
                const sign = pd.change >= 0 ? '+' : '';
                currentPriceDisplay = `<span style="font-weight:700;">${fmtU(pd.price)}</span><br><span style="font-size:0.7rem;color:${chgColor};">${sign}${pd.change.toFixed(2)} (${sign}${pd.changePct.toFixed(2)}%)</span>`;
            }
        }

        totPremium += premiumPaid;
        if (!isNaN(costBasis)) totCostBasis += costBasis;
        if (marketValue !== null && !isNaN(marketValue)) { totMarketValue += marketValue; hasMarketValue = true; }
        if (!isNaN(callsSold)) totCallsSold += callsSold;
        if (pl !== null && !isNaN(pl)) totPL += pl;

        const bg = i % 2 === 0 ? rowBg : rowAltBg;
        return `<tr style="background:${bg};">
            <td style="${tdBase}color:${textColor};">${assignDate ? fmtDateMMDDYYYY(assignDate) : '‚Äî'}</td>
            <td style="${tdBase}color:${textColor};font-size:0.78rem;">${t.symbol}</td>
            <td style="${tdBase}color:#a78bfa;font-weight:600;">${strike > 0 ? fmtU(strike) : '‚Äî'}</td>
            <td style="${tdBase}color:${textColor};">${contracts}</td>
            <td style="${tdBase}color:${textColor};">${sharesAssigned}</td>
            <td style="${tdBase}color:${negColor};">${fmtU(premiumPaid)}</td>
            <td style="${tdBase}color:#e879f9;font-weight:600;">${sharesAssigned > 0 ? fmtU(purchasePrice) : '‚Äî'}</td>
            <td style="${tdBase}color:${soldPrice !== null ? posColor : warnColor};">${soldPriceDisplay}</td>
            <td style="${tdBase}line-height:1.5;">${currentPriceDisplay}</td>
            <td style="${tdBase}color:${textColor};font-weight:600;">${fmtU(costBasis)}</td>
            <td style="${tdBase}color:${marketValue !== null ? textColor : '#64748b'};font-weight:600;">${marketValue !== null ? fmtU(marketValue) : '‚Äî'}</td>
            <td style="${tdBase}color:${pl === null ? '#64748b' : pl >= 0 ? posColor : negColor};font-weight:700;">${pl !== null ? fmtD(pl) : '‚Äî'}</td>
        </tr>`;
    }).join('');

    const totalRow = `<tr style="background:${totalRowBg};font-weight:bold;">
        <td colspan="5" style="padding:12px 8px;text-align:right;color:#a78bfa;border-top:2px solid #f59e0b;">Totals</td>
        <td style="padding:12px 8px;text-align:center;border-top:2px solid #f59e0b;color:${negColor};">${fmtU(totPremium)}</td>
        <td colspan="3" style="padding:12px 8px;border-top:2px solid #f59e0b;"></td>
        <td style="padding:12px 8px;text-align:center;border-top:2px solid #f59e0b;color:${textColor};">${fmtU(totCostBasis)}</td>
        <td style="padding:12px 8px;text-align:center;border-top:2px solid #f59e0b;color:${textColor};">${hasMarketValue ? fmtU(totMarketValue) : '‚Äî'}</td>
        <td style="padding:12px 8px;text-align:center;border-top:2px solid #f59e0b;color:${totPL >= 0 ? posColor : negColor};">${hasMarketValue ? fmtD(totPL) : '‚Äî'}</td>
    </tr>`;

    // Update summary boxes
    const summaryBoxStyle = (color) => `display:flex;justify-content:space-between;align-items:center;gap:10px;padding:6px 10px;border-radius:7px;background:var(--bg-input);border:1px solid var(--border-color);`;
    const summaryLabel = `font-size:0.68rem;color:var(--text-secondary);text-transform:uppercase;letter-spacing:0.04em;font-weight:600;white-space:nowrap;`;
    const summaryValue = (color) => `font-size:0.9rem;font-weight:700;color:${color};white-space:nowrap;`;
    const summaryEl = document.getElementById('assignSummaryInner');
    if (summaryEl) {
        summaryEl.innerHTML = `
            <div style="${summaryBoxStyle()}">
                <span style="${summaryLabel}">Premium Paid</span>
                <span style="${summaryValue(negColor)}">${fmtU(totPremium)}</span>
            </div>
            <div style="${summaryBoxStyle()}">
                <span style="${summaryLabel}">Cost Basis</span>
                <span style="${summaryValue(textColor)}">${fmtU(totCostBasis)}</span>
            </div>
            <div style="${summaryBoxStyle()}">
                <span style="${summaryLabel}">Market Value</span>
                <span style="${summaryValue(textColor)}">${hasMarketValue ? fmtU(totMarketValue) : '‚Äî'}</span>
            </div>
            <div style="${summaryBoxStyle()}">
                <span style="${summaryLabel}">Profit / Loss</span>
                <span style="${summaryValue(hasMarketValue ? (totPL >= 0 ? posColor : negColor) : '#64748b')}">${hasMarketValue ? fmtD(totPL) : '‚Äî'}</span>
            </div>`;
    }

    const colCount = cols.length;
    const colW = `width:${(100/colCount).toFixed(2)}%;`;

    document.getElementById('assignmentsContainer').innerHTML = `
        <div style="overflow-x:auto;-webkit-overflow-scrolling:touch;">
        <table style="width:100%;border-collapse:collapse;background:${rowBg};font-size:0.85rem;table-layout:auto;min-width:900px;">
            <colgroup>${cols.map(() => `<col>`).join('')}</colgroup>
            <thead><tr>${cols.map(c => `<th style="${thStyle}" onclick="sortAssignments('${c.key}')">${c.label}${arrow(c.key)}<div class="resizer"></div></th>`).join('')}</tr></thead>
            <tbody>${rowsHtml}${totalRow}</tbody>
        </table>
        </div>`;

    // Wire up column resizers
    document.querySelectorAll('#assignmentsContainer .resizer').forEach(resizer => {
        let startX, startWidth;
        resizer.addEventListener('mousedown', (e) => {
            e.stopPropagation();
            startX = e.pageX;
            const th = resizer.parentElement;
            startWidth = th.offsetWidth;
            const onMouseMove = (e) => { th.style.width = (startWidth + e.pageX - startX) + 'px'; th.style.minWidth = th.style.width; };
            const onMouseUp = () => { document.removeEventListener('mousemove', onMouseMove); document.removeEventListener('mouseup', onMouseUp); };
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        });
    });
}

function showAssignments() {
    document.getElementById('assignmentSearch').value = '';
    const assigned = getAssignedTrades();
    if (!assigned.length) {
        alert('No assigned options found. Please upload a file that contains assigned trades.');
        return;
    }

    assignSortKey = 'date';
    assignSortDir = 1;

    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    const modalInner = document.querySelector('#assignmentsModal > div');
    modalInner.style.background = isDark ? '#1e293b' : '#ffffff';
    modalInner.style.border = '1px solid #f59e0b';

    renderAssignmentsTable();

    const modal = document.getElementById('assignmentsModal');
    modal.style.display = 'flex';
    modal.onclick = (e) => { if (e.target === modal) closeAssignments(); };
    initDraggableModal('assignmentsInner', '#f59e0b', 1600);
}

function showMonthlySummary() {
    if (!window.allTransactions || window.allTransactions.length === 0) {
        alert('Please upload a file first.');
        return;
    }

    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    const modalBg = isDark ? '#1e293b' : '#ffffff';
    const modalBorder = '#6d28d9';
    const textColor = isDark ? '#f8fafc' : '#0f172a';
    const thBg = isDark ? '#0f172a' : '#f1f5f9';
    const rowBg = isDark ? '#1e293b' : '#ffffff';
    const totalRowBg = isDark ? '#334155' : '#e2e8f0';
    const borderColor = isDark ? '#334155' : '#cbd5e1';

    // Update modal div style dynamically
    const modalInner = document.querySelector('#monthlyModal > div');
    modalInner.style.background = modalBg;
    modalInner.style.border = `1px solid ${modalBorder}`;

    const startYear = finalTrades.length > 0 ? Math.min(...finalTrades.map(t => t.closeDate ? t.closeDate.getFullYear() : 9999)) : new Date().getFullYear();
    const now = new Date();
    const months = [];
    for (let y = startYear; y <= now.getFullYear(); y++) {
        const mEnd = (y === now.getFullYear()) ? now.getMonth() : 11;
        for (let m = 0; m <= mEnd; m++) {
            months.push({ year: y, month: m });
        }
    }

    const fmt = (n) => (n >= 0 ? '$' : '-$') + Math.abs(n).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
    const fmtNeg = (n) => n === 0 ? '$0.00' : (n > 0 ? '$' : '-$') + Math.abs(n).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});

    let totSellOpen = 0, totBuyClose = 0, totProfit = 0, totAssigned = 0;

    // Build per-month data grouped by year (descending)
    const uniqueYears = [...new Set(months.map(m => m.year))].sort((a,b) => b - a);
    const currentYear = now.getFullYear();
    // Default: only current year expanded
    const defaultExpandedYears = new Set([String(currentYear)]);

    // Compute monthly rows grouped by year
    const monthlyByYear = {};
    months.forEach(({year, month}) => {
        const mStart = new Date(year, month, 1);
        const mEnd = new Date(year, month + 1, 0, 23, 59, 59);
        const monthLabel = mStart.toLocaleDateString('en-US', {month:'short', year:'numeric'});
        let sellOpen = 0, buyClose = 0;
        window.allTransactions.forEach(t => {
            if (t.date >= mStart && t.date <= mEnd) {
                if (t.action.includes('sell') && t.action.includes('to open')) sellOpen += t.amount;
                if (t.action.includes('buy') && t.action.includes('to close')) buyClose += t.amount;
            }
        });
        let profit = 0, assignedPaid = 0;
        finalTrades.forEach(t => {
            if (t.closeDate >= mStart && t.closeDate <= mEnd) {
                const st = t.status.toLowerCase();
                if (!st.includes('assigned') || st.includes('called')) profit += t.profit;
                if (st.includes('assigned') && !st.includes('called')) assignedPaid += Math.abs(t.openingPremium);
            }
        });
        const cashFlow = sellOpen + buyClose;
        totSellOpen += sellOpen;
        totBuyClose += buyClose;
        totProfit += profit;
        totAssigned += assignedPaid;
        if (!monthlyByYear[year]) monthlyByYear[year] = [];
        monthlyByYear[year].push({ month, monthLabel, sellOpen, buyClose, cashFlow, profit, assignedPaid });
    });

    // Sort each year's months descending (most recent first)
    uniqueYears.forEach(y => { monthlyByYear[y].sort((a,b) => b.month - a.month); });

    // Build HTML rows for the monthly breakdown table grouped by year
    const buildMonthlyRows = () => {
        let html = '';
        uniqueYears.forEach(year => {
            const yMonths = monthlyByYear[year];
            const isExpanded = defaultExpandedYears.has(String(year));
            // Most recent month row gets the toggle button
            yMonths.forEach((md, idx) => {
                const isFirst = idx === 0;
                const topBorder = `border-top:2px solid #6d28d9;`;
                const botBorder = `border-bottom:1px solid ${borderColor};`;
                const toggleBtn = isFirst
                    ? `<button onclick="toggleMonthlyYear(${year})" id="mbtn-${year}" style="background:none;border:none;cursor:pointer;color:#a78bfa;font-size:1rem;padding:0;line-height:1;position:absolute;left:8px;top:50%;transform:translateY(-50%);" title="Collapse/expand ${year}">${isExpanded ? '‚ûñ' : '‚ûï'}</button>`
                    : '';
                html += `<tr class="mb-month-row mb-year-${year}" style="background:${rowBg};display:${isExpanded ? 'table-row' : 'none'};">
                    <td style="color:${textColor};text-align:center;padding:10px 14px;${isFirst ? topBorder : ''}${botBorder}font-weight:500;position:relative;">${toggleBtn}${md.monthLabel}</td>
                    <td style="padding:10px 14px;${isFirst ? topBorder : ''}${botBorder}color:#16a34a;">${fmt(md.sellOpen)}</td>
                    <td style="padding:10px 14px;${isFirst ? topBorder : ''}${botBorder}color:${md.buyClose < 0 ? '#dc2626' : textColor};">${fmtNeg(md.buyClose)}</td>
                    <td style="padding:10px 14px;${isFirst ? topBorder : ''}${botBorder}color:${md.cashFlow >= 0 ? '#16a34a' : '#dc2626'};">${fmt(md.cashFlow)}</td>
                    <td style="padding:10px 14px;${isFirst ? topBorder : ''}${botBorder}color:${md.profit >= 0 ? '#16a34a' : '#dc2626'};">${fmt(md.profit)}</td>
                    <td style="padding:10px 14px;${isFirst ? topBorder : ''}${botBorder}color:#d97706;">${md.assignedPaid > 0 ? fmt(md.assignedPaid) : '$0.00'}</td>
                </tr>`;
            });
            // Collapsed year summary row (shown only when collapsed)
            const yData = yMonths.reduce((acc, md) => {
                acc.sellOpen += md.sellOpen; acc.buyClose += md.buyClose;
                acc.profit += md.profit; acc.assignedPaid += md.assignedPaid; return acc;
            }, {sellOpen:0, buyClose:0, profit:0, assignedPaid:0});
            const yCashFlow = yData.sellOpen + yData.buyClose;
            html += `<tr class="mb-year-collapsed-${year}" style="background:${rowBg};display:${isExpanded ? 'none' : 'table-row'};">
                <td style="color:${textColor};text-align:center;padding:10px 14px;border-top:2px solid #6d28d9;border-bottom:1px solid ${borderColor};font-weight:600;position:relative;">
                    <button onclick="toggleMonthlyYear(${year})" id="mbtn-${year}" style="background:none;border:none;cursor:pointer;color:#a78bfa;font-size:1rem;padding:0;line-height:1;position:absolute;left:8px;top:50%;transform:translateY(-50%);" title="Expand ${year}">‚ûï</button>${year}
                </td>
                <td style="padding:10px 14px;border-top:2px solid #6d28d9;border-bottom:1px solid ${borderColor};color:#16a34a;">${fmt(yData.sellOpen)}</td>
                <td style="padding:10px 14px;border-top:2px solid #6d28d9;border-bottom:1px solid ${borderColor};color:${yData.buyClose < 0 ? '#dc2626' : textColor};">${fmtNeg(yData.buyClose)}</td>
                <td style="padding:10px 14px;border-top:2px solid #6d28d9;border-bottom:1px solid ${borderColor};color:${yCashFlow >= 0 ? '#16a34a' : '#dc2626'};">${fmt(yCashFlow)}</td>
                <td style="padding:10px 14px;border-top:2px solid #6d28d9;border-bottom:1px solid ${borderColor};color:${yData.profit >= 0 ? '#16a34a' : '#dc2626'};">${fmt(yData.profit)}</td>
                <td style="padding:10px 14px;border-top:2px solid #6d28d9;border-bottom:1px solid ${borderColor};color:#d97706;">${yData.assignedPaid > 0 ? fmt(yData.assignedPaid) : '$0.00'}</td>
            </tr>`;
        });
        return html;
    };

    const totCashFlow = totSellOpen + totBuyClose;
    const totalRow = `<tr style="background:${totalRowBg};font-weight:bold;">
        <td style="text-align:center;padding:12px 14px;color:#a78bfa;">Total</td>
        <td style="padding:12px 14px;color:#16a34a;">${fmt(totSellOpen)}</td>
        <td style="padding:12px 14px;color:${totBuyClose < 0 ? '#dc2626' : textColor};">${fmtNeg(totBuyClose)}</td>
        <td style="padding:12px 14px;color:${totCashFlow >= 0 ? '#16a34a' : '#dc2626'};">${fmt(totCashFlow)}</td>
        <td style="padding:12px 14px;color:${totProfit >= 0 ? '#16a34a' : '#dc2626'};">${fmt(totProfit)}</td>
        <td style="padding:12px 14px;color:#d97706;">${totAssigned > 0 ? fmt(totAssigned) : '$0.00'}</td>
    </tr>`;


    const thStyle = `padding:10px 8px;background:${thBg};color:#a78bfa;font-size:0.75rem;letter-spacing:0.04em;border-bottom:2px solid #6d28d9;white-space:normal;word-break:break-word;text-align:center;vertical-align:middle;`;
    const tblStyle = `width:100%;border-collapse:collapse;background:${rowBg};font-size:0.9rem;table-layout:fixed;`;

    document.getElementById('monthlyTableContainer').innerHTML = `
        <h3 style="color:#a78bfa;margin:0 0 14px;font-size:1rem;">Monthly Breakdown</h3>
        <div style="overflow-x:auto; border:1px solid ${borderColor}; border-radius:8px;">
        <table id="monthlyBreakdownTable" style="${tblStyle}">
            <colgroup><col style="width:14%"><col style="width:17.2%"><col style="width:17.2%"><col style="width:17.2%"><col style="width:17.2%"><col style="width:17.2%"></colgroup>
            <thead><tr>
                <th style="${thStyle}">Month / Year</th>
                <th style="${thStyle}">Sell to Open</th>
                <th style="${thStyle}">Buy to Close</th>
                <th style="${thStyle}">Cash Flow</th>
                <th style="${thStyle}">Profit from Closed Options</th>
                <th style="${thStyle}">Paid Premium Assigned</th>
            </tr></thead>
            <tbody id="monthlyBreakdownBody">${buildMonthlyRows()}${totalRow}</tbody>
        </table>
        </div>`;

    const modal = document.getElementById('monthlyModal');
    modal.style.display = 'flex';
    modal.onclick = (e) => { if (e.target === modal) closeMonthlySummary(); };
    initDraggableModal('monthlyInner', '#6d28d9', 1600);

    // Make window 25% taller than default
    setTimeout(() => {
        const mi = document.getElementById('monthlyInner');
        if (mi && mi.style.height) {
            const currentH = parseFloat(mi.style.height);
            mi.style.height = Math.min(currentH * 1.25, window.innerHeight - 20) + 'px';
        }
    }, 50);

    // Floating sticky header for Monthly Breakdown
    setTimeout(() => {
        const modalInner = document.getElementById('monthlyInner');
        const monthTable = document.getElementById('monthlyBreakdownTable');
        const monthThead = monthTable ? monthTable.querySelector('thead') : null;
        if (!modalInner || !monthTable || !monthThead) return;

        // Remove old floating headers if re-opened
        ['yearFloatingHeader','monthFloatingHeader'].forEach(id => { const el = document.getElementById(id); if (el) el.remove(); });

        const makeFloatHeader = (id, srcThead) => {
            const div = document.createElement('div');
            div.id = id;
            div.style.cssText = `position:absolute;left:0;top:0;pointer-events:none;z-index:50;display:none;box-sizing:border-box;`;
            const tbl = document.createElement('table');
            tbl.style.cssText = `width:100%;border-collapse:collapse;table-layout:fixed;font-size:0.9rem;`;
            tbl.innerHTML = `<colgroup><col style="width:14%"><col style="width:17.2%"><col style="width:17.2%"><col style="width:17.2%"><col style="width:17.2%"><col style="width:17.2%"></colgroup>` + srcThead.outerHTML;
            div.appendChild(tbl);
            modalInner.appendChild(div);
            return div;
        };

        const monthFloatDiv = makeFloatHeader('monthFloatingHeader', monthThead);

        const onScroll = () => {
            const innerRect  = modalInner.getBoundingClientRect();
            const mTheadRect = monthThead.getBoundingClientRect();
            const mTableRect = monthTable.getBoundingClientRect();
            const mTheadH    = monthThead.offsetHeight;
            if (mTheadRect.top < innerRect.top && mTableRect.bottom > innerRect.top + mTheadH) {
                monthFloatDiv.style.display = 'block';
                monthFloatDiv.style.top   = modalInner.scrollTop + 'px';
                monthFloatDiv.style.width = monthTable.offsetWidth + 'px';
                monthFloatDiv.style.left  = monthTable.offsetLeft + 'px';
            } else {
                monthFloatDiv.style.display = 'none';
            }
        };

        if (modalInner._monthlyScrollHandler) {
            modalInner.removeEventListener('scroll', modalInner._monthlyScrollHandler);
        }
        modalInner._monthlyScrollHandler = onScroll;
        modalInner.addEventListener('scroll', onScroll);
    }, 100);
}

// ============================================================
// TRANSACTION DATA SORTER
// ============================================================
let tsData = [];
let tsFiltered = [];
let tsSortKey = 'parsedDate';
let tsSortDir = -1;

const tsState = { checkedActions:[], datePreset:'all', dateFrom:'', dateTo:'', symbolSearch:'' };
function tsSaveState() {
    tsState.checkedActions = Array.from(document.querySelectorAll('#tsActionCheckboxes input:checked')).map(cb => cb.value);
    tsState.datePreset = document.getElementById('tsDatePreset').value;
    tsState.dateFrom = document.getElementById('tsDateFrom').value;
    tsState.dateTo = document.getElementById('tsDateTo').value;
    tsState.symbolSearch = document.getElementById('tsSymbolSearch').value;
}
function tsRestoreState() {
    document.getElementById('tsDatePreset').value = tsState.datePreset || 'all';
    document.getElementById('tsDateFrom').value = tsState.dateFrom || '';
    document.getElementById('tsDateTo').value = tsState.dateTo || '';
    document.getElementById('tsSymbolSearch').value = tsState.symbolSearch || '';
    if (tsState.checkedActions.length > 0) {
        document.querySelectorAll('#tsActionCheckboxes input').forEach(cb => { cb.checked = tsState.checkedActions.includes(cb.value); });
    }
}
function showTransactionSorter() {
    if (!window.allRawRows || window.allRawRows.length === 0) {
        alert('Please upload a file first.');
        return;
    }
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    const inner = document.getElementById('txSorterInner');
    inner.style.background = isDark ? '#1e293b' : '#ffffff';
    inner.style.border = '1px solid #10b981';

    tsData = window.allRawRows.map(r => ({ ...r }));
    tsFiltered = [...tsData];
    tsSortKey = 'parsedDate';
    tsSortDir = -1;

    tsPopulateActionCheckboxes();
    tsRestoreState();
    tsApplyDatePreset();
    tsApplyFilters();

    const modal = document.getElementById('txSorterModal');
    modal.style.display = 'flex';
    modal.onclick = (e) => { if (e.target === modal) closeTxSorter(); };
    initDraggableModal('txSorterInner', '#10b981', 1400);
}

function closeTxSorter() {
    const _di = document.getElementById('txSorterInner'); if (_di) _di._dragInit = false;
    tsSaveState();
    document.getElementById('txSorterModal').style.display = 'none';
}

function tsPopulateActionCheckboxes() {
    const container = document.getElementById('tsActionCheckboxes');
    const uniqueActions = [...new Set(tsData.map(r => r.Action || '').filter(Boolean))].sort();
    container.innerHTML = uniqueActions.map(a => `
        <label style="display:flex;align-items:center;gap:5px;cursor:pointer;font-size:0.85rem;color:var(--text-primary);">
            <input type="checkbox" value="${a}" onchange="tsApplyFilters()" style="width:14px;height:14px;cursor:pointer;accent-color:#10b981;">
            ${a}
        </label>`).join('');
}

function tsApplyDatePreset() {
    const preset = document.getElementById('tsDatePreset').value;
    if (preset === 'all') {
        document.getElementById('tsDateFrom').value = '';
        document.getElementById('tsDateTo').value = '';
    } else {
        const today = new Date();
        today.setHours(0,0,0,0);
        let from, to;
        switch(preset) {
            case 'today':        from = new Date(today); to = new Date(today); break;
            case 'last7':        from = new Date(today); from.setDate(today.getDate()-6); to = new Date(today); break;
            case 'currentMonth': from = new Date(today.getFullYear(), today.getMonth(), 1); to = new Date(today); break;
            case 'lastMonth':    from = new Date(today.getFullYear(), today.getMonth()-1, 1); to = new Date(today.getFullYear(), today.getMonth(), 0); break;
            case 'last3Months':  from = new Date(today); from.setMonth(today.getMonth()-3); to = new Date(today); break;
            case 'last6Months':  from = new Date(today); from.setMonth(today.getMonth()-6); to = new Date(today); break;
            case 'last12Months': from = new Date(today); from.setMonth(today.getMonth()-12); to = new Date(today); break;
            case 'lastYear':     from = new Date(today.getFullYear()-1,0,1); to = new Date(today.getFullYear()-1,11,31); break;
            case 'currentYear':  from = new Date(today.getFullYear(),0,1); to = new Date(today); break;
        }
        const fmtD = d => { const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),dd=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${dd}`; };
        document.getElementById('tsDateFrom').value = fmtD(from);
        document.getElementById('tsDateTo').value = fmtD(to);
    }
    tsApplyFilters();
}

function tsApplyFilters() {
    const checkedActions = Array.from(document.querySelectorAll('#tsActionCheckboxes input:checked')).map(cb => cb.value);
    const totalActions = document.querySelectorAll('#tsActionCheckboxes input').length;
    const fromVal = document.getElementById('tsDateFrom').value;
    const toVal = document.getElementById('tsDateTo').value;
    const fromDate = fromVal ? new Date(fromVal + 'T00:00:00') : null;
    const toDate = toVal ? new Date(toVal + 'T23:59:59') : null;
    const search = (document.getElementById('tsSymbolSearch').value || '').toLowerCase().trim();
    tsFiltered = tsData.filter(r => {
        // If some (but not all) actions are unchecked, filter by checked ones; rows with no Action always pass
        if (checkedActions.length > 0 && checkedActions.length < totalActions) {
            if (r.Action && !checkedActions.includes(r.Action)) return false;
        }
        const dateForFilter = r.parsedDate;
        if (dateForFilter) {
            if (fromDate && dateForFilter < fromDate) return false;
            if (toDate && dateForFilter > toDate) return false;
        }
        if (search) {
            const sym = (r.Symbol || '').toLowerCase();
            const act = (r.Action || '').toLowerCase();
            const desc = (r.Description || '').toLowerCase();
            const date = (r.parsedDate ? fmtDateMMDDYYYY(r.parsedDate) : (r.rawDateFormatted || '')).toLowerCase();
            const qty = String(r.Quantity || '').toLowerCase();
            const price = String(r.Price || '').toLowerCase();
            const fees = String(r['Fees & Comm'] || r['Fees'] || '').toLowerCase();
            const amt = String(r.Amount || '').toLowerCase();
            if (!sym.includes(search) && !act.includes(search) && !desc.includes(search) &&
                !date.includes(search) && !qty.includes(search) && !price.includes(search) &&
                !fees.includes(search) && !amt.includes(search)) return false;
        }
        return true;
    });

    tsRenderSummary();
    tsRenderTable();
}

function tsReset() {
    document.querySelectorAll('#tsActionCheckboxes input').forEach(cb => cb.checked = false);
    document.getElementById('tsDatePreset').value = 'all';
    document.getElementById('tsDateFrom').value = '';
    document.getElementById('tsDateTo').value = '';
    document.getElementById('tsSymbolSearch').value = '';
    Object.assign(tsState,{checkedActions:[],datePreset:'all',dateFrom:'',dateTo:'',symbolSearch:''});
    tsFiltered = [...tsData];
    tsSortKey = 'parsedDate';
    tsSortDir = -1;
    tsRenderSummary();
    tsRenderTable();
}

function tsRenderSummary() {
    const totalRows = tsFiltered.length;
    const totalAmount = tsFiltered.reduce((s, r) => s + cleanNum(r.Amount), 0);
    const totalFees = tsFiltered.reduce((s, r) => s + cleanNum(r['Fees & Comm'] || r['Fees'] || 0), 0);
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    const cardBg = isDark ? '#0f172a' : '#f8fafc';
    const fmtAmt = n => (n < 0 ? '-$' : '$') + Math.abs(n).toLocaleString(undefined, {minimumFractionDigits:2,maximumFractionDigits:2});

    // Compute available date range from full dataset
    const dates = tsData.map(r => r.parsedDate).filter(Boolean);
    if (dates.length > 0) {
        const minDate = new Date(Math.min(...dates.map(d => d.getTime())));
        const maxDate = new Date(Math.max(...dates.map(d => d.getTime())));
        const fmt = d => {
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            const y = d.getFullYear();
            return `${m}/${day}/${y}`;
        };
        const rangeLabel = 'Available Date Range';
        document.getElementById('tsDateRangeBar').innerHTML =
            `<span style="display:inline-flex;align-items:center;gap:6px;">${rangeLabel}: <span style="color:var(--text-primary);font-weight:600;">${fmt(minDate)}</span><span style="font-size:2em;line-height:1;position:relative;top:-0.05em;">‚Üí</span><span style="color:var(--text-primary);font-weight:600;">${fmt(maxDate)}</span></span>`;
    } else {
        document.getElementById('tsDateRangeBar').innerHTML = '';
    }

    const checkedActions = Array.from(document.querySelectorAll('#tsActionCheckboxes input:checked')).map(cb => cb.value);
    const totalActions = document.querySelectorAll('#tsActionCheckboxes input').length;
    const showingAll = checkedActions.length === 0 || checkedActions.length === totalActions;
    const actionsToShow = showingAll ? [...new Set(tsFiltered.map(r => r.Action).filter(Boolean))] : checkedActions;
    let actionBoxes = '';
    actionsToShow.forEach(action => {
        const rows = tsFiltered.filter(r => r.Action === action);
        const hasAmount = rows.some(r => r.Amount != null && r.Amount !== '');
        if (!hasAmount) return;
        const amt = rows.reduce((s, r) => s + cleanNum(r.Amount), 0);
        const color = amt >= 0 ? '#10b981' : '#ef4444';
        const label = action.length > 22 ? action.slice(0, 20) + '‚Ä¶' : action;
        actionBoxes += `<div style="background:${cardBg};border-radius:10px;padding:12px;text-align:center;border:1px solid var(--border-color);min-width:120px;"><div style="font-size:0.65rem;color:var(--text-secondary);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" title="${action}">${label}</div><div style="font-size:1.3rem;font-weight:bold;color:${color};">${fmtAmt(amt)}</div></div>`;
    });
    document.getElementById('tsSummaryGrid').innerHTML = `
        ${actionBoxes}
        <div style="background:${cardBg};border-radius:10px;padding:12px;text-align:center;border:1px solid var(--border-color);min-width:120px;">
            <div style="font-size:0.7rem;color:var(--text-secondary);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:4px;">Total Amount</div>
            <div style="font-size:1.3rem;font-weight:bold;color:${totalAmount >= 0 ? '#10b981' : '#ef4444'};">${fmtAmt(totalAmount)}</div>
        </div>
        <div style="background:${cardBg};border-radius:10px;padding:12px;text-align:center;border:1px solid var(--border-color);min-width:120px;">
            <div style="font-size:0.7rem;color:var(--text-secondary);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:4px;">Total Fees & Comm</div>
            <div style="font-size:1.3rem;font-weight:bold;color:#f59e0b;">${fmtAmt(totalFees)}</div>
        </div>
        <div style="background:${cardBg};border-radius:10px;padding:12px;text-align:center;border:1px solid var(--border-color);min-width:120px;">
            <div style="font-size:0.7rem;color:var(--text-secondary);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:4px;">Total Rows</div>
            <div style="font-size:1.3rem;font-weight:bold;color:#10b981;">${totalRows.toLocaleString()}</div>
        </div>`;
}

function tsSortBy(key) {
    if (tsSortKey === key) tsSortDir *= -1;
    else { tsSortKey = key; tsSortDir = 1; }
    tsRenderTable();
}

function tsRenderTable() {
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    const thBg = isDark ? '#0f172a' : '#f1f5f9';
    const borderColor = isDark ? '#334155' : '#cbd5e1';
    const rowBg = isDark ? '#1e293b' : '#ffffff';
    const rowAltBg = isDark ? '#162032' : '#f8fafc';
    const textColor = isDark ? '#f8fafc' : '#0f172a';
    const posColor = isDark ? '#4ade80' : '#16a34a';
    const negColor = isDark ? '#f87171' : '#dc2626';

    const cols = [
        { lab: 'Date', key: 'parsedDate' },
        { lab: 'Action',      key: 'Action' },
        { lab: 'Symbol',      key: 'Symbol' },
        { lab: 'Description', key: 'Description' },
        { lab: 'Quantity',    key: 'Quantity' },
        { lab: 'Price',       key: 'Price' },
        { lab: 'Fees & Comm', key: 'Fees & Comm' },
        { lab: 'Amount',      key: 'Amount' },
    ];

    const arrow = key => tsSortKey === key ? (tsSortDir === 1 ? ' ‚ñ≤' : ' ‚ñº') : ' ‚Üï';
    const thStyle = `background:${thBg};color:#10b981;padding:10px 8px;text-align:center;font-size:0.78rem;border-bottom:2px solid #10b981;white-space:nowrap;cursor:pointer;user-select:none;position:sticky;top:0;z-index:10;`;

    document.getElementById('tsSorterHead').innerHTML = cols.map(c =>
        `<th onclick="tsSortBy('${c.key}')" style="${thStyle}">${c.lab}${arrow(c.key)}</th>`
    ).join('');

    const sorted = [...tsFiltered].sort((a, b) => {
        let v1, v2;
        if (tsSortKey === 'parsedDate') {
            v1 = a.parsedDate ? a.parsedDate.getTime() : 0;
            v2 = b.parsedDate ? b.parsedDate.getTime() : 0;
        } else if (['Amount','Price','Quantity','Fees & Comm'].includes(tsSortKey)) {
            v1 = parseFloat(a[tsSortKey]) || 0;
            v2 = parseFloat(b[tsSortKey]) || 0;
        } else {
            v1 = (a[tsSortKey] || '').toString().toLowerCase();
            v2 = (b[tsSortKey] || '').toString().toLowerCase();
        }
        if (v1 < v2) return -tsSortDir;
        if (v1 > v2) return tsSortDir;
        return 0;
    });

    const fmtAmt = n => (n >= 0 ? '$' : '-$') + Math.abs(n).toLocaleString(undefined, {minimumFractionDigits:2,maximumFractionDigits:2});
    const tdBase = `padding:8px;border-bottom:1px solid ${borderColor};font-size:0.8rem;text-align:center;`;

    document.getElementById('tsSorterBody').innerHTML = sorted.map((r, i) => {
        const bg = i % 2 === 0 ? rowBg : rowAltBg;
        const amt = cleanNum(r.Amount);
        const amtColor = amt >= 0 ? posColor : negColor;
        const price = parseFloat(r.Price);
        const fees = cleanNum(r['Fees & Comm'] || r['Fees'] || 0);
        return `<tr style="background:${bg};">
            <td style="${tdBase}color:${textColor};white-space:nowrap;">${r.parsedDate ? fmtDateMMDDYYYY(r.parsedDate) : (r.rawDateFormatted || '')}</td>
            <td style="${tdBase}color:${textColor};"><span class="tag">${r.Action || ''}</span></td>
            <td style="${tdBase}color:${textColor};font-weight:600;">${r.Symbol || ''}</td>
            <td style="${tdBase}color:${textColor};max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${r.Description || ''}</td>
            <td style="${tdBase}color:${textColor};">${r.Quantity || ''}</td>
            <td style="${tdBase}color:${textColor};">${!isNaN(price) && r.Price !== '' && r.Price != null ? '$'+price.toFixed(2) : ''}</td>
            <td style="${tdBase}color:${fees !== 0 ? negColor : textColor};">${fees !== 0 ? fmtAmt(fees) : ''}</td>
            <td style="${tdBase}color:${amtColor};font-weight:600;">${r.Amount != null && r.Amount !== '' ? fmtAmt(amt) : ''}</td>
        </tr>`;
    }).join('');
}

function tsDownload() {
    if (!tsFiltered.length) { alert('No data to download.'); return; }
    const exportRows = tsFiltered.map(r => ({
        Date: r.parsedDate ? fmtDateMMDDYYYY(r.parsedDate) : (r.rawDateFormatted || ''),
        Action: r.Action || '',
        Symbol: r.Symbol || '',
        Description: r.Description || '',
        Quantity: r.Quantity || '',
        Price: r.Price || '',
        'Fees & Comm': r['Fees & Comm'] || '',
        Amount: r.Amount || '',
    }));
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(exportRows);
    XLSX.utils.book_append_sheet(wb, ws, 'Filtered Results');
    XLSX.writeFile(wb, `transaction_sorter_${new Date().toISOString().slice(0,10)}.xlsx`);
}

// ============================================================
// DRAG + RESIZE UTILITY FOR MODAL WINDOWS
// ============================================================
function initDraggableModal(innerId, accentColor, maxWidthPx) {
    const inner = document.getElementById(innerId);
    if (!inner) return;

    // Avoid re-initialising if already done
    if (inner._dragInit) return;
    inner._dragInit = true;

    // ‚îÄ‚îÄ Position inner div as fixed, centered in viewport ‚îÄ‚îÄ
    // Read natural dimensions BEFORE changing position (avoids max-width being cleared first)
    const vw = window.innerWidth, vh = window.innerHeight;
    const rawW = inner.getBoundingClientRect().width || inner.offsetWidth;
    const rawH = inner.getBoundingClientRect().height || inner.offsetHeight;

    inner.style.position  = 'fixed';
    inner.style.margin    = '0';
    inner.style.maxWidth  = 'none';
    inner.style.maxHeight = 'none';

    const w = Math.min(rawW || maxWidthPx || Math.round(vw * 0.70), vw - 20);
    const h = Math.min(rawH || Math.round(vh * 0.90), vh - 20);
    inner.style.width    = w + 'px';
    inner.style.height   = h + 'px';
    inner.style.left     = Math.round((vw - w) / 2) + 'px';
    inner.style.top      = Math.round((vh - h) / 2) + 'px';
    inner.style.overflow = 'auto';
    inner.style.boxSizing = 'border-box';

    // ‚îÄ‚îÄ Drag handle: the first child div (header row) ‚îÄ‚îÄ
    const header = inner.querySelector('div');
    if (header) {
        header.style.cursor     = 'move';
        header.style.userSelect = 'none';
    }

    let dragging = false, dx0, dy0, l0, t0;

    const onHeaderDown = (e) => {
        if (e.button !== 0) return;
        const tgt = e.target;
        if (tgt.tagName === 'BUTTON' || tgt.tagName === 'INPUT' ||
            tgt.tagName === 'SELECT' || tgt.closest('button') ||
            tgt.closest('select')) return;
        dragging = true;
        dx0 = e.clientX; dy0 = e.clientY;
        l0  = parseInt(inner.style.left) || 0;
        t0  = parseInt(inner.style.top)  || 0;
        e.preventDefault();
    };
    if (header) header.addEventListener('mousedown', onHeaderDown);

    const onMouseMove = (e) => {
        if (!dragging) return;
        inner.style.left = (l0 + e.clientX - dx0) + 'px';
        inner.style.top  = (t0 + e.clientY - dy0) + 'px';
    };
    const onMouseUp = () => { dragging = false; };
    document.addEventListener('mousemove', onMouseMove);
    document.addEventListener('mouseup',   onMouseUp);

    // ‚îÄ‚îÄ Resize handles at all 4 corners ‚îÄ‚îÄ
    const corners = [
        { id: 'nw', cursor: 'nw-resize', top: 0,    left: 0,    right: null, bottom: null },
        { id: 'ne', cursor: 'ne-resize', top: 0,    left: null,  right: 0,   bottom: null },
        { id: 'sw', cursor: 'sw-resize', top: null,  left: 0,    right: null, bottom: 0   },
        { id: 'se', cursor: 'se-resize', top: null,  left: null,  right: 0,   bottom: 0   },
    ];

    corners.forEach(({ id, cursor, top, left, right, bottom }) => {
        const h = document.createElement('div');
        Object.assign(h.style, {
            position:  'absolute',
            width:     '18px',
            height:    '18px',
            cursor,
            zIndex:    '9999',
            boxSizing: 'border-box',
        });
        if (top    !== null) h.style.top    = top    + 'px';
        if (bottom !== null) h.style.bottom = bottom + 'px';
        if (left   !== null) h.style.left   = left   + 'px';
        if (right  !== null) h.style.right  = right  + 'px';

        // Visual grip dots
        const isS = id.includes('s'), isE = id.includes('e');
        h.innerHTML = `<svg width="10" height="10" style="position:absolute;${isS?'bottom':'top'}:3px;${isE?'right':'left'}:3px;opacity:0.5;" viewBox="0 0 10 10"><circle cx="2" cy="2" r="1.5" fill="${accentColor||'#6d28d9'}"/><circle cx="6" cy="2" r="1.5" fill="${accentColor||'#6d28d9'}"/><circle cx="2" cy="6" r="1.5" fill="${accentColor||'#6d28d9'}"/><circle cx="6" cy="6" r="1.5" fill="${accentColor||'#6d28d9'}"/></svg>`;

        h.addEventListener('mousedown', (e) => {
            e.stopPropagation(); e.preventDefault();
            const sx = e.clientX, sy = e.clientY;
            const sw = inner.offsetWidth,  sh = inner.offsetHeight;
            const sl = parseInt(inner.style.left) || 0;
            const st = parseInt(inner.style.top)  || 0;
            const minW = 360, minH = 220;

            const onMove = (e) => {
                const ddx = e.clientX - sx, ddy = e.clientY - sy;
                // LEFT edge: drag right shrinks from left, moves left position
                if (left   !== null) { const nw = Math.max(minW, sw - ddx); inner.style.width  = nw + 'px'; inner.style.left = (sl + sw - nw) + 'px'; }
                // RIGHT edge: drag right grows from right, left position stays
                if (right  !== null) { inner.style.width  = Math.max(minW, sw + ddx) + 'px'; }
                // TOP edge: drag down shrinks from top, moves top position
                if (top    !== null) { const nh = Math.max(minH, sh - ddy); inner.style.height = nh + 'px'; inner.style.top  = (st + sh - nh) + 'px'; }
                // BOTTOM edge: drag down grows from bottom, top position stays
                if (bottom !== null) { inner.style.height = Math.max(minH, sh + ddy) + 'px'; }
            };
            const onUp = () => { document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onUp); };
            document.addEventListener('mousemove', onMove);
            document.addEventListener('mouseup', onUp);
        });
        inner.appendChild(h);
    });

    // Store cleanup fn so it can be called on close
    inner._dragCleanup = () => {
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup',   onMouseUp);
        inner._dragInit = false;
        // Remove corner handles
        inner.querySelectorAll('div[style*="cursor: nw-resize"], div[style*="cursor: ne-resize"], div[style*="cursor: sw-resize"], div[style*="cursor: se-resize"]').forEach(el => el.remove());
    };
}
</script>
</body>
</html>